<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            top: 0;
        }
        
        [dir="rtl"] .sidebar {
            right: 0;
        }
        
        [dir="ltr"] .sidebar {
            left: 0;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }

        .sidebar-header h2 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .user-info {
            font-size: 0.9em;
            opacity: 0.8;
            word-break: break-word;
        }

        .menu-item {
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s;
        }

        [dir="rtl"] .menu-item {
            border-right: 3px solid transparent;
        }

        [dir="ltr"] .menu-item {
            border-left: 3px solid transparent;
        }

        [dir="rtl"] .menu-item:hover {
            background: rgba(255,255,255,0.1);
            border-right-color: #3498db;
        }

        [dir="ltr"] .menu-item:hover {
            background: rgba(255,255,255,0.1);
            border-left-color: #3498db;
        }

        [dir="rtl"] .menu-item.active {
            background: rgba(255,255,255,0.15);
            border-right-color: #3498db;
            font-weight: bold;
        }

        [dir="ltr"] .menu-item.active {
            background: rgba(255,255,255,0.15);
            border-left-color: #3498db;
            font-weight: bold;
        }

        [dir="rtl"] .menu-item i {
            margin-left: 10px;
            width: 20px;
        }

        [dir="ltr"] .menu-item i {
            margin-right: 10px;
            width: 20px;
        }

        .main-content {
            flex: 1;
            padding: 30px;
            padding-bottom: 80px; /* Space for footer */
        }
        
        .footer {
            position: fixed;
            bottom: 0;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            color: white;
            text-align: center;
            padding: 15px 20px;
            font-size: 14px;
            z-index: 999;
            border-top: 1px solid rgba(255,255,255,0.1);
            width: calc(100% - 280px);
        }
        
        [dir="rtl"] .footer {
            right: 280px;
            left: 0;
        }
        
        [dir="ltr"] .footer {
            left: 280px;
            right: 0;
        }
        
        .footer-content {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .footer a {
            color: #3498db;
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .footer a:hover {
            color: #5dade2;
        }

        [dir="rtl"] .main-content {
            margin-right: 280px;
        }

        [dir="ltr"] .main-content {
            margin-left: 280px;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2em;
        }

        .section {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section.active {
            display: block;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 15px;
            border-bottom: 1px solid #ddd;
        }

        [dir="rtl"] th, [dir="rtl"] td {
            text-align: right;
        }

        [dir="ltr"] th, [dir="ltr"] td {
            text-align: left;
        }

        th {
            background: #34495e;
            color: white;
            font-weight: bold;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content.large {
            max-width: 1400px;
            width: 98%;
            min-height: 600px;
            max-height: 95vh;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            border-bottom: 2px solid #e0e0e0;
            margin: -30px -30px 25px -30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px 10px 0 0;
        }

        .modal-header h2 {
            margin: 0;
            color: white;
            font-size: 1.5em;
        }

        .modal-header.receive-header {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }

        .modal-header.deliver-header {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        .modal-header.return-header {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .modal-header .close {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            font-size: 28px;
            cursor: pointer;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .modal-header .close:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            border: 1px solid #e0e0e0;
        }

        .form-section-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
            display: flex;
            align-items: center;
        }

        .form-section-title.receive-title {
            border-bottom-color: #27ae60;
        }

        .form-section-title.deliver-title {
            border-bottom-color: #3498db;
        }

        .form-section-title.return-title {
            border-bottom-color: #f39c12;
        }

        .form-section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: #3498db;
            margin-left: 10px;
            border-radius: 2px;
        }

        .form-section-title.receive-title::before {
            background: #27ae60;
        }

        .form-section-title.deliver-title::before {
            background: #3498db;
        }

        .form-section-title.return-title::before {
            background: #f39c12;
        }

        .items-list {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-start;
            gap: 10px;
            padding-top: 20px;
            margin-top: 25px;
            border-top: 2px solid #e0e0e0;
        }

        .items-list:empty {
            padding: 40px;
            text-align: center;
            color: #95a5a6;
            font-style: italic;
        }

        .items-list:empty::before {
            content: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ Ù…Ø¶Ø§ÙØ© Ø¨Ø¹Ø¯';
        }

        .searchable-select {
            position: relative;
        }

        .searchable-select input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 5px;
            color: #333;
            background-color: white;
        }
        
        .searchable-select input::placeholder {
            color: #999;
        }

        .searchable-select .options-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            color: #333;
        }

        .searchable-select .options-list.show {
            display: block;
        }

        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø©: ØªØ¸Ù‡Ø± ÙÙˆÙ‚ ÙƒÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¯ÙˆÙ† ØªÙ‚ÙŠØ¯ Ø¨Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªÙ…Ø±ÙŠØ± */
        .searchable-select .options-list.floating {
            position: fixed;
            z-index: 10000;
        }

        /* Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ø£Ø¹Ù„Ù‰ Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø§Ø­Ø© ÙƒØ§ÙÙŠØ© Ø£Ø³ÙÙ„ */
        .searchable-select .options-list.above {
            top: auto;
            bottom: 100%;
            margin-top: 0;
            margin-bottom: 4px;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.2);
        }

        .searchable-select .option-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
            color: #333;
            background-color: white;
        }

        .searchable-select .option-item:hover {
            background-color: #f8f9fa;
            color: #333;
        }

        .searchable-select .option-item.selected {
            background-color: #3498db;
            color: white;
        }

        .searchable-select .selected-value {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .searchable-select .selected-value::after {
            content: 'â–¼';
            font-size: 12px;
            color: #666;
        }

        .searchable-select .selected-value.empty {
            color: #999;
        }

        .items-list {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 10px 0;
        }

        .item-row {
            background: white;
        }

        .item-row:hover {
            background: #f0f0f0;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
        }

        .close {
            font-size: 30px;
            cursor: pointer;
            color: #aaa;
            border: none;
            background: none;
            font-size: 28px;
        }

        .close:hover {
            color: #000;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .stat-card p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .transaction-item {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-right: 4px solid #3498db;
        }

        .transaction-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .badge {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .badge-success {
            background: #27ae60;
            color: white;
        }

        .badge-warning {
            background: #f39c12;
            color: white;
        }

        .badge-danger {
            background: #e74c3c;
            color: white;
        }

        .badge-info {
            background: #3498db;
            color: white;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 14px;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            max-width: 400px;
            display: inline-block;
        }

        .items-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
        }

        .item-row {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #eee;
            align-items: center;
        }

        .item-row:last-child {
            border-bottom: none;
        }

        .quantity-input {
            width: 100px;
            display: inline-block;
        }

        /* App loading overlay */
        #appLoadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(44, 62, 80, 0.92);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.3s ease;
        }
        #appLoadingOverlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        #appLoadingOverlay .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(255,255,255,0.2);
            border-top-color: #3498db;
            border-radius: 50%;
            animation: appLoadingSpin 0.9s linear infinite;
        }
        @keyframes appLoadingSpin {
            to { transform: rotate(360deg); }
        }
        #appLoadingOverlay .loading-text {
            color: #fff;
            margin-top: 20px;
            font-size: 1.1em;
        }
        #appLoadingOverlay .loading-error {
            color: #e74c3c;
            margin-top: 12px;
            text-align: center;
            max-width: 320px;
        }
        #appLoadingOverlay .loading-actions {
            margin-top: 20px;
            display: flex;
            gap: 12px;
        }
        #appLoadingOverlay .loading-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
        }
        #appLoadingOverlay .loading-actions .btn-retry {
            background: #3498db;
            color: #fff;
        }
        #appLoadingOverlay .loading-actions .btn-reload {
            background: #2ecc71;
            color: #fff;
        }
    </style>
</head>
<body>
    <!-- Login Section -->
    <div id="loginSection" style="display: block;">
        <div class="login-container" autocomplete="off">
            <h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <div class="alert" id="loginAlert"></div>
            <div class="form-group">
                <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</label>
                <input type="email" id="email" placeholder="Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" autocomplete="off">
            </div>
            <div class="form-group">
                <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label>
                <input type="password" id="password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" autocomplete="new-password">
            </div>
            <button class="btn btn-primary" onclick="login()" style="width: 100%;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <!-- Main Application -->
    <div id="appSection" style="display: none;">
        <div id="appLoadingOverlay">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="appLoadingText">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...</div>
            <div class="loading-error" id="appLoadingError" style="display: none;"></div>
            <div class="loading-actions" id="appLoadingActions" style="display: none;">
                <button type="button" class="btn-retry" id="appLoadingRetryBtn">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
                <button type="button" class="btn-reload" id="appLoadingReloadBtn">Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©</button>
            </div>
        </div>
        <div class="container">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <h2>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h2>
                    <div class="user-info">
                        <div id="sidebarUserEmail"></div>
                        <button class="btn btn-secondary btn-small" onclick="logout()" style="margin-top: 10px; width: 100%;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                    </div>
                </div>
                <div class="menu-item active" onclick="showSection('dashboard')">
                    <i>ğŸ“Š</i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                </div>
                <div class="menu-item" onclick="showSection('materials')">
                    <i>ğŸ“¦</i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯
                </div>
                <div class="menu-item" onclick="showSection('warehouses')">
                    <i>ğŸ­</i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª
                </div>
                <div class="menu-item" onclick="showSection('workSites')">
                    <i>ğŸ—ï¸</i> Ø¥Ø¯Ø§Ø±Ø© Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù…Ù„
                </div>
                <div class="menu-item" onclick="showSection('workSiteGroups')">
                    <i>ğŸ“</i> Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù…Ù„
                </div>
                <div class="menu-item" onclick="showSection('suppliers')">
                    <i>ğŸšš</i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø²ÙˆØ¯ÙŠÙ†
                </div>
                <div class="menu-item" onclick="showSection('units')">
                    <i>ğŸ“</i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆØ­Ø¯Ø§Øª
                </div>
                <div class="menu-item" onclick="showSection('receive')">
                    <i>â¬‡ï¸</i> Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…
                </div>
                <div class="menu-item" onclick="showSection('deliver')">
                    <i>â¡ï¸</i> Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…
                </div>
                <div class="menu-item" onclick="showSection('return')">
                    <i>â¬†ï¸</i> Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ù…Ù† Ù…ÙˆÙ‚Ø¹ Ø¹Ù…Ù„
                </div>
                <div class="menu-item" onclick="showSection('inventory')">
                    <i>ğŸ“‹</i> ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
                </div>
                <div class="menu-item" onclick="showSection('inventoryVerification')">
                    <i>ğŸ”§</i> Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØµÙŠØ§Ù†ØªÙ‡
                </div>
                <div class="menu-item" onclick="showSection('reports')">
                    <i>ğŸ“ˆ</i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
                </div>
                <div class="menu-item" onclick="showSection('users')">
                    <i>ğŸ‘¥</i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                </div>
                <div class="menu-item" onclick="showSection('activityLog')">
                    <i>ğŸ“‹</i> Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
                </div>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <div class="header">
                    <h1 id="pageTitle">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
                    <div style="margin-left: 20px;">
                        <button id="langToggle" class="btn btn-secondary" onclick="toggleLanguage()" style="padding: 8px 15px; font-size: 14px;">
                            English
                        </button>
                    </div>
                </div>

                <div class="alert" id="alert"></div>

                <!-- Dashboard Section -->
                <div id="dashboard" class="section active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3 id="statTotalMaterials">0</h3>
                            <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ§Ø¯</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="statTotalWarehouses">0</h3>
                            <p>Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="statTotalWorkSites">0</h3>
                            <p>Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù…Ù„</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="statTotalTransactions">0</h3>
                            <p>Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ…</p>
                        </div>
                    </div>
                    <h2 style="margin: 30px 0 20px;">Ø¢Ø®Ø± Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h2>
                    <div id="recentTransactions"></div>
                </div>

                <!-- Materials Section -->
                <div id="materials" class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯</h2>
                        <button class="btn btn-primary" onclick="showMaterialModal()">Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
                    </div>
                    <div class="search-box">
                        <input type="text" id="searchMaterials" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…Ø§Ø¯Ø©..." onkeyup="filterMaterials()">
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Ø§Ù„ÙƒÙˆØ¯</th>
                                <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                                <th>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ</th>
                                <th>Ø§Ù„ÙØ¦Ø©</th>
                                <th>Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</th>
                                <th>Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ©</th>
                                <th>Ø§Ù„ØªØ¹Ø§Ø¯Ù„</th>
                                <th>Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="materialsTableBody"></tbody>
                    </table>
                </div>

                <!-- Warehouses Section -->
                <div id="warehouses" class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª</h2>
                        <button class="btn btn-primary" onclick="showWarehouseModal()">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙˆØ¯Ø¹ Ø¬Ø¯ÙŠØ¯</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</th>
                                <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                                <th>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="warehousesTableBody"></tbody>
                    </table>
                </div>

                <!-- Work Sites Section -->
                <div id="workSites" class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Ø¥Ø¯Ø§Ø±Ø© Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù…Ù„</h2>
                        <button class="btn btn-primary" onclick="showWorkSiteModal()">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆÙ‚Ø¹ Ø¹Ù…Ù„ Ø¬Ø¯ÙŠØ¯</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                                <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                                <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th>
                                <th>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th>
                                <th>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="workSitesTableBody"></tbody>
                    </table>
                </div>

                <!-- Work Site Groups Section -->
                <div id="workSiteGroups" class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù…Ù„</h2>
                        <button class="btn btn-primary" onclick="showWorkSiteGroupModal()">Ø¥Ø¶Ø§ÙØ© Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
                    </div>
                    <p style="color: #666; margin-bottom: 15px;">Ø¹Ù†Ø¯ Ù…Ù†Ø­ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØµÙ„Ø§Ø­ÙŠØ© Ø¹Ù„Ù‰ Ù…Ø¬Ù…ÙˆØ¹Ø©ØŒ ÙŠØµØ¨Ø­ Ù„Ù‡ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ ÙƒÙ„ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ø¯Ø±Ø¬Ø© Ø¶Ù…Ù†Ù‡Ø§.</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th>
                                <th>Ø§Ù„ÙˆØµÙ</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="workSiteGroupsTableBody"></tbody>
                    </table>
                </div>

                <!-- Suppliers Section -->
                <div id="suppliers" class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø²ÙˆØ¯ÙŠÙ†</h2>
                        <button class="btn btn-primary" onclick="showSupplierModal()">Ø¥Ø¶Ø§ÙØ© Ù…Ø²ÙˆØ¯ Ø¬Ø¯ÙŠØ¯</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø²ÙˆØ¯</th>
                                <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                                <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                                <th>Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="suppliersTableBody"></tbody>
                    </table>
                </div>

                <!-- Units Section -->
                <div id="units" class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆØ­Ø¯Ø§Øª</h2>
                        <button class="btn btn-primary" onclick="showUnitModal()">Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Ø§Ù„ÙƒÙˆØ¯</th>
                                <th>Ø§Ø³Ù… Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                <th>Ø§Ù„ÙˆØµÙ</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="unitsTableBody"></tbody>
                    </table>
                </div>

                <!-- Receive Section -->
                <div id="receive" class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</h2>
                        <button id="receiveAddBtn" class="btn btn-primary" onclick="showReceiveModal()">Ø¥Ø¶Ø§ÙØ© Ø§Ø³ØªÙ„Ø§Ù… Ø¬Ø¯ÙŠØ¯</button>
                    </div>
                    <div class="search-box">
                        <input type="text" id="searchReceives" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…..." onkeyup="filterReceives()">
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„</th>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>Ø§Ù„Ù…Ø²ÙˆØ¯</th>
                                <th>Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</th>
                                <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯</th>
                                <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="receivesTableBody"></tbody>
                    </table>
                </div>

                <!-- Deliver Section -->
                <div id="deliver" class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…</h2>
                        <button id="deliverAddBtn" class="btn btn-primary" onclick="showDeliverModal()">Ø¥Ø¶Ø§ÙØ© ØªØ³Ù„ÙŠÙ… Ø¬Ø¯ÙŠØ¯</button>
                    </div>
                    <div class="search-box">
                        <input type="text" id="searchDelivers" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…..." onkeyup="filterDelivers()">
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„ÙŠÙ…</th>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</th>
                                <th>Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„</th>
                                <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯</th>
                                <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="deliversTableBody"></tbody>
                    </table>
                </div>

                <!-- Return Section -->
                <div id="return" class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯</h2>
                        <button id="returnAddBtn" class="btn btn-primary" onclick="showReturnModal()">Ø¥Ø¶Ø§ÙØ© Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø¬Ø¯ÙŠØ¯</button>
                    </div>
                    <div class="search-box">
                        <input type="text" id="searchReturns" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯..." onkeyup="filterReturns()">
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Ø±Ù‚Ù… Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯</th>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„</th>
                                <th>Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</th>
                                <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯</th>
                                <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="returnsTableBody"></tbody>
                    </table>
                </div>

                <!-- Inventory Section -->
                <div id="inventory" class="section">
                    <h2>ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h2>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label>Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹:</label>
                            <select id="inventoryWarehouse" onchange="loadInventory()">
                                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„Ù…Ø§Ø¯Ø©:</label>
                            <div class="searchable-select" id="inventoryMaterialSelectDiv" style="width: 100%;">
                                <div class="selected-value" onclick="toggleInventoryMaterialOptions()" style="min-height: 42px; cursor: pointer;">
                                    <span id="inventoryMaterialDisplay">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯</span>
                                </div>
                                <div class="options-list" id="inventoryMaterialOptions">
                                    <input type="text" id="inventoryMaterialSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù…Ø²..." onkeyup="filterInventoryMaterialOptions()" onclick="event.stopPropagation()">
                                    <div id="inventoryMaterialOptionsList"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Ø±Ù…Ø² Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                                <th>Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹/Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                                <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                                <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody"></tbody>
                    </table>
                </div>

                <!-- Inventory Verification & Maintenance Section -->
                <div id="inventoryVerification" class="section">
                    <h2>Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØµÙŠØ§Ù†Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</h2>
                    <p style="color: #666; margin-bottom: 20px;">Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­Ø³ÙˆØ¨ Ù…Ù† Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª (Ø§Ø³ØªÙ„Ø§Ù… - ØªØ³Ù„ÙŠÙ… + Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…) Ù…Ø¹ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†ØŒ ÙˆØ¹Ø±Ø¶ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„Ø¥ØµÙ„Ø§Ø­.</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label>Ù†Ø·Ø§Ù‚ Ø§Ù„ÙØ­Øµ:</label>
                            <select id="inventoryVerifyScope">
                                <option value="all">Ø§Ù„ÙƒÙ„ (Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª + Ù…ÙˆØ§Ù‚Ø¹ Ø¹Ù…Ù„)</option>
                                <option value="warehouse">Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª ÙÙ‚Ø·</option>
                                <option value="workSite">Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù…Ù„ ÙÙ‚Ø·</option>
                            </select>
                        </div>
                        <div class="form-group" id="inventoryVerifyWarehouseGroup">
                            <label>Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                            <select id="inventoryVerifyWarehouse">
                                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª</option>
                            </select>
                        </div>
                        <div class="form-group" id="inventoryVerifyWorkSiteGroup">
                            <label>Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                            <select id="inventoryVerifyWorkSite">
                                <option value="">Ø¬Ù…ÙŠØ¹ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù…Ù„</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„Ù…Ø§Ø¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                            <select id="inventoryVerifyMaterial">
                                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <button type="button" class="btn btn-primary" id="inventoryVerifyScanBtn" onclick="runInventoryVerification()">ÙØ­Øµ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</button>
                        <button type="button" class="btn btn-warning" id="inventoryVerifyRepairBtn" onclick="repairInventoryDiscrepancies()" style="display: none; margin-right: 10px;">Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</button>
                    </div>
                    <div id="inventoryVerifyStatus" style="margin-bottom: 15px; font-weight: bold;"></div>
                    <div id="inventoryVerifyResults" style="overflow-x: auto;">
                        <table id="inventoryVerifyTable" style="display: none; width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f5f5f5;">
                                    <th style="padding: 10px; border: 1px solid #ddd;">Ø§Ù„Ù…ÙˆÙ‚Ø¹ / Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Ø§Ù„Ù…Ø³ØªÙ„Ù…</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Ø§Ù„Ù…Ø³Ù„Ù…</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Ø§Ù„Ù…Ø³ØªØ±Ø¯</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­Ø³ÙˆØ¨</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³Ø¬Ù„</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Ø§Ù„ÙØ±Ù‚</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Ø¥ØµÙ„Ø§Ø­</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryVerifyTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Reports Section -->
                <div id="reports" class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
                        <!-- Warehouse Inventory Report -->
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 10px; color: white;">
                            <h3 style="color: white; margin-bottom: 15px;">ğŸ“¦ ØªÙ‚Ø±ÙŠØ± Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª</h3>
                            <p style="opacity: 0.9; margin-bottom: 20px; font-size: 0.9em;">Ø¹Ø±Ø¶ Ø¬Ø±Ø¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª Ù…Ø¹ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…ØªÙˆÙØ±Ø©</p>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="color: white; margin-bottom: 8px; font-size: 0.9em;">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹:</label>
                                <select id="warehouseReportSelect" style="padding: 10px; border-radius: 5px; border: none; width: 100%;">
                                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="color: white; margin-bottom: 8px; font-size: 0.9em;">Ø§Ù„Ù…Ø§Ø¯Ø©:</label>
                                <div class="searchable-select" id="warehouseReportMaterialSelectDiv" style="width: 100%;">
                                    <div class="selected-value" onclick="toggleWarehouseReportMaterialOptions()" style="min-height: 38px; cursor: pointer; color: #333; background: white; padding: 8px; border-radius: 5px;">
                                        <span id="warehouseReportMaterialDisplay">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯</span>
                                    </div>
                                    <div class="options-list" id="warehouseReportMaterialOptions">
                                        <input type="text" id="warehouseReportMaterialSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù…Ø²..." onkeyup="filterWarehouseReportMaterialOptions()" onclick="event.stopPropagation()" style="color: #333; background-color: white;">
                                        <div id="warehouseReportMaterialOptionsList"></div>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="loadWarehouseInventoryReport()" style="width: 100%; background: white; color: #667eea; font-size: 0.9em; padding: 10px;">
                                Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                            </button>
                            <button class="btn btn-secondary" onclick="printWarehouseInventoryReport()" style="width: 100%; margin-top: 10px; background: rgba(255,255,255,0.2); color: white; border: 1px solid white; font-size: 0.9em; padding: 10px;">
                                Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                            </button>
                        </div>
                        
                        <!-- Work Site Delivered Materials Report -->
                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 25px; border-radius: 10px; color: white;">
                            <h3 style="color: white; margin-bottom: 15px;">ğŸ—ï¸ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø³Ù„Ù…Ø©</h3>
                            <p style="opacity: 0.9; margin-bottom: 20px; font-size: 0.9em;">Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø³Ù„Ù…Ø© Ø¥Ù„Ù‰ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù…Ù„ Ù…Ø¹ Ø§Ù„ÙƒÙ…ÙŠØ§Øª</p>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="color: white; margin-bottom: 8px; font-size: 0.9em;">Ø§Ø®ØªØ± Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„:</label>
                                <select id="workSiteReportSelect" style="padding: 10px; border-radius: 5px; border: none; width: 100%;">
                                    <option value="">Ø¬Ù…ÙŠØ¹ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù…Ù„</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="loadWorkSiteDeliveredReport()" style="width: 100%; background: white; color: #f5576c; font-size: 0.9em; padding: 10px;">
                                Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                            </button>
                            <button class="btn btn-secondary" onclick="printWorkSiteDeliveredReport()" style="width: 100%; margin-top: 10px; background: rgba(255,255,255,0.2); color: white; border: 1px solid white; font-size: 0.9em; padding: 10px;">
                                Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                            </button>
                        </div>
                        
                        <!-- Material Movement Report -->
                        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 25px; border-radius: 10px; color: white;">
                            <h3 style="color: white; margin-bottom: 15px;">ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø­Ø±ÙƒØ© Ø§Ù„Ù…Ø§Ø¯Ø©</h3>
                            <p style="opacity: 0.9; margin-bottom: 20px; font-size: 0.9em;">Ø¹Ø±Ø¶ Ø­Ø±ÙƒØ© Ù…Ø§Ø¯Ø© Ù…Ø­Ø¯Ø¯Ø© ÙÙŠ Ù…Ø³ØªÙˆØ¯Ø¹ Ø®Ù„Ø§Ù„ ÙØªØ±Ø© Ø²Ù…Ù†ÙŠØ©</p>
                            <div class="form-group" style="margin-bottom: 10px;">
                                <label style="color: white; margin-bottom: 5px; font-size: 0.85em;">Ø§Ù„Ù…Ø§Ø¯Ø©:</label>
                                <div class="searchable-select" id="materialMovementSelectDiv" style="width: 100%;">
                                    <div class="selected-value empty" onclick="toggleMaterialMovementOptions()" style="color: #333;">
                                        <span id="materialMovementDisplay" style="color: #333;">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</span>
                                    </div>
                                    <div class="options-list" id="materialMovementOptions" style="color: #333;">
                                        <input type="text" id="materialMovementSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø§Ø¯Ø©..." onkeyup="filterMaterialMovementOptions()" onclick="event.stopPropagation()" style="color: #333; background-color: white;">
                                        <div id="materialMovementOptionsList" style="color: #333;"></div>
                                    </div>
                                    <input type="hidden" id="materialMovementSelect" value="">
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 10px;">
                                <label style="color: white; margin-bottom: 5px; font-size: 0.85em;">Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹:</label>
                                <select id="warehouseMovementSelect" style="padding: 8px; border-radius: 5px; border: none; width: 100%; font-size: 0.9em;">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 10px;">
                                <label style="color: white; margin-bottom: 5px; font-size: 0.85em;">Ù…Ù† ØªØ§Ø±ÙŠØ®:</label>
                                <input type="date" id="materialMovementFromDate" style="padding: 8px; border-radius: 5px; border: none; width: 100%; font-size: 0.9em;">
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="color: white; margin-bottom: 5px; font-size: 0.85em;">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label>
                                <input type="date" id="materialMovementToDate" style="padding: 8px; border-radius: 5px; border: none; width: 100%; font-size: 0.9em;">
                            </div>
                            <button class="btn btn-primary" onclick="loadMaterialMovementReport()" style="width: 100%; background: white; color: #4facfe; font-size: 0.9em; padding: 10px;">
                                Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                            </button>
                            <button class="btn btn-secondary" onclick="printMaterialMovementReport()" style="width: 100%; margin-top: 10px; background: rgba(255,255,255,0.2); color: white; border: 1px solid white; font-size: 0.9em; padding: 10px;">
                                Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                            </button>
                        </div>
                    </div>
                    
                    <!-- Warehouse Inventory Report Results -->
                    <div id="warehouseInventoryReport" style="display: none; margin-bottom: 30px;">
                        <div style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="color: #667eea;">ğŸ“¦ ØªÙ‚Ø±ÙŠØ± Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª</h3>
                                <button class="btn btn-info" onclick="printWarehouseInventoryReport()" style="background: #17a2b8; color: white;">
                                    Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                                </button>
                            </div>
                            <div id="warehouseInventoryReportContent"></div>
                        </div>
                    </div>
                    
                    <!-- Work Site Delivered Report Results -->
                    <div id="workSiteDeliveredReport" style="display: none; margin-bottom: 30px;">
                        <div style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="color: #f5576c;">ğŸ—ï¸ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø³Ù„Ù…Ø©</h3>
                                <button class="btn btn-info" onclick="printWorkSiteDeliveredReport()" style="background: #17a2b8; color: white;">
                                    Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                                </button>
                            </div>
                            <div id="workSiteDeliveredReportContent"></div>
                        </div>
                    </div>
                    
                    <!-- Material Movement Report Results -->
                    <div id="materialMovementReport" style="display: none; margin-bottom: 30px;">
                        <div style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="color: #4facfe;">ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø­Ø±ÙƒØ© Ø§Ù„Ù…Ø§Ø¯Ø©</h3>
                                <button class="btn btn-info" onclick="printMaterialMovementReport()" style="background: #17a2b8; color: white;">
                                    Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                                </button>
                            </div>
                            <div id="materialMovementReportContent"></div>
                        </div>
                    </div>
                </div>

                <!-- Users Management Section -->
                <div id="users" class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</h2>
                        <button class="btn btn-primary" onclick="showUserModal()">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                                <th>Ø§Ù„Ø§Ø³Ù…</th>
                                <th>Ù†ÙˆØ¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© / Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª</th>
                                <th>Ù†ÙˆØ¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© / Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù…Ù„</th>
                                <th>ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody"></tbody>
                    </table>
                </div>

                <!-- Activity Log Section -->
                <div id="activityLog" class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h2>
                        <div style="display: flex; gap: 10px;">
                            <select id="activityLogFilter" onchange="loadActivityLog()" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</option>
                                <option value="create">Ø¥Ø¶Ø§ÙØ©</option>
                                <option value="update">ØªØ¹Ø¯ÙŠÙ„</option>
                                <option value="delete">Ø­Ø°Ù</option>
                            </select>
                            <select id="activityLogEntityFilter" onchange="loadActivityLog()" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙŠØ§Ù†Ø§Øª</option>
                                <option value="material">Ø§Ù„Ù…ÙˆØ§Ø¯</option>
                                <option value="warehouse">Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª</option>
                                <option value="workSite">Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù…Ù„</option>
                                <option value="supplier">Ø§Ù„Ù…Ø²ÙˆØ¯ÙŠÙ†</option>
                                <option value="unit">Ø§Ù„ÙˆØ­Ø¯Ø§Øª</option>
                                <option value="user">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</option>
                            </select>
                        </div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <table>
                            <thead>
                                <tr>
                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</th>
                                    <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                                    <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                                    <th>Ø§Ù„ÙƒÙŠØ§Ù†</th>
                                    <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
                                    <th>Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="activityLogTableBody">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 20px; color: #999;">
                                        Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer with Copyright -->
    <footer class="footer">
        <div class="footer-content">
            <span>Â© 2024 RoseMary Ù„Ù„Ø­Ù„ÙˆÙ„ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ© - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</span>
            <span>|</span>
            <span>RoseMary Software Solutions - Inventory Management System. All Rights Reserved.</span>
        </div>
    </footer>

    <!-- Material Modal -->
    <div id="materialModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="materialModalTitle">Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
                <button class="close" onclick="closeModal('materialModal')">&times;</button>
            </div>
            <form id="materialForm">
                <div class="form-group">
                    <label>ÙƒÙˆØ¯ Ø§Ù„Ù…Ø§Ø¯Ø©:</label>
                    <input type="text" id="materialCode" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                    <small style="color: #666; display: block; margin-top: 5px;">ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</small>
                </div>
                <div class="form-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©:</label>
                    <input type="text" id="materialName" required>
                </div>
                <div class="form-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø«Ø§Ù†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                    <input type="text" id="materialSecondName" placeholder="Ø§Ø³Ù… Ø¨Ø¯ÙŠÙ„ Ø£Ùˆ Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„Ù…Ø§Ø¯Ø©">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ÙØ¦Ø©:</label>
                    <select id="materialCategory" required>
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø©</option>
                        <option value="Ø¨Ù†Ø§Ø¡">Ø¨Ù†Ø§Ø¡</option>
                        <option value="ÙƒÙ‡Ø±Ø¨Ø§Ø¡">ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option>
                        <option value="Ø³Ø¨Ø§ÙƒØ©">Ø³Ø¨Ø§ÙƒØ©</option>
                        <option value="Ø¯Ù‡Ø§Ù†Ø§Øª">Ø¯Ù‡Ø§Ù†Ø§Øª</option>
                        <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:</label>
                    <select id="materialUnit" required>
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                    <select id="materialSubUnit">
                        <option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø© ÙØ±Ø¹ÙŠØ©</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ØªØ¹Ø§Ø¯Ù„ (Ø§Ù„ÙƒÙ…ÙŠØ©):</label>
                    <input type="number" id="materialConversion" min="0.001" step="0.001" placeholder="Ù…Ø«Ø§Ù„: 12" disabled>
                    <small style="color: #666; display: block; margin-top: 5px;">ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± ÙˆØ­Ø¯Ø© ÙØ±Ø¹ÙŠØ©</small>
                </div>
                <div class="form-group">
                    <label>Ù†ÙˆØ¹ Ø§Ù„ØªØ¹Ø§Ø¯Ù„:</label>
                    <select id="materialConversionType" disabled>
                        <option value="multiply">Ø¶Ø±Ø¨</option>
                        <option value="divide">Ù‚Ø³Ù…Ø©</option>
                    </select>
                    <div id="conversionExamples" style="background-color: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 10px; border-right: 3px solid #3498db;">
                        <small style="color: #666; display: block;">
                            <div id="multiplyExample" style="display: none;">
                                <strong>Ù…Ø«Ø§Ù„ (Ø¶Ø±Ø¨):</strong> <span id="multiplyText">1 <span class="sub-unit-placeholder">ÙˆØ­Ø¯Ø© ÙØ±Ø¹ÙŠØ©</span> = <span class="conversion-placeholder">12</span> Ã— <span class="base-unit-placeholder">ÙˆØ­Ø¯Ø© Ø£Ø³Ø§Ø³ÙŠØ©</span></span>
                            </div>
                            <div id="divideExample" style="display: none;">
                                <strong>Ù…Ø«Ø§Ù„ (Ù‚Ø³Ù…Ø©):</strong> <span id="divideText"><span class="conversion-placeholder">12</span> <span class="sub-unit-placeholder">ÙˆØ­Ø¯Ø© ÙØ±Ø¹ÙŠØ©</span> = 1 <span class="base-unit-placeholder">ÙˆØ­Ø¯Ø© Ø£Ø³Ø§Ø³ÙŠØ©</span></span>
                            </div>
                            <div id="noConversionExample" style="display: none; color: #999;">
                                Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ© ÙˆØ§Ù„ØªØ¹Ø§Ø¯Ù„ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø«Ø§Ù„
                            </div>
                        </small>
                    </div>
                </div>
                <div class="form-group">
                    <label>Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ù…Ø®Ø²ÙˆÙ†:</label>
                    <input type="number" id="materialMinStock" min="0" value="0">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ÙˆØµÙ:</label>
                    <textarea id="materialDescription" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Ø­ÙØ¸</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('materialModal')">Ø¥Ù„ØºØ§Ø¡</button>
            </form>
        </div>
    </div>

    <!-- Warehouse Modal -->
    <div id="warehouseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="warehouseModalTitle">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙˆØ¯Ø¹ Ø¬Ø¯ÙŠØ¯</h2>
                <button class="close" onclick="closeModal('warehouseModal')">&times;</button>
            </div>
            <form id="warehouseForm">
                <div class="form-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹:</label>
                    <input type="text" id="warehouseName" required>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù…ÙˆÙ‚Ø¹/Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</label>
                    <input type="text" id="warehouseLocation" required>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:</label>
                    <input type="text" id="warehouseManager">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø­Ø§Ù„Ø©:</label>
                    <select id="warehouseStatus" required>
                        <option value="Ù†Ø´Ø·">Ù†Ø´Ø·</option>
                        <option value="Ù…ØªÙˆÙ‚Ù">Ù…ØªÙˆÙ‚Ù</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Ø­ÙØ¸</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('warehouseModal')">Ø¥Ù„ØºØ§Ø¡</button>
            </form>
        </div>
    </div>

    <!-- Work Site Modal -->
    <div id="workSiteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="workSiteModalTitle">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆÙ‚Ø¹ Ø¹Ù…Ù„ Ø¬Ø¯ÙŠØ¯</h2>
                <button class="close" onclick="closeModal('workSiteModal')">&times;</button>
            </div>
            <form id="workSiteForm">
                <div class="form-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹:</label>
                    <input type="text" id="workSiteName" required>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</label>
                    <input type="text" id="workSiteAddress" required>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:</label>
                    <input type="text" id="workSiteManager">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:</label>
                    <select id="workSiteGroupId">
                        <option value="">Ø¨Ø¯ÙˆÙ† Ù…Ø¬Ù…ÙˆØ¹Ø©</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹:</label>
                    <input type="text" id="workSiteType">
                </div>
                <button type="submit" class="btn btn-primary">Ø­ÙØ¸</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('workSiteModal')">Ø¥Ù„ØºØ§Ø¡</button>
            </form>
        </div>
    </div>

    <!-- Work Site Group Modal -->
    <div id="workSiteGroupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="workSiteGroupModalTitle">Ø¥Ø¶Ø§ÙØ© Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…ÙˆØ§Ù‚Ø¹ Ø¹Ù…Ù„ Ø¬Ø¯ÙŠØ¯Ø©</h2>
                <button class="close" onclick="closeModal('workSiteGroupModal')">&times;</button>
            </div>
            <form id="workSiteGroupForm">
                <div class="form-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:</label>
                    <input type="text" id="workSiteGroupName" required>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                    <input type="text" id="workSiteGroupDescription" placeholder="">
                </div>
                <button type="submit" class="btn btn-primary">Ø­ÙØ¸</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('workSiteGroupModal')">Ø¥Ù„ØºØ§Ø¡</button>
            </form>
        </div>
    </div>

    <!-- Supplier Modal -->
    <div id="supplierModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="supplierModalTitle">Ø¥Ø¶Ø§ÙØ© Ù…Ø²ÙˆØ¯ Ø¬Ø¯ÙŠØ¯</h2>
                <button class="close" onclick="closeModal('supplierModal')">&times;</button>
            </div>
            <form id="supplierForm">
                <div class="form-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø²ÙˆØ¯:</label>
                    <input type="text" id="supplierName" required>
                </div>
                <div class="form-group">
                    <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</label>
                    <input type="tel" id="supplierPhone">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</label>
                    <input type="email" id="supplierEmail">
                </div>
                <div class="form-group">
                    <label>Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯:</label>
                    <input type="text" id="supplierMaterialsType">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</label>
                    <textarea id="supplierAddress" rows="2"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Ø­ÙØ¸</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('supplierModal')">Ø¥Ù„ØºØ§Ø¡</button>
            </form>
        </div>
    </div>

    <!-- Unit Modal -->
    <div id="unitModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="unitModalTitle">Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
                <button class="close" onclick="closeModal('unitModal')">&times;</button>
            </div>
            <form id="unitForm">
                <div class="form-group">
                    <label>ÙƒÙˆØ¯ Ø§Ù„ÙˆØ­Ø¯Ø©:</label>
                    <input type="text" id="unitCode" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                    <small style="color: #666; display: block; margin-top: 5px;">ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</small>
                </div>
                <div class="form-group">
                    <label>Ø§Ø³Ù… Ø§Ù„ÙˆØ­Ø¯Ø©:</label>
                    <input type="text" id="unitName" required placeholder="Ù…Ø«Ø§Ù„: Ù‚Ø·Ø¹Ø©ØŒ ØµÙ†Ø¯ÙˆÙ‚ØŒ ÙƒØ§Ø±ØªÙˆÙ†">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù†ÙˆØ¹:</label>
                    <select id="unitType" required>
                        <option value="ÙˆØ²Ù†">ÙˆØ²Ù†</option>
                        <option value="Ø·ÙˆÙ„">Ø·ÙˆÙ„</option>
                        <option value="Ø­Ø¬Ù…">Ø­Ø¬Ù…</option>
                        <option value="Ø¹Ø¯Ø¯">Ø¹Ø¯Ø¯</option>
                        <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                    <textarea id="unitDescription" rows="2" placeholder="ÙˆØµÙ Ù…Ø®ØªØµØ± Ù„Ù„ÙˆØ­Ø¯Ø©"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Ø­ÙØ¸</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('unitModal')">Ø¥Ù„ØºØ§Ø¡</button>
            </form>
        </div>
    </div>

    <!-- Receive Modal -->
    <div id="receiveModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header receive-header">
                <h2 id="receiveModalTitle">Ø¥Ø¶Ø§ÙØ© Ø§Ø³ØªÙ„Ø§Ù… Ø¬Ø¯ÙŠØ¯</h2>
                <button class="close" onclick="closeModal('receiveModal')">&times;</button>
            </div>
            <div class="alert modal-alert" id="receiveModalAlert" style="display: none; margin: 15px 20px;"></div>
            <form id="receiveForm">
                <div class="form-section">
                    <div class="form-section-title receive-title">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                        <div class="form-group">
                            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…:</label>
                            <input type="date" id="receiveDate" required>
                        </div>
                        <div class="form-group">
                            <label>Ø±Ù‚Ù… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…:</label>
                            <input type="text" id="receiveNumber" placeholder="Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹" readonly style="background-color: #f5f5f5;">
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„Ù…Ø²ÙˆØ¯: <span style="color: red;">*</span></label>
                            <div class="searchable-select" id="receiveSupplierSelect">
                                <div class="selected-value empty" onclick="toggleSupplierOptions()">
                                    <span id="receiveSupplierDisplay">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø²ÙˆØ¯</span>
                                </div>
                                <div class="options-list" id="receiveSupplierOptions">
                                    <input type="text" id="receiveSupplierSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø²ÙˆØ¯..." onkeyup="filterSupplierOptions()" onclick="event.stopPropagation()">
                                    <div id="receiveSupplierOptionsList"></div>
                                </div>
                                <input type="hidden" id="receiveSupplier" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹: <span style="color: red;">*</span></label>
                            <select id="receiveWarehouse" required>
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</option>
                            </select>
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>Ø±Ù‚Ù… Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ù…Ø²ÙˆØ¯:</label>
                            <input type="text" id="receiveSupplierInvoice" placeholder="Ø±Ù‚Ù… Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ù…Ø²ÙˆØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title receive-title">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©</div>
                    <div class="items-list" id="receiveItemsList" style="max-height: 450px; overflow-y: auto;"></div>
                    <button type="button" class="btn btn-success" onclick="addReceiveItem()" style="margin-top: 10px;">
                        <span>+</span> Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©
                    </button>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title receive-title">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</div>
                    <textarea id="receiveNotes" rows="3" placeholder="Ø£Ø¶Ù Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù‡Ù†Ø§..."></textarea>
                </div>
                
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary" style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%);">
                        Ø­ÙØ¸ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('receiveModal')">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Deliver Modal -->
    <div id="deliverModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header deliver-header">
                <h2 id="deliverModalTitle">Ø¥Ø¶Ø§ÙØ© ØªØ³Ù„ÙŠÙ… Ø¬Ø¯ÙŠØ¯</h2>
                <button class="close" onclick="closeModal('deliverModal')">&times;</button>
            </div>
            <div class="alert modal-alert" id="deliverModalAlert" style="display: none; margin: 15px 20px;"></div>
            <form id="deliverForm">
                <div class="form-section">
                    <div class="form-section-title deliver-title">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                        <div class="form-group">
                            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…:</label>
                            <input type="date" id="deliverDate" required>
                        </div>
                        <div class="form-group">
                            <label>Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„ÙŠÙ…:</label>
                            <input type="text" id="deliverNumber" placeholder="Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹" readonly style="background-color: #f5f5f5;">
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹: <span style="color: red;">*</span></label>
                            <select id="deliverWarehouse" required onchange="loadWarehouseInventory(this.value, 'deliver')">
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„: <span style="color: red;">*</span></label>
                            <select id="deliverWorkSite" required>
                                <option value="">Ø§Ø®ØªØ± Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„</option>
                            </select>
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„:</label>
                            <input type="text" id="deliverInvoice" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title deliver-title">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø³Ù„Ù…Ø©</div>
                    <div class="items-list" id="deliverItemsList" style="max-height: 450px; overflow-y: auto;"></div>
                    <button type="button" class="btn btn-success" onclick="addDeliverItem()" style="margin-top: 10px;">
                        <span>+</span> Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©
                    </button>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title deliver-title">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</div>
                    <textarea id="deliverNotes" rows="3" placeholder="Ø£Ø¶Ù Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù‡Ù†Ø§..."></textarea>
                </div>
                
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">
                        Ø­ÙØ¸ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ù„ÙŠÙ…
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('deliverModal')">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Return Modal -->
    <div id="returnModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header return-header">
                <h2 id="returnModalTitle">Ø¥Ø¶Ø§ÙØ© Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø¬Ø¯ÙŠØ¯</h2>
                <button class="close" onclick="closeModal('returnModal')">&times;</button>
            </div>
            <div class="alert modal-alert" id="returnModalAlert" style="display: none; margin: 15px 20px;"></div>
            <form id="returnForm">
                <div class="form-section">
                    <div class="form-section-title return-title">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                        <div class="form-group">
                            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯:</label>
                            <input type="date" id="returnDate" required>
                        </div>
                        <div class="form-group">
                            <label>Ø±Ù‚Ù… Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯:</label>
                            <input type="text" id="returnNumber" placeholder="Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹" readonly style="background-color: #f5f5f5;">
                        </div>
                        <div class="form-group">
                            <label>Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„: <span style="color: red;">*</span></label>
                            <select id="returnWorkSite" required onchange="loadWorkSiteInventory(this.value, 'return')">
                                <option value="">Ø§Ø®ØªØ± Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹: <span style="color: red;">*</span></label>
                            <select id="returnWarehouse" required>
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</option>
                            </select>
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„:</label>
                            <input type="text" id="returnInvoice" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title return-title">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø³ØªØ±Ø¯Ø©</div>
                    <div class="items-list" id="returnItemsList" style="max-height: 450px; overflow-y: auto;"></div>
                    <button type="button" class="btn btn-success" onclick="addReturnItem()" style="margin-top: 10px;">
                        <span>+</span> Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©
                    </button>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title return-title">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</div>
                    <textarea id="returnNotes" rows="3" placeholder="Ø£Ø¶Ù Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù‡Ù†Ø§..."></textarea>
                </div>
                
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">
                        Ø­ÙØ¸ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('returnModal')">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="userModalTitle">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h2>
                <button class="close" onclick="closeModal('userModal')">&times;</button>
            </div>
            <form id="userForm">
                <div class="form-group">
                    <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: <span style="color: red;">*</span></label>
                    <input type="email" id="userEmail" required>
                </div>
                <div class="form-group">
                    <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: <span style="color: red;">*</span></label>
                    <input type="password" id="userPassword" required>
                    <small style="color: #666; font-size: 12px;">ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„</small>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø§Ø³Ù…:</label>
                    <input type="text" id="userName" placeholder="Ø§Ù„Ø§Ø³Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                </div>
                <div class="form-section">
                    <div class="form-section-title" style="border-bottom-color: #3498db;">Ù†ÙˆØ¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;">
                            <input type="radio" name="userPermissionType" value="full" id="permissionFull" checked style="margin-left: 8px; width: 18px; height: 18px;" onchange="togglePermissionType()">
                            <span>ØµÙ„Ø§Ø­ÙŠØ© ÙƒØ§Ù…Ù„Ø© (Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª ÙˆÙ…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù…Ù„)</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="userPermissionType" value="custom" id="permissionCustom" style="margin-left: 8px; width: 18px; height: 18px;" onchange="togglePermissionType()">
                            <span>ØµÙ„Ø§Ø­ÙŠØ© Ù…Ø®ØµØµØ© (ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª ÙˆÙ…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù…Ù„)</span>
                        </label>
                    </div>
                </div>
                <div class="form-section" id="customPermissionsSection" style="margin-top: 20px; display: none;">
                    <div class="form-section-title" style="border-bottom-color: #3498db;">Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª Ø§Ù„Ù…ØµØ±Ø­ Ø¨Ù‡Ø§</div>
                    <div id="userWarehousesList" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                        <p style="color: #666; font-style: italic; text-align: center;">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª...</p>
                    </div>
                    <small style="color: #666; font-size: 12px;">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª Ø§Ù„ØªÙŠ ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡Ø§</small>
                </div>
                <div class="form-section" id="customWorkSitesSection" style="margin-top: 20px; display: none;">
                    <div class="form-section-title" style="border-bottom-color: #3498db;">Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…ØµØ±Ø­ Ø¨Ù‡Ø§</div>
                    <div id="userWorkSiteGroupsList" style="max-height: 160px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                        <p style="color: #666; font-style: italic; text-align: center;">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª...</p>
                    </div>
                    <small style="color: #666; font-size: 12px;">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª: Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø¬Ù…ÙŠØ¹ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù…Ù„ Ø¶Ù…Ù† ÙƒÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ø¯Ø¯Ø©</small>
                    <div class="form-section-title" style="border-bottom-color: #3498db; margin-top: 12px;">Ù…ÙˆØ§Ù‚Ø¹ Ø¹Ù…Ù„ Ø¥Ø¶Ø§ÙÙŠØ© (ÙØ±Ø¯ÙŠØ©)</div>
                    <div id="userWorkSitesList" style="max-height: 160px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                        <p style="color: #666; font-style: italic; text-align: center;">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù…Ù„...</p>
                    </div>
                    <small style="color: #666; font-size: 12px;">Ø§Ø®ØªØ± Ù…ÙˆØ§Ù‚Ø¹ Ø¹Ù…Ù„ Ø¥Ø¶Ø§ÙÙŠØ© ØºÙŠØ± Ù…Ø¯Ø±Ø¬Ø© ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø£Ø¹Ù„Ø§Ù‡</small>
                </div>
                <div class="form-section" id="customSuppliersSection" style="margin-top: 20px; display: none;">
                    <div class="form-section-title" style="border-bottom-color: #3498db;">Ø§Ù„Ù…Ø²ÙˆØ¯ÙŠÙ† Ø§Ù„Ù…ØµØ±Ø­ Ù„Ù‡Ù…</div>
                    <div id="userSuppliersList" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                        <p style="color: #666; font-style: italic; text-align: center;">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙˆØ¯ÙŠÙ†...</p>
                    </div>
                    <small style="color: #666; font-size: 12px;">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø²ÙˆØ¯ÙŠÙ† Ø§Ù„ØªÙŠ ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡Ø§</small>
                </div>
                <div class="form-section" style="margin-top: 20px;">
                    <div class="form-section-title" style="border-bottom-color: #3498db;">ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;">
                            <input type="checkbox" id="userCanManageMaterials" style="margin-left: 8px; width: 18px; height: 18px;">
                            <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ (Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù)</span>
                        </label>
                        <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;">
                            <input type="checkbox" id="userCanManageWarehouses" style="margin-left: 8px; width: 18px; height: 18px;">
                            <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª (Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù)</span>
                        </label>
                        <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;">
                            <input type="checkbox" id="userCanManageWorkSites" style="margin-left: 8px; width: 18px; height: 18px;">
                            <span>Ø¥Ø¯Ø§Ø±Ø© Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù…Ù„ (Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù)</span>
                        </label>
                        <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;">
                            <input type="checkbox" id="userCanManageSuppliers" style="margin-left: 8px; width: 18px; height: 18px;">
                            <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø²ÙˆØ¯ÙŠÙ† (Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù)</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="userCanManageUnits" style="margin-left: 8px; width: 18px; height: 18px;">
                            <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆØ­Ø¯Ø§Øª (Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù)</span>
                        </label>
                    </div>
                    <div class="form-section" style="margin-top: 15px;">
                        <div class="form-section-title" style="border-bottom-color: #3498db;">ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</div>
                        <div style="margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 15px 25px;">
                            <label style="display: flex; align-items: center; cursor: pointer;"><input type="checkbox" id="userReceiveAdd" style="margin-left: 8px; width: 18px; height: 18px;"> <span>Ø¥Ø¶Ø§ÙØ©</span></label>
                            <label style="display: flex; align-items: center; cursor: pointer;"><input type="checkbox" id="userReceiveEdit" style="margin-left: 8px; width: 18px; height: 18px;"> <span>ØªØ¹Ø¯ÙŠÙ„</span></label>
                            <label style="display: flex; align-items: center; cursor: pointer;"><input type="checkbox" id="userReceiveDelete" style="margin-left: 8px; width: 18px; height: 18px;"> <span>Ø­Ø°Ù</span></label>
                        </div>
                    </div>
                    <div class="form-section" style="margin-top: 15px;">
                        <div class="form-section-title" style="border-bottom-color: #3498db;">ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…</div>
                        <div style="margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 15px 25px;">
                            <label style="display: flex; align-items: center; cursor: pointer;"><input type="checkbox" id="userDeliverAdd" style="margin-left: 8px; width: 18px; height: 18px;"> <span>Ø¥Ø¶Ø§ÙØ©</span></label>
                            <label style="display: flex; align-items: center; cursor: pointer;"><input type="checkbox" id="userDeliverEdit" style="margin-left: 8px; width: 18px; height: 18px;"> <span>ØªØ¹Ø¯ÙŠÙ„</span></label>
                            <label style="display: flex; align-items: center; cursor: pointer;"><input type="checkbox" id="userDeliverDelete" style="margin-left: 8px; width: 18px; height: 18px;"> <span>Ø­Ø°Ù</span></label>
                        </div>
                    </div>
                    <div class="form-section" style="margin-top: 15px;">
                        <div class="form-section-title" style="border-bottom-color: #3498db;">ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯</div>
                        <div style="margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 15px 25px;">
                            <label style="display: flex; align-items: center; cursor: pointer;"><input type="checkbox" id="userReturnAdd" style="margin-left: 8px; width: 18px; height: 18px;"> <span>Ø¥Ø¶Ø§ÙØ©</span></label>
                            <label style="display: flex; align-items: center; cursor: pointer;"><input type="checkbox" id="userReturnEdit" style="margin-left: 8px; width: 18px; height: 18px;"> <span>ØªØ¹Ø¯ÙŠÙ„</span></label>
                            <label style="display: flex; align-items: center; cursor: pointer;"><input type="checkbox" id="userReturnDelete" style="margin-left: 8px; width: 18px; height: 18px;"> <span>Ø­Ø°Ù</span></label>
                        </div>
                    </div>
                    <small style="color: #666; font-size: 12px;">Ø§Ø®ØªØ± Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØªÙŠ ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‚ÙŠØ§Ù… Ø¨Ù‡Ø§</small>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Ø­ÙØ¸</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('userModal')">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, enableIndexedDbPersistence, collection, addDoc, getDocs, getDoc, updateDoc, deleteDoc, doc, setDoc, query, where, orderBy, Timestamp, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Make getDoc available globally
        window.getDoc = getDoc;

        // Firebase configuration
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Ø¥Ø°Ø§ ÙƒØ§Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙŠØ¹Ù…Ù„ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙˆÙ„Ø§ ÙŠØ¹Ù…Ù„ Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø· (GitHub Pages):
        // Ø§Ù„Ø³Ø¨Ø¨: Ø§Ù„Ù†Ø·Ø§Ù‚ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ ÙÙŠ Firebase. Ù†ÙÙ‘Ø° Ø§Ù„Ø®Ø·ÙˆØ§Øª ÙÙŠ Ø§Ù„Ù…Ù„Ù: Ø¥Ø¹Ø¯Ø§Ø¯-Ø§Ù„Ù†Ø´Ø±-Ø¹Ù„Ù‰-GitHub-Pages.md
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const firebaseConfig = {
            apiKey: "AIzaSyA_2C7R24mCCbNLZ9geavxSnsse0XZYqtQ",
            authDomain: "inventory-management-b5edb.firebaseapp.com",
            projectId: "inventory-management-b5edb",
            storageBucket: "inventory-management-b5edb.firebasestorage.app",
            messagingSenderId: "494055670212",
            appId: "1:494055670212:web:cafcd2c4c793dd59522491",
            measurementId: "G-FN4FH97ZJE"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        // Use local persistence: remember user across sessions (stay logged in after closing browser)
        setPersistence(auth, browserLocalPersistence).catch(() => {});
        const db = getFirestore(app);
        enableIndexedDbPersistence(db).catch(function(err) {
            if (err.code === 'failed-precondition') console.warn('Firestore: Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„ (Ø¹Ø¯Ø© Ù†ÙˆØ§ÙØ° Ù…ÙØªÙˆØ­Ø©).');
            else if (err.code === 'unimplemented') console.warn('Firestore: Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª Ø§Ù„Ù…Ø­Ù„ÙŠ.');
        });

        // Make these available globally
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseCollections = { collection, addDoc, getDocs, getDoc, updateDoc, deleteDoc, doc, setDoc, query, where, orderBy, Timestamp, serverTimestamp };
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;

        // Admin credentials
        const ADMIN_EMAIL = 'ali.alqadre93@gmail.com';
        const ADMIN_PASSWORD = 'Am9875321=9875321';

        // Global variables
        window.editingId = null;
        window.editingReceiveId = null;
        window.editingDeliverId = null;
        window.editingReturnId = null;
        window.deliverItems = [];
        window.returnItems = [];
        window.warehouseInventory = {};
        window.workSiteInventory = {};

        // Check and create admin user (optional - call manually if needed; not run on load to avoid 400 on GitHub Pages)
        async function checkAndCreateAdmin() {
            try {
                try {
                    await createUserWithEmailAndPassword(auth, ADMIN_EMAIL, ADMIN_PASSWORD);
                    await signOut(auth);
                    return true;
                } catch (createError) {
                    if (createError.code === 'auth/email-already-in-use') {
                        return true;
                    }
                    return false;
                }
            } catch (error) {
                return false;
            }
        }

        // Login function
        window.login = async function() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                showLoginAlert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', 'error');
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
                showLoginAlert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } catch (error) {
                const code = error.code || '';
                const msg = error.message || '';
                if (code === 'auth/user-not-found') {
                    showLoginAlert('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
                } else if (code === 'auth/wrong-password') {
                    showLoginAlert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
                } else if (code === 'auth/invalid-credential') {
                    showLoginAlert('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
                } else if (code === 'auth/too-many-requests') {
                    showLoginAlert('Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙƒØ«ÙŠØ±Ø©. Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø£Ùˆ Ø£Ø¹Ø¯ ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', 'error');
                } else if (code === 'auth/operation-not-allowed') {
                    showLoginAlert('ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹', 'error');
                } else if (msg.indexOf('400') !== -1 || msg.indexOf('Bad Request') !== -1) {
                    showLoginAlert('Ø®Ø·Ø£ 400: Ø£Ø¶Ù Ø§Ù„Ù†Ø·Ø§Ù‚ alialq93.github.io ÙÙŠ Firebase (Authentication > Authorized domains) ÙˆÙ…ÙØªØ§Ø­ API', 'error');
                } else {
                    showLoginAlert('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + (msg || code), 'error');
                }
            }
        };

        // Logout function
        window.logout = async function() {
            try {
                const auth = window.firebaseAuth;
                await signOut(auth);
                
                // Clear UI - onAuthStateChanged will also handle this automatically
                // but we do it here for immediate feedback
                document.getElementById('appSection').style.display = 'none';
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('email').value = '';
                document.getElementById('password').value = '';
                
                // Clear any alerts
                const alertDiv = document.getElementById('alert');
                if (alertDiv) {
                    alertDiv.textContent = '';
                    alertDiv.className = 'alert';
                }
            } catch (error) {
                console.error('Logout error:', error);
                // Try to show alert if available, otherwise use alert
                try {
                    if (typeof showAlert === 'function') {
                        showAlert('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬: ' + (error.message || error), 'error');
                    } else {
                        alert('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬: ' + (error.message || error));
                    }
                } catch (e) {
                    alert('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬: ' + (error.message || error));
                }
            }
        };

        // App loading overlay helpers
        const APP_LOAD_TIMEOUT_MS = 45000;
        function showAppLoading(show, options) {
            const overlay = document.getElementById('appLoadingOverlay');
            const textEl = document.getElementById('appLoadingText');
            const errorEl = document.getElementById('appLoadingError');
            const actionsEl = document.getElementById('appLoadingActions');
            if (!overlay) return;
            if (show) {
                overlay.classList.remove('hidden');
                overlay.style.display = 'flex';
                if (options && options.message) textEl.textContent = options.message;
                else textEl.textContent = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...';
                if (errorEl) { errorEl.style.display = 'none'; errorEl.textContent = ''; }
                if (actionsEl) actionsEl.style.display = 'none';
            } else {
                overlay.classList.add('hidden');
                setTimeout(function() { overlay.style.display = 'none'; }, 300);
            }
        }
        function showAppLoadingError(message, allowRetry) {
            const overlay = document.getElementById('appLoadingOverlay');
            const textEl = document.getElementById('appLoadingText');
            const errorEl = document.getElementById('appLoadingError');
            const actionsEl = document.getElementById('appLoadingActions');
            const spinner = overlay && overlay.querySelector('.loading-spinner');
            if (textEl) textEl.textContent = 'ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚';
            if (errorEl) { errorEl.textContent = message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©.'; errorEl.style.display = 'block'; }
            if (spinner) spinner.style.display = 'none';
            if (actionsEl) actionsEl.style.display = allowRetry !== false ? 'flex' : 'none';
        }
        function hideAppLoadingError() {
            const errorEl = document.getElementById('appLoadingError');
            const actionsEl = document.getElementById('appLoadingActions');
            const spinner = document.getElementById('appLoadingOverlay') && document.getElementById('appLoadingOverlay').querySelector('.loading-spinner');
            if (errorEl) { errorEl.style.display = 'none'; errorEl.textContent = ''; }
            if (actionsEl) actionsEl.style.display = 'none';
            if (spinner) spinner.style.display = '';
        }
        window.showSessionOrConnectionError = function(message) {
            showAppLoading(true, { message: '' });
            showAppLoadingError(message || 'Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.', true);
        };

        // Initialize on page load
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('appSection').style.display = 'block';
                document.getElementById('sidebarUserEmail').textContent = user.email;
                showAppLoading(true);
                hideAppLoadingError();
                const retryBtn = document.getElementById('appLoadingRetryBtn');
                const reloadBtn = document.getElementById('appLoadingReloadBtn');
                const doInit = function() {
                    hideAppLoadingError();
                    showAppLoading(true);
                    const overlay = document.getElementById('appLoadingOverlay');
                    const spinner = overlay && overlay.querySelector('.loading-spinner');
                    if (spinner) spinner.style.display = '';
                    return initializeAppData();
                };
                if (retryBtn) retryBtn.onclick = function() { doInit().then(function() { showAppLoading(false); }, function(err) { showAppLoadingError(err && (err.message || err) || 'ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„'); }); };
                if (reloadBtn) reloadBtn.onclick = function() { window.location.reload(); };
                try {
                    const timeoutPromise = new Promise(function(_, reject) {
                        setTimeout(function() { reject(new Error('Ø§Ø³ØªØºØ±Ù‚ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆÙ‚ØªØ§Ù‹ Ø·ÙˆÙŠÙ„Ø§Ù‹. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.')); }, APP_LOAD_TIMEOUT_MS);
                    });
                    await Promise.race([initializeAppData(), timeoutPromise]);
                    showAppLoading(false);
                } catch (err) {
                    console.error('App init error:', err);
                    showAppLoadingError(err && (err.message || err) || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„', true);
                }
            } else {
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('appSection').style.display = 'none';
                document.getElementById('email').value = '';
                document.getElementById('password').value = '';
                window.adminCheckAttempted = true;
            }
        });

        window.checkAndCreateAdmin = checkAndCreateAdmin;

        // ========== LANGUAGE SUPPORT ==========
        window.currentLanguage = localStorage.getItem('appLanguage') || 'ar';
        
        const translations = {
            ar: {
                // Common
                'logout': 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬',
                'login': 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„',
                'email': 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ',
                'password': 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±',
                'save': 'Ø­ÙØ¸',
                'cancel': 'Ø¥Ù„ØºØ§Ø¡',
                'edit': 'ØªØ¹Ø¯ÙŠÙ„',
                'delete': 'Ø­Ø°Ù',
                'add': 'Ø¥Ø¶Ø§ÙØ©',
                'search': 'Ø¨Ø­Ø«',
                'print': 'Ø·Ø¨Ø§Ø¹Ø©',
                'view': 'Ø¹Ø±Ø¶',
                'name': 'Ø§Ù„Ø§Ø³Ù…',
                'actions': 'Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª',
                'date': 'Ø§Ù„ØªØ§Ø±ÙŠØ®',
                'notes': 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª',
                'quantity': 'Ø§Ù„ÙƒÙ…ÙŠØ©',
                'unit': 'Ø§Ù„ÙˆØ­Ø¯Ø©',
                'total': 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ',
                'close': 'Ø¥ØºÙ„Ø§Ù‚',
                
                // Menu items
                'dashboard': 'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…',
                'materials': 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯',
                'warehouses': 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª',
                'workSites': 'Ø¥Ø¯Ø§Ø±Ø© Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù…Ù„',
                'workSiteGroups': 'Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù…Ù„',
                'suppliers': 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø²ÙˆØ¯ÙŠÙ†',
                'units': 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆØ­Ø¯Ø§Øª',
                'receive': 'Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…',
                'deliver': 'Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…',
                'return': 'Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ù…Ù† Ù…ÙˆÙ‚Ø¹ Ø¹Ù…Ù„',
                'inventory': 'ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†',
                'inventoryVerification': 'Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØµÙŠØ§Ù†ØªÙ‡',
                'reports': 'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±',
                'users': 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†',
                'systemTitle': 'Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø®Ø²ÙˆÙ†',
                
                // Titles
                'addMaterial': 'Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©',
                'editMaterial': 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ø§Ø¯Ø©',
                'addWarehouse': 'Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙˆØ¯Ø¹ Ø¬Ø¯ÙŠØ¯',
                'editWarehouse': 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªÙˆØ¯Ø¹',
                'addWorkSite': 'Ø¥Ø¶Ø§ÙØ© Ù…ÙˆÙ‚Ø¹ Ø¹Ù…Ù„ Ø¬Ø¯ÙŠØ¯',
                'editWorkSite': 'ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆÙ‚Ø¹ Ø¹Ù…Ù„',
                'addSupplier': 'Ø¥Ø¶Ø§ÙØ© Ù…Ø²ÙˆØ¯ Ø¬Ø¯ÙŠØ¯',
                'editSupplier': 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ø²ÙˆØ¯',
                'addUnit': 'Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©',
                'editUnit': 'ØªØ¹Ø¯ÙŠÙ„ ÙˆØ­Ø¯Ø©',
                'addUser': 'Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯',
                'editUser': 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…',
                'addReceive': 'Ø¥Ø¶Ø§ÙØ© Ø§Ø³ØªÙ„Ø§Ù… Ø¬Ø¯ÙŠØ¯',
                'editReceive': 'ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ø³ØªÙ„Ø§Ù…',
                'addDeliver': 'Ø¥Ø¶Ø§ÙØ© ØªØ³Ù„ÙŠÙ… Ø¬Ø¯ÙŠØ¯',
                'editDeliver': 'ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© ØªØ³Ù„ÙŠÙ…',
                'addReturn': 'Ø¥Ø¶Ø§ÙØ© Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø¬Ø¯ÙŠØ¯',
                'editReturn': 'ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ø³ØªØ±Ø¯Ø§Ø¯',
                
                // Messages
                'saveSuccess': 'ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­',
                'deleteSuccess': 'ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­',
                'deleteConfirm': 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ',
                'error': 'Ø­Ø¯Ø« Ø®Ø·Ø£',
                'required': 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ Ù…Ø·Ù„ÙˆØ¨',
                'invalidEmail': 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­',
                'passwordTooShort': 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„',
                'loginSuccess': 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­',
                'logoutSuccess': 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­',
                
                // Table headers and labels
                'code': 'Ø§Ù„ÙƒÙˆØ¯',
                'materialName': 'Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©',
                'secondName': 'Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ',
                'category': 'Ø§Ù„ÙØ¦Ø©',
                'baseUnit': 'Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©',
                'subUnit': 'Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ©',
                'conversion': 'Ø§Ù„ØªØ¹Ø§Ø¯Ù„',
                'conversionType': 'Ù†ÙˆØ¹ Ø§Ù„ØªØ¹Ø§Ø¯Ù„',
                'minStock': 'Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰',
                'description': 'Ø§Ù„ÙˆØµÙ',
                'location': 'Ø§Ù„Ù…ÙˆÙ‚Ø¹',
                'manager': 'Ø§Ù„Ù…Ø¯ÙŠØ±',
                'status': 'Ø§Ù„Ø­Ø§Ù„Ø©',
                'address': 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†',
                'type': 'Ø§Ù„Ù†ÙˆØ¹',
                'phone': 'Ø§Ù„Ù‡Ø§ØªÙ',
                'supplier': 'Ø§Ù„Ù…Ø²ÙˆØ¯',
                'warehouse': 'Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹',
                'workSite': 'Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„',
                'number': 'Ø§Ù„Ø±Ù‚Ù…',
                'invoice': 'Ø§Ù„Ø¥ÙŠØµØ§Ù„',
                'itemsCount': 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯',
                'active': 'Ù†Ø´Ø·',
                'inactive': 'ØºÙŠØ± Ù†Ø´Ø·',
                'normal': 'Ø·Ø¨ÙŠØ¹ÙŠ',
                'low': 'Ù…Ù†Ø®ÙØ¶',
                'allWarehouses': 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª',
                'allMaterials': 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯',
                'allWorkSites': 'Ø¬Ù…ÙŠØ¹ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù…Ù„',
                'selectWarehouse': 'Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹',
                'selectWorkSite': 'Ø§Ø®ØªØ± Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„',
                'selectMaterial': 'Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©',
                'selectCategory': 'Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø©',
                'selectBaseUnit': 'Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©',
                'selectSubUnit': 'Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø© ÙØ±Ø¹ÙŠØ©',
                'enterEmail': 'Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ',
                'enterPassword': 'Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±',
                'searchMaterial': 'Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø§Ø¯Ø©...',
                'searchSupplier': 'Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø²ÙˆØ¯...',
                'searchReceives': 'Ø¨Ø­Ø« ÙÙŠ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…...',
                'searchDelivers': 'Ø¨Ø­Ø« ÙÙŠ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…...',
                'searchReturns': 'Ø¨Ø­Ø« ÙÙŠ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯...',
                'secondNamePlaceholder': 'Ø§Ø³Ù… Ø¨Ø¯ÙŠÙ„ Ø£Ùˆ Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„Ù…Ø§Ø¯Ø©',
                'conversionPlaceholder': 'Ù…Ø«Ø§Ù„: 12',
                'autoGenerated': 'ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹',
                'noAccess': 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…',
            },
            en: {
                // Common
                'logout': 'Logout',
                'login': 'Login',
                'email': 'Email',
                'password': 'Password',
                'save': 'Save',
                'cancel': 'Cancel',
                'edit': 'Edit',
                'delete': 'Delete',
                'add': 'Add',
                'search': 'Search',
                'print': 'Print',
                'view': 'View',
                'name': 'Name',
                'actions': 'Actions',
                'date': 'Date',
                'notes': 'Notes',
                'quantity': 'Quantity',
                'unit': 'Unit',
                'total': 'Total',
                'close': 'Close',
                
                // Menu items
                'dashboard': 'Dashboard',
                'materials': 'Materials Management',
                'warehouses': 'Warehouses Management',
                'workSites': 'Work Sites Management',
                'workSiteGroups': 'Work Site Groups',
                'suppliers': 'Suppliers Management',
                'units': 'Units Management',
                'receive': 'Receive Operations',
                'deliver': 'Deliver Operations',
                'return': 'Return Operations',
                'inventory': 'Inventory Tracking',
                'inventoryVerification': 'Inventory Verification & Maintenance',
                'reports': 'Reports',
                'users': 'Users Management',
                'systemTitle': 'Inventory System',
                
                // Titles
                'addMaterial': 'Add New Material',
                'editMaterial': 'Edit Material',
                'addWarehouse': 'Add New Warehouse',
                'editWarehouse': 'Edit Warehouse',
                'addWorkSite': 'Add New Work Site',
                'editWorkSite': 'Edit Work Site',
                'addSupplier': 'Add New Supplier',
                'editSupplier': 'Edit Supplier',
                'addUnit': 'Add New Unit',
                'editUnit': 'Edit Unit',
                'addUser': 'Add New User',
                'editUser': 'Edit User',
                'addReceive': 'Add New Receive',
                'editReceive': 'Edit Receive Operation',
                'addDeliver': 'Add New Deliver',
                'editDeliver': 'Edit Deliver Operation',
                'addReturn': 'Add New Return',
                'editReturn': 'Edit Return Operation',
                
                // Messages
                'saveSuccess': 'Saved successfully',
                'deleteSuccess': 'Deleted successfully',
                'deleteConfirm': 'Are you sure you want to delete?',
                'error': 'An error occurred',
                'required': 'This field is required',
                'invalidEmail': 'Invalid email',
                'passwordTooShort': 'Password must be at least 6 characters',
                'loginSuccess': 'Logged in successfully',
                'logoutSuccess': 'Logged out successfully',
                
                // Table headers and labels
                'code': 'Code',
                'materialName': 'Material Name',
                'secondName': 'Second Name',
                'category': 'Category',
                'baseUnit': 'Base Unit',
                'subUnit': 'Sub Unit',
                'conversion': 'Conversion',
                'conversionType': 'Conversion Type',
                'minStock': 'Min Stock',
                'description': 'Description',
                'location': 'Location',
                'manager': 'Manager',
                'status': 'Status',
                'address': 'Address',
                'type': 'Type',
                'phone': 'Phone',
                'supplier': 'Supplier',
                'warehouse': 'Warehouse',
                'workSite': 'Work Site',
                'number': 'Number',
                'invoice': 'Invoice',
                'itemsCount': 'Items Count',
                'active': 'Active',
                'inactive': 'Inactive',
                'normal': 'Normal',
                'low': 'Low',
                'allWarehouses': 'All Warehouses',
                'allMaterials': 'All Materials',
                'allWorkSites': 'All Work Sites',
                'selectWarehouse': 'Select Warehouse',
                'selectWorkSite': 'Select Work Site',
                'selectMaterial': 'Select Material',
                'selectCategory': 'Select Category',
                'selectBaseUnit': 'Select Base Unit',
                'selectSubUnit': 'No Sub Unit',
                'enterEmail': 'Enter your email',
                'enterPassword': 'Enter your password',
                'searchMaterial': 'Search for material...',
                'searchSupplier': 'Search for supplier...',
                'searchReceives': 'Search in receive operations...',
                'searchDelivers': 'Search in deliver operations...',
                'searchReturns': 'Search in return operations...',
                'secondNamePlaceholder': 'Alternative or additional name for material',
                'conversionPlaceholder': 'Example: 12',
                'autoGenerated': 'Code is automatically generated',
                'noAccess': 'You do not have permission to access this section',
            }
        };
        
        window.t = function(key) {
            return translations[window.currentLanguage]?.[key] || key;
        };
        
        // Format date using Gregorian calendar with English numerals
        window.formatDate = function(date) {
            if (!date) return '-';
            try {
                const dateObj = date.toDate ? date.toDate() : new Date(date);
                if (isNaN(dateObj.getTime())) return '-';
                // Use 'en-US' locale to force Gregorian calendar and English numerals
                return dateObj.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            } catch (e) {
                return '-';
            }
        };
        
        // Format date with time using Gregorian calendar with English numerals
        window.formatDateTime = function(date) {
            if (!date) return '-';
            try {
                const dateObj = date.toDate ? date.toDate() : new Date(date);
                if (isNaN(dateObj.getTime())) return '-';
                // Use 'en-US' locale to force Gregorian calendar and English numerals
                return dateObj.toLocaleString('en-US', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return '-';
            }
        };
        
        window.toggleLanguage = function() {
            window.currentLanguage = window.currentLanguage === 'ar' ? 'en' : 'ar';
            localStorage.setItem('appLanguage', window.currentLanguage);
            applyLanguage();
            updateLangToggleButton();
        };
        
        function updateLangToggleButton() {
            const btn = document.getElementById('langToggle');
            if (btn) {
                btn.textContent = window.currentLanguage === 'ar' ? 'English' : 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©';
            }
        }
        
        function applyLanguage() {
            // Update HTML direction
            document.documentElement.dir = window.currentLanguage === 'ar' ? 'rtl' : 'ltr';
            document.documentElement.lang = window.currentLanguage === 'ar' ? 'ar' : 'en';
            
            // Update menu items
            const menuItems = document.querySelectorAll('.menu-item');
            const menuKeys = ['dashboard', 'materials', 'warehouses', 'workSites', 'workSiteGroups', 'suppliers', 'units', 'receive', 'deliver', 'return', 'inventory', 'inventoryVerification', 'reports', 'users'];
            menuItems.forEach((item, index) => {
                if (index < menuKeys.length) {
                    const textNode = Array.from(item.childNodes).find(node => node.nodeType === 3 && node.textContent.trim());
                    if (textNode) {
                        textNode.textContent = ' ' + window.t(menuKeys[index]);
                    }
                }
            });
            
            // Update system title
            const systemTitle = document.querySelector('.sidebar-header h2');
            if (systemTitle) {
                systemTitle.textContent = window.t('systemTitle');
            }
            
            // Update logout button
            const logoutBtn = document.querySelector('button[onclick="logout()"]');
            if (logoutBtn) {
                logoutBtn.textContent = window.t('logout');
            }
            
            // Update page title if exists
            const pageTitle = document.getElementById('pageTitle');
            if (pageTitle && window.currentSection) {
                pageTitle.textContent = window.t(window.currentSection) || pageTitle.textContent;
            }
            
            // Update section headings (h2 in sections) - only for visible sections
            const sectionHeadings = {
                'materials': { selector: '#materials h2', key: 'materials' },
                'warehouses': { selector: '#warehouses h2', key: 'warehouses' },
                'workSites': { selector: '#workSites h2', key: 'workSites' },
                'workSiteGroups': { selector: '#workSiteGroups h2', key: 'workSiteGroups' },
                'suppliers': { selector: '#suppliers h2', key: 'suppliers' },
                'units': { selector: '#units h2', key: 'units' },
                'receive': { selector: '#receive h2', key: 'receive' },
                'deliver': { selector: '#deliver h2', key: 'deliver' },
                'return': { selector: '#return h2', key: 'return' },
                'inventory': { selector: '#inventory h2', key: 'inventory' },
                'inventoryVerification': { selector: '#inventoryVerification h2', key: 'inventoryVerification' },
                'reports': { selector: '#reports h2', key: 'reports' },
                'users': { selector: '#users h2', key: 'users' }
            };
            
            Object.keys(sectionHeadings).forEach(sectionKey => {
                const heading = document.querySelector(sectionHeadings[sectionKey].selector);
                if (heading) {
                    // Only update if it's a direct text content (not containing buttons)
                    if (!heading.querySelector('button')) {
                        heading.textContent = window.t(sectionHeadings[sectionKey].key);
                    }
                }
            });
            
            // Update common buttons (Save, Cancel) in modals
            document.querySelectorAll('button[type="submit"]').forEach(btn => {
                const text = btn.textContent.trim();
                if (text === 'Ø­ÙØ¸' || text === 'Save') {
                    btn.textContent = window.t('save');
                } else if (text === 'Ø¥Ù„ØºØ§Ø¡' || text === 'Cancel') {
                    btn.textContent = window.t('cancel');
                }
            });
            
            document.querySelectorAll('button[type="button"]').forEach(btn => {
                const text = btn.textContent.trim();
                if (text === 'Ø¥Ù„ØºØ§Ø¡' || text === 'Cancel') {
                    if (btn.onclick && btn.onclick.toString().includes('closeModal')) {
                        btn.textContent = window.t('cancel');
                    }
                }
            });
            
            // Reload current section to update all content with new language
            if (window.currentSection) {
                // Store the current section ID
                const currentSectionId = window.currentSection;
                // Reload the section data without changing the active section
                if (currentSectionId === 'dashboard' && typeof loadDashboard === 'function') {
                    loadDashboard();
                } else if (currentSectionId === 'materials' && typeof loadMaterials === 'function') {
                    loadMaterials();
                } else if (currentSectionId === 'warehouses' && typeof loadWarehouses === 'function') {
                    loadWarehouses();
                } else if (currentSectionId === 'workSites' && typeof loadWorkSites === 'function') {
                    loadWorkSites();
                } else if (currentSectionId === 'workSiteGroups' && typeof loadWorkSiteGroups === 'function') {
                    loadWorkSiteGroups();
                } else if (currentSectionId === 'suppliers' && typeof loadSuppliers === 'function') {
                    loadSuppliers();
                } else if (currentSectionId === 'units' && typeof loadUnits === 'function') {
                    loadUnits();
                } else if (currentSectionId === 'receive' && typeof loadReceives === 'function') {
                    loadReceives();
                } else if (currentSectionId === 'deliver' && typeof loadDelivers === 'function') {
                    loadDelivers();
                } else if (currentSectionId === 'return' && typeof window.loadReturns === 'function') {
                    window.loadReturns();
                } else if (currentSectionId === 'inventory' && typeof window.loadInventory === 'function') {
                    window.loadInventory();
                } else if (currentSectionId === 'inventoryVerification' && typeof window.loadInventoryVerificationSection === 'function') {
                    window.loadInventoryVerificationSection();
                } else if (currentSectionId === 'reports' && typeof window.loadReportsSection === 'function') {
                    window.loadReportsSection();
                } else if (currentSectionId === 'users' && typeof loadUsers === 'function') {
                    loadUsers();
                }
            }
        }

        // Initialize app data
        async function initializeAppData() {
            // Set default section
            window.currentSection = 'dashboard';
            // Apply saved language preference
            applyLanguage();
            updateLangToggleButton();
            // Load permissions first
            await loadCurrentUserPermissions();
            await loadUnits();
            await loadMaterials();
            await loadWarehouses();
            await loadWorkSites();
            await loadSuppliers();
            await loadUsers();
            await loadDashboard();
            setupFormListeners();
            // Update UI based on permissions
            updateManagementButtonsVisibility();
        }
        
        // Update visibility of management buttons based on permissions
        function updateManagementButtonsVisibility() {
            if (!window.currentUserPermissions) {
                console.log('No permissions loaded, hiding all management buttons');
                // Hide all buttons if no permissions
                document.querySelectorAll('button[onclick*="Modal()"]').forEach(btn => {
                    if (btn.onclick && btn.onclick.toString().includes('show') && btn.onclick.toString().includes('Modal')) {
                        btn.style.display = 'none';
                    }
                });
                return;
            }
            
            const isAdmin = window.currentUserPermissions.isAdmin;
            const canManageMaterials = isAdmin || (window.currentUserPermissions.canManageMaterials === true);
            const canManageWarehouses = isAdmin || (window.currentUserPermissions.canManageWarehouses === true);
            const canManageWorkSites = isAdmin || (window.currentUserPermissions.canManageWorkSites === true);
            const canManageSuppliers = isAdmin || (window.currentUserPermissions.canManageSuppliers === true);
            const canManageUnits = isAdmin || (window.currentUserPermissions.canManageUnits === true);
            
            // Materials
            const materialAddBtn = document.querySelector('button[onclick="showMaterialModal()"]');
            if (materialAddBtn) {
                materialAddBtn.style.display = canManageMaterials ? 'inline-block' : 'none';
            }
            
            // Warehouses
            const warehouseAddBtn = document.querySelector('button[onclick="showWarehouseModal()"]');
            if (warehouseAddBtn) {
                warehouseAddBtn.style.display = canManageWarehouses ? 'inline-block' : 'none';
            }
            
            // Work Sites
            const workSiteAddBtn = document.querySelector('button[onclick="showWorkSiteModal()"]');
            if (workSiteAddBtn) {
                workSiteAddBtn.style.display = canManageWorkSites ? 'inline-block' : 'none';
            }
            
            // Suppliers
            const supplierAddBtn = document.querySelector('button[onclick="showSupplierModal()"]');
            if (supplierAddBtn) {
                supplierAddBtn.style.display = canManageSuppliers ? 'inline-block' : 'none';
            }
            
            // Units
            const unitAddBtn = document.querySelector('button[onclick="showUnitModal()"]');
            if (unitAddBtn) {
                unitAddBtn.style.display = canManageUnits ? 'inline-block' : 'none';
            }
            
            // Receive / Deliver / Return add buttons
            const canAddReceive = isAdmin || (window.currentUserPermissions.receiveAdd === true);
            const canAddDeliver = isAdmin || (window.currentUserPermissions.deliverAdd === true);
            const canAddReturn = isAdmin || (window.currentUserPermissions.returnAdd === true);
            const receiveAddBtn = document.getElementById('receiveAddBtn');
            const deliverAddBtn = document.getElementById('deliverAddBtn');
            const returnAddBtn = document.getElementById('returnAddBtn');
            if (receiveAddBtn) receiveAddBtn.style.display = canAddReceive ? 'inline-block' : 'none';
            if (deliverAddBtn) deliverAddBtn.style.display = canAddDeliver ? 'inline-block' : 'none';
            if (returnAddBtn) returnAddBtn.style.display = canAddReturn ? 'inline-block' : 'none';
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØµÙŠØ§Ù†ØªÙ‡: Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ù†ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ù…Ø¯ÙŠØ± Ø£Ùˆ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø© ÙÙ‚Ø·
            const hasFullPermissions = isAdmin || (window.currentUserPermissions.permissionType === 'full');
            const inventoryVerificationMenuItems = document.querySelectorAll('.menu-item[onclick*="inventoryVerification"]');
            inventoryVerificationMenuItems.forEach(el => {
                el.style.display = hasFullPermissions ? '' : 'none';
            });
            
            // Note: We don't call display functions here to avoid infinite loops
            // Display functions are called separately when needed (e.g., in loadMaterials, loadWarehouses, etc.)
        }

        // Show alert
        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = 'alert alert-' + type + ' show';
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }

        function showModalAlert(modalId, message, type) {
            const alertId = modalId + 'Alert';
            const alertEl = document.getElementById(alertId);
            if (!alertEl) return;
            alertEl.textContent = message;
            alertEl.className = 'alert alert-' + type + ' modal-alert show';
            alertEl.style.display = 'block';
            setTimeout(() => {
                alertEl.classList.remove('show');
                alertEl.style.display = 'none';
            }, 5000);
        }

        function showLoginAlert(message, type) {
            const alert = document.getElementById('loginAlert');
            alert.textContent = message;
            alert.className = 'alert alert-' + type + ' show';
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }

        // Section navigation
        window.showSection = async function(sectionId, event) {
            // Store current section for language updates
            window.currentSection = sectionId;
            
            const hasFullPermissions = window.currentUserPermissions && (window.currentUserPermissions.isAdmin || window.currentUserPermissions.permissionType === 'full');
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØµÙŠØ§Ù†ØªÙ‡: Ù„Ù„Ù…Ø¯ÙŠØ± Ø£Ùˆ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø© ÙÙ‚Ø·
            if (sectionId === 'inventoryVerification') {
                if (!hasFullPermissions) {
                    showAlert('ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø¯ÙŠØ± Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‚Ø³Ù… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØµÙŠØ§Ù†ØªÙ‡.', 'error');
                    return;
                }
            }
            
            // Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø­Ù…ÙŠØ© Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±: Ø¥Ù„ØºØ§Ø¡ Ø·Ù„Ø¨ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù…Ù† Ù„Ø¯ÙŠÙ‡ ØµÙ„Ø§Ø­ÙŠØ§Øª ÙƒØ§Ù…Ù„Ø©
            if (sectionId === 'users') {
                if (!hasFullPermissions) {
                    checkUsersPassword();
                    return;
                }
            } else if (sectionId === 'activityLog') {
                if (!hasFullPermissions) {
                    checkActivityLogPassword();
                    return;
                }
            } else if (sectionId === 'reports') {
                if (!hasFullPermissions) {
                    checkReportsPassword();
                    return;
                }
            } else if (sectionId === 'inventory') {
                if (!hasFullPermissions) {
                    checkInventoryPassword();
                    return;
                }
            }
            
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            // Remove active from all menu items
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            // Add active to clicked menu item
            if (event && event.target) {
                event.target.closest('.menu-item').classList.add('active');
            } else {
                // Find menu item by section ID
                const menuItems = document.querySelectorAll('.menu-item');
                const menuKeys = ['dashboard', 'materials', 'warehouses', 'workSites', 'workSiteGroups', 'suppliers', 'units', 'receive', 'deliver', 'return', 'inventory', 'inventoryVerification', 'reports', 'users', 'activityLog'];
                const index = menuKeys.indexOf(sectionId);
                if (index >= 0 && menuItems[index]) {
                    menuItems[index].classList.add('active');
                }
            }

            // Update page title using translations
            document.getElementById('pageTitle').textContent = window.t(sectionId) || sectionId;

            // Load section data
            if (sectionId === 'dashboard') {
                loadDashboard();
            } else if (sectionId === 'inventory') {
                loadInventory();
            } else if (sectionId === 'reports') {
                loadReportsSection();
            } else if (sectionId === 'receive') {
                loadReceives();
            } else if (sectionId === 'deliver') {
                loadDelivers();
            } else if (sectionId === 'return') {
                loadReturns();
            } else if (sectionId === 'activityLog') {
                await loadActivityLog();
} else if (sectionId === 'workSiteGroups') {
                loadWorkSiteGroups();
            } else if (sectionId === 'inventoryVerification') {
                loadInventoryVerificationSection();
            }

            // Note: updateManagementButtonsVisibility() is called by each load function after data is loaded
            // No need to call it here to avoid duplicate calls and timing conflicts
        };

        // Modal functions
        window.closeModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
                
                // Remove dynamically created modals from DOM
                const dynamicModals = ['receiveDetailsModal', 'deliverDetailsModal', 'returnDetailsModal'];
                if (dynamicModals.includes(modalId)) {
                    // Use setTimeout to allow animation to complete before removing
                    setTimeout(() => {
                        if (modal && modal.parentNode) {
                            modal.remove();
                        }
                    }, 300);
                }
            }
            
            // Reset editing IDs
            if (modalId === 'materialModal' || modalId === 'unitModal' || modalId === 'warehouseModal' || 
                modalId === 'workSiteModal' || modalId === 'workSiteGroupModal' || modalId === 'supplierModal') {
                window.editingId = null;
                window.editingWorkSiteGroupId = null;
            }
            if (modalId === 'receiveModal') {
                window.editingReceiveId = null;
            }
            if (modalId === 'deliverModal') {
                window.editingDeliverId = null;
            }
            if (modalId === 'returnModal') {
                window.editingReturnId = null;
            }
        };

        // Setup form listeners
        function setupFormListeners() {
            document.getElementById('materialForm').addEventListener('submit', saveMaterial);
            document.getElementById('warehouseForm').addEventListener('submit', saveWarehouse);
            document.getElementById('workSiteForm').addEventListener('submit', saveWorkSite);
            document.getElementById('workSiteGroupForm').addEventListener('submit', saveWorkSiteGroup);
            document.getElementById('supplierForm').addEventListener('submit', saveSupplier);
            document.getElementById('unitForm').addEventListener('submit', saveUnit);
            document.getElementById('receiveForm').addEventListener('submit', saveReceive);
            document.getElementById('deliverForm').addEventListener('submit', saveDeliver);
            document.getElementById('returnForm').addEventListener('submit', saveReturn);
            const userForm = document.getElementById('userForm');
            if (userForm) {
                userForm.addEventListener('submit', saveUser);
            }
        }

        // ========== UNITS MANAGEMENT ==========
        window.units = [];

        // Update conversion examples interactively
        function updateConversionExamples() {
            const baseUnit = document.getElementById('materialUnit')?.value || '';
            const subUnit = document.getElementById('materialSubUnit')?.value || '';
            const conversion = document.getElementById('materialConversion')?.value || '';
            const conversionType = document.getElementById('materialConversionType')?.value || '';
            
            const baseUnitText = baseUnit || 'ÙˆØ­Ø¯Ø© Ø£Ø³Ø§Ø³ÙŠØ©';
            const subUnitText = subUnit || 'ÙˆØ­Ø¯Ø© ÙØ±Ø¹ÙŠØ©';
            const conversionValue = conversion || '12';
            
            const multiplyExample = document.getElementById('multiplyExample');
            const divideExample = document.getElementById('divideExample');
            const noConversionExample = document.getElementById('noConversionExample');
            const multiplyText = document.getElementById('multiplyText');
            const divideText = document.getElementById('divideText');
            
            if (baseUnit && subUnit && conversion && conversionType) {
                // Hide no conversion message
                if (noConversionExample) noConversionExample.style.display = 'none';
                
                if (conversionType === 'multiply') {
                    // Ø¶Ø±Ø¨: 1 ÙˆØ­Ø¯Ø© ÙØ±Ø¹ÙŠØ© = Ø§Ù„ØªØ¹Ø§Ø¯Ù„ Ã— ÙˆØ­Ø¯Ø© Ø£Ø³Ø§Ø³ÙŠØ©
                    if (multiplyExample) multiplyExample.style.display = 'block';
                    if (divideExample) divideExample.style.display = 'none';
                    if (multiplyText) {
                        multiplyText.innerHTML = `1 <strong>${subUnitText}</strong> = <strong>${conversionValue}</strong> Ã— <strong>${baseUnitText}</strong>`;
                    }
                } else if (conversionType === 'divide') {
                    // Ù‚Ø³Ù…Ø©: Ø§Ù„ØªØ¹Ø§Ø¯Ù„ ÙˆØ­Ø¯Ø© ÙØ±Ø¹ÙŠØ© = 1 ÙˆØ­Ø¯Ø© Ø£Ø³Ø§Ø³ÙŠØ©
                    if (multiplyExample) multiplyExample.style.display = 'none';
                    if (divideExample) divideExample.style.display = 'block';
                    if (divideText) {
                        divideText.innerHTML = `<strong>${conversionValue}</strong> <strong>${subUnitText}</strong> = 1 <strong>${baseUnitText}</strong>`;
                    }
                }
            } else {
                // Show no conversion message
                if (multiplyExample) multiplyExample.style.display = 'none';
                if (divideExample) divideExample.style.display = 'none';
                if (noConversionExample) noConversionExample.style.display = 'block';
            }
        }

        async function loadUnits() {
            try {
                const unitsRef = collection(db, 'units');
                const snapshot = await getDocs(unitsRef);
                window.units = [];
                snapshot.forEach((docSnapshot) => {
                    window.units.push({ id: docSnapshot.id, ...docSnapshot.data() });
                });

                displayUnits();
                
                // Populate unit selects
                const materialUnit = document.getElementById('materialUnit');
                const materialSubUnit = document.getElementById('materialSubUnit');
                
                if (materialUnit) {
                    const currentBaseValue = materialUnit.value;
                    materialUnit.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</option>';
                    window.units.forEach(unit => {
                        const option = document.createElement('option');
                        option.value = unit.name;
                        option.textContent = `${unit.name} (${unit.type})`;
                        materialUnit.appendChild(option);
                    });
                    materialUnit.value = currentBaseValue;
                    
                    // Update subUnit when baseUnit changes
                    if (!materialUnit.hasAttribute('data-listener-added')) {
                        materialUnit.setAttribute('data-listener-added', 'true');
                        materialUnit.addEventListener('change', function() {
                            updateSubUnitOptions(this.value);
                            updateConversionExamples();
                        });
                    }
                }
                
                if (materialSubUnit) {
                    updateSubUnitOptions(materialUnit ? materialUnit.value : '');
                    const currentSubValue = materialSubUnit.value;
                    materialSubUnit.value = currentSubValue;
                    
                    // Enable/disable conversion fields
                    if (!materialSubUnit.hasAttribute('data-listener-added')) {
                        materialSubUnit.setAttribute('data-listener-added', 'true');
                        materialSubUnit.addEventListener('change', function() {
                            const conversionInput = document.getElementById('materialConversion');
                            const conversionType = document.getElementById('materialConversionType');
                            if (this.value) {
                                conversionInput.disabled = false;
                                conversionType.disabled = false;
                            } else {
                                conversionInput.disabled = true;
                                conversionType.disabled = true;
                                conversionInput.value = '';
                            }
                            updateConversionExamples();
                        });
                    }
                    
                    // Add listeners for conversion and conversion type
                    const conversionInput = document.getElementById('materialConversion');
                    const conversionTypeSelect = document.getElementById('materialConversionType');
                    
                    if (conversionInput && !conversionInput.hasAttribute('data-listener-added')) {
                        conversionInput.setAttribute('data-listener-added', 'true');
                        conversionInput.addEventListener('input', updateConversionExamples);
                        conversionInput.addEventListener('change', updateConversionExamples);
                    }
                    
                    if (conversionTypeSelect && !conversionTypeSelect.hasAttribute('data-listener-added')) {
                        conversionTypeSelect.setAttribute('data-listener-added', 'true');
                        conversionTypeSelect.addEventListener('change', updateConversionExamples);
                    }
                }
                
                function updateSubUnitOptions(excludeUnit) {
                    if (!materialSubUnit) return;
                    const currentValue = materialSubUnit.value;
                    materialSubUnit.innerHTML = '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø© ÙØ±Ø¹ÙŠØ©</option>';
                    window.units.forEach(unit => {
                        if (unit.name !== excludeUnit) {
                            const option = document.createElement('option');
                            option.value = unit.name;
                            option.textContent = `${unit.name} (${unit.type})`;
                            materialSubUnit.appendChild(option);
                        }
                    });
                    // Restore value if still valid
                    if (currentValue && currentValue !== excludeUnit) {
                        materialSubUnit.value = currentValue;
                    } else {
                        materialSubUnit.value = '';
                        document.getElementById('materialConversion').disabled = true;
                        document.getElementById('materialConversionType').disabled = true;
                    }
                    // Update examples
                    updateConversionExamples();
                }
                
                // Update buttons visibility after loading and displaying units
                updateManagementButtonsVisibility();
            } catch (error) {
                console.error('Error loading units:', error);
            }
        }

        function displayUnits() {
            const tbody = document.getElementById('unitsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            window.units.forEach(unit => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${unit.code || '-'}</td>
                    <td>${unit.name}</td>
                    <td>${unit.type || '-'}</td>
                    <td>${unit.description || '-'}</td>
                    <td>
                        ${(!window.currentUserPermissions || window.currentUserPermissions.isAdmin || window.currentUserPermissions.canManageUnits) ? `
                            <button class="btn btn-success btn-small" onclick="showUnitModal('${unit.id}')">${window.t('edit')}</button>
                            <button class="btn btn-danger btn-small" onclick="deleteUnit('${unit.id}')">${window.t('delete')}</button>
                        ` : '<span style="color: #999;">-</span>'}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Generate automatic unit code
        async function generateUnitCode(unitType) {
            const typePrefix = {
                'ÙˆØ²Ù†': 'W',
                'Ø·ÙˆÙ„': 'L',
                'Ø­Ø¬Ù…': 'V',
                'Ø¹Ø¯Ø¯': 'C',
                'Ø£Ø®Ø±Ù‰': 'O'
            };
            
            const prefix = typePrefix[unitType] || 'U';
            
            // Find all units with same type and extract their numbers
            const unitsOfSameType = window.units.filter(u => u.type === unitType && u.code);
            const existingNumbers = [];
            
            unitsOfSameType.forEach(unit => {
                if (unit.code && unit.code.startsWith(prefix + '-')) {
                    const numberPart = unit.code.replace(prefix + '-', '');
                    const num = parseInt(numberPart);
                    if (!isNaN(num)) {
                        existingNumbers.push(num);
                    }
                }
            });
            
            // Find the next available number
            let nextNumber = 1;
            if (existingNumbers.length > 0) {
                const maxNumber = Math.max(...existingNumbers);
                nextNumber = maxNumber + 1;
            }
            
            return `${prefix}-${nextNumber.toString().padStart(3, '0')}`;
        }

        window.showUnitModal = async function(unitId = null) {
            // Check permissions
            if (!window.currentUserPermissions || (!window.currentUserPermissions.isAdmin && !window.currentUserPermissions.canManageUnits)) {
                showAlert(window.t('noAccess'), 'error');
                return;
            }
            
            window.editingId = unitId;
            const modal = document.getElementById('unitModal');
            const form = document.getElementById('unitForm');
            
            // Ensure units are loaded
            if (!window.units || window.units.length === 0) {
                await loadUnits();
            }
            
            if (unitId) {
                const unit = window.units.find(u => u.id === unitId);
                if (unit) {
                    document.getElementById('unitModalTitle').textContent = window.t('editUnit');
                    document.getElementById('unitCode').value = unit.code || '';
                    document.getElementById('unitName').value = unit.name;
                    document.getElementById('unitType').value = unit.type;
                    document.getElementById('unitDescription').value = unit.description || '';
                }
            } else {
                document.getElementById('unitModalTitle').textContent = window.t('addUnit');
                form.reset();
                document.getElementById('unitCode').value = '';
                
                // Generate code when type is selected
                const unitTypeSelect = document.getElementById('unitType');
                const unitCodeInput = document.getElementById('unitCode');
                
                if (unitTypeSelect && unitCodeInput) {
                    // Remove all existing event listeners by cloning
                    const newSelect = unitTypeSelect.cloneNode(true);
                    unitTypeSelect.parentNode.replaceChild(newSelect, unitTypeSelect);
                    
                    // Add new event listener
                    newSelect.addEventListener('change', async function() {
                        if (this.value && !window.editingId) {
                            const code = await generateUnitCode(this.value);
                            unitCodeInput.value = code;
                        }
                    });
                }
            }
            modal.classList.add('active');
        };

        async function saveUnit(e) {
            e.preventDefault();
            
            // Check permissions
            if (!window.currentUserPermissions || (!window.currentUserPermissions.isAdmin && !window.currentUserPermissions.canManageUnits)) {
                showAlert(window.t('noAccess'), 'error');
                return;
            }
            
            const { addDoc, updateDoc, doc, collection, serverTimestamp } = window.firebaseCollections;
            const db = window.firebaseDb;

            let unitCode = document.getElementById('unitCode').value;
            const unitType = document.getElementById('unitType').value;
            
            // If no code provided, generate one
            if (!unitCode) {
                unitCode = await generateUnitCode(unitType);
            }

            // Check if code already exists (when adding new unit)
            if (!window.editingId) {
                const existingUnit = window.units.find(u => u.code === unitCode);
                if (existingUnit) {
                    // If code exists, generate a new one
                    unitCode = await generateUnitCode(unitType);
                    document.getElementById('unitCode').value = unitCode;
                }
            }

            const unitData = {
                code: unitCode,
                name: document.getElementById('unitName').value,
                type: unitType,
                description: document.getElementById('unitDescription').value || null
            };

            try {
                if (window.editingId) {
                    const oldUnit = window.units.find(u => u.id === window.editingId);
                    await updateDoc(doc(db, 'units', window.editingId), unitData);
                    await logActivity('update', 'unit', window.editingId, unitData.name, unitData, oldUnit);
                    showAlert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } else {
                    const docRef = await addDoc(collection(db, 'units'), unitData);
                    await logActivity('create', 'unit', docRef.id, unitData.name, unitData);
                    showAlert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                }
                closeModal('unitModal');
                await loadUnits();
                await loadMaterials(); // Refresh materials to update unit dropdown
            } catch (error) {
                console.error('Error saving unit:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø©', 'error');
            }
        }

        window.deleteUnit = async function(unitId) {
            // Check permissions
            if (!window.currentUserPermissions || (!window.currentUserPermissions.isAdmin && !window.currentUserPermissions.canManageUnits)) {
                showAlert(window.t('noAccess'), 'error');
                return;
            }
            if (!confirm(window.t('deleteConfirm'))) return;
            
            // Check if unit is used in materials or transactions
            const isUsed = await isEntityUsedInTransactions('unit', unitId);
            if (isUsed) {
                showAlert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ù…Ø³ØªØ®Ø¯Ù…Ø© ÙÙŠ Ø§Ù„Ù…ÙˆØ§Ø¯', 'error');
                return;
            }
            
            try {
                const { deleteDoc, doc } = window.firebaseCollections;
                const unit = window.units.find(u => u.id === unitId);
                const unitName = unit ? unit.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                await deleteDoc(doc(db, 'units', unitId));
                await logActivity('delete', 'unit', unitId, unitName);
                showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                await loadUnits();
            } catch (error) {
                console.error('Error deleting unit:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø©', 'error');
            }
        };

        // ========== MATERIALS MANAGEMENT ==========
        window.materials = [];

        async function loadMaterials() {
            try {
                const materialsRef = collection(db, 'materials');
                const snapshot = await getDocs(materialsRef);
                window.materials = [];
                snapshot.forEach((docSnapshot) => {
                    window.materials.push({ id: docSnapshot.id, ...docSnapshot.data() });
                });
                displayMaterials();
                // Update buttons visibility after loading and displaying materials
                updateManagementButtonsVisibility();
            } catch (error) {
                console.error('Error loading materials:', error);
            }
        }

        function displayMaterials() {
            const tbody = document.getElementById('materialsTableBody');
            tbody.innerHTML = '';
            window.materials.forEach(material => {
                let conversionText = '-';
                if (material.subUnit && material.conversion) {
                    const conversionType = material.conversionType === 'divide' ? 'Ù‚Ø³Ù…Ø©' : 'Ø¶Ø±Ø¨';
                    conversionText = `${material.conversion} (${conversionType})`;
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${material.code || '-'}</td>
                    <td>${material.name}</td>
                    <td>${material.secondName || '-'}</td>
                    <td>${material.category || '-'}</td>
                    <td>${material.unit || '-'}</td>
                    <td>${material.subUnit || '-'}</td>
                    <td>${conversionText}</td>
                    <td>${material.minStock || 0}</td>
                    <td>
                        ${(!window.currentUserPermissions || window.currentUserPermissions.isAdmin || window.currentUserPermissions.canManageMaterials) ? `
                            <button class="btn btn-success btn-small" onclick="showMaterialModal('${material.id}')">${window.t('edit')}</button>
                            <button class="btn btn-danger btn-small" onclick="deleteMaterial('${material.id}')">${window.t('delete')}</button>
                        ` : '<span style="color: #999;">-</span>'}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        window.filterMaterials = function() {
            const search = document.getElementById('searchMaterials').value.toLowerCase();
            const tbody = document.getElementById('materialsTableBody');
            tbody.innerHTML = '';
            window.materials.filter(m => 
                m.name.toLowerCase().includes(search) || 
                (m.secondName && m.secondName.toLowerCase().includes(search)) ||
                (m.code && m.code.toLowerCase().includes(search))
            ).forEach(material => {
                let conversionText = '-';
                if (material.subUnit && material.conversion) {
                    const conversionType = material.conversionType === 'divide' ? 'Ù‚Ø³Ù…Ø©' : 'Ø¶Ø±Ø¨';
                    conversionText = `${material.conversion} (${conversionType})`;
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${material.code || '-'}</td>
                    <td>${material.name}</td>
                    <td>${material.secondName || '-'}</td>
                    <td>${material.category || '-'}</td>
                    <td>${material.unit || '-'}</td>
                    <td>${material.subUnit || '-'}</td>
                    <td>${conversionText}</td>
                    <td>${material.minStock || 0}</td>
                    <td>
                        ${(!window.currentUserPermissions || window.currentUserPermissions.isAdmin || window.currentUserPermissions.canManageMaterials) ? `
                            <button class="btn btn-success btn-small" onclick="showMaterialModal('${material.id}')">${window.t('edit')}</button>
                            <button class="btn btn-danger btn-small" onclick="deleteMaterial('${material.id}')">${window.t('delete')}</button>
                        ` : '<span style="color: #999;">-</span>'}
                    </td>
                `;
                tbody.appendChild(row);
            });
        };

        // Generate automatic material code
        async function generateMaterialCode() {
            // Ensure materials are loaded
            if (!window.materials || window.materials.length === 0) {
                await loadMaterials();
            }
            
            // Find all existing codes and extract their numbers
            const existingNumbers = [];
            window.materials.forEach(material => {
                if (material.code) {
                    const num = parseInt(material.code);
                    if (!isNaN(num)) {
                        existingNumbers.push(num);
                    }
                }
            });
            
            // Find the next available number starting from 01
            let nextNumber = 1;
            if (existingNumbers.length > 0) {
                const maxNumber = Math.max(...existingNumbers);
                nextNumber = maxNumber + 1;
            }
            
            return nextNumber.toString().padStart(2, '0'); // Format as 01, 02, etc.
        }

        window.showMaterialModal = async function(materialId = null) {
            // Check permissions
            if (!window.currentUserPermissions || (!window.currentUserPermissions.isAdmin && !window.currentUserPermissions.canManageMaterials)) {
                showAlert(window.t('noAccess'), 'error');
                return;
            }
            
            window.editingId = materialId;
            const modal = document.getElementById('materialModal');
            const form = document.getElementById('materialForm');
            
            // Ensure materials are loaded
            if (!window.materials || window.materials.length === 0) {
                await loadMaterials();
            }
            
            // Load units for dropdowns
            await loadUnits();
            
            if (materialId) {
                const material = window.materials.find(m => m.id === materialId);
                if (material) {
                    document.getElementById('materialModalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ø§Ø¯Ø©';
                    document.getElementById('materialCode').value = material.code || '';
                    document.getElementById('materialName').value = material.name;
                    document.getElementById('materialSecondName').value = material.secondName || '';
                    document.getElementById('materialCategory').value = material.category || '';
                    document.getElementById('materialUnit').value = material.unit || '';
                    document.getElementById('materialSubUnit').value = material.subUnit || '';
                    document.getElementById('materialConversion').value = material.conversion || '';
                    document.getElementById('materialConversionType').value = material.conversionType || 'multiply';
                    document.getElementById('materialMinStock').value = material.minStock || 0;
                    document.getElementById('materialDescription').value = material.description || '';
                    
                    // Enable conversion fields if subUnit exists
                    if (material.subUnit) {
                        document.getElementById('materialConversion').disabled = false;
                        document.getElementById('materialConversionType').disabled = false;
                    }
                    // Update examples with loaded data
                    setTimeout(() => updateConversionExamples(), 100);
                }
            } else {
                document.getElementById('materialModalTitle').textContent = window.t('addMaterial');
                form.reset();
                document.getElementById('materialConversion').disabled = true;
                document.getElementById('materialConversionType').disabled = true;
                // Generate automatic code
                const code = await generateMaterialCode();
                document.getElementById('materialCode').value = code;
                // Update examples
                setTimeout(() => updateConversionExamples(), 100);
            }
            modal.classList.add('active');
        };

        async function saveMaterial(e) {
            e.preventDefault();
            
            // Check permissions
            if (!window.currentUserPermissions || (!window.currentUserPermissions.isAdmin && !window.currentUserPermissions.canManageMaterials)) {
                showAlert(window.t('noAccess'), 'error');
                return;
            }
            
            const { addDoc, updateDoc, doc, collection } = window.firebaseCollections;
            const db = window.firebaseDb;

            const subUnit = document.getElementById('materialSubUnit').value;
            const conversion = document.getElementById('materialConversion').value;
            
            // Validate: if subUnit is selected, conversion must be provided
            if (subUnit && (!conversion || parseFloat(conversion) <= 0)) {
                showAlert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„ØªØ¹Ø§Ø¯Ù„ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± ÙˆØ­Ø¯Ø© ÙØ±Ø¹ÙŠØ©', 'error');
                return;
            }

            let materialCode = document.getElementById('materialCode').value;
            
            // If no code provided, generate one (for new materials)
            if (!materialCode && !window.editingId) {
                materialCode = await generateMaterialCode();
            }
            
            // If code already exists (when adding new), generate a new one
            if (!window.editingId && materialCode) {
                const existingMaterial = window.materials.find(m => m.code === materialCode);
                if (existingMaterial) {
                    materialCode = await generateMaterialCode();
                    document.getElementById('materialCode').value = materialCode;
                }
            }

            const materialData = {
                code: materialCode,
                name: document.getElementById('materialName').value,
                secondName: document.getElementById('materialSecondName').value || null,
                category: document.getElementById('materialCategory').value,
                unit: document.getElementById('materialUnit').value,
                subUnit: subUnit || null,
                conversion: subUnit ? parseFloat(conversion) : null,
                conversionType: subUnit ? document.getElementById('materialConversionType').value : null,
                minStock: parseFloat(document.getElementById('materialMinStock').value) || 0,
                description: document.getElementById('materialDescription').value
            };

            try {
                if (window.editingId) {
                    // Get old data for comparison
                    const oldMaterial = window.materials.find(m => m.id === window.editingId);
                    
                    // Check if conversion is being changed and material is used in transactions
                    if (oldMaterial && materialData.subUnit && oldMaterial.subUnit) {
                        const conversionChanged = oldMaterial.conversion !== materialData.conversion || 
                                                  oldMaterial.conversionType !== materialData.conversionType;
                        if (conversionChanged) {
                            const isUsed = await isMaterialUsedInTransactions(window.editingId);
                            if (isUsed) {
                                showAlert('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ¹Ø§Ø¯Ù„ Ù„ÙˆØ­Ø¯Ø© ÙØ±Ø¹ÙŠØ© ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø§ ÙÙŠ Ø¹Ù…Ù„ÙŠØ§Øª', 'error');
                                return;
                            }
                        }
                    }
                    
                    await updateDoc(doc(db, 'materials', window.editingId), materialData);
                    await logActivity('update', 'material', window.editingId, materialData.name, materialData, oldMaterial);
                    showAlert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } else {
                    const docRef = await addDoc(collection(db, 'materials'), materialData);
                    await logActivity('create', 'material', docRef.id, materialData.name, materialData);
                    showAlert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                }
                closeModal('materialModal');
                await loadMaterials();
            } catch (error) {
                console.error('Error saving material:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø§Ø¯Ø©', 'error');
            }
        }

        window.deleteMaterial = async function(materialId) {
            // Check permissions
            if (!window.currentUserPermissions || (!window.currentUserPermissions.isAdmin && !window.currentUserPermissions.canManageMaterials)) {
                showAlert(window.t('noAccess'), 'error');
                return;
            }
            
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø©ØŸ')) return;
            
            // Check if material is used in transactions
            const isUsed = await isEntityUsedInTransactions('material', materialId);
            if (isUsed) {
                showAlert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ù…Ø³ØªØ®Ø¯Ù…Ø© ÙÙŠ Ø¹Ù…Ù„ÙŠØ§Øª', 'error');
                return;
            }
            
            try {
                const { deleteDoc, doc } = window.firebaseCollections;
                const material = window.materials.find(m => m.id === materialId);
                const materialName = material ? material.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                await deleteDoc(doc(db, 'materials', materialId));
                await logActivity('delete', 'material', materialId, materialName);
                showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                await loadMaterials();
            } catch (error) {
                console.error('Error deleting material:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø§Ø¯Ø©', 'error');
            }
        };

        // ========== WAREHOUSES MANAGEMENT ==========
        window.warehouses = [];

        async function loadWarehouses() {
            try {
                const warehousesRef = collection(db, 'warehouses');
                const snapshot = await getDocs(warehousesRef);
                window.warehouses = [];
                snapshot.forEach((docSnapshot) => {
                    window.warehouses.push({ id: docSnapshot.id, ...docSnapshot.data() });
                });
                displayWarehouses();
                
                // Populate warehouse selects
                ['receiveWarehouse', 'deliverWarehouse', 'returnWarehouse', 'inventoryWarehouse', 'reportWarehouse'].forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        const currentValue = select.value;
                        select.innerHTML = selectId === 'inventoryWarehouse' || selectId === 'reportWarehouse' 
                            ? '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª</option>'
                            : '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</option>';
                        const filteredWarehouses = window.getFilteredWarehousesSync ? window.getFilteredWarehousesSync() : window.warehouses;
                        filteredWarehouses.forEach(wh => {
                            const option = document.createElement('option');
                            option.value = wh.id;
                            option.textContent = wh.name;
                            select.appendChild(option);
                        });
                        select.value = currentValue;
                    }
                });
                
                // Update buttons visibility after loading and displaying warehouses
                updateManagementButtonsVisibility();
            } catch (error) {
                console.error('Error loading warehouses:', error);
            }
        }

        function displayWarehouses() {
            const tbody = document.getElementById('warehousesTableBody');
            tbody.innerHTML = '';
            // Filter warehouses based on permissions
            const filteredWarehouses = window.getFilteredWarehousesSync ? window.getFilteredWarehousesSync() : window.warehouses;
            filteredWarehouses.forEach(warehouse => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${warehouse.name}</td>
                    <td>${warehouse.location || '-'}</td>
                    <td>${warehouse.manager || '-'}</td>
                    <td><span class="badge ${warehouse.status === 'Ù†Ø´Ø·' ? 'badge-success' : 'badge-danger'}">${warehouse.status}</span></td>
                    <td>
                        ${(!window.currentUserPermissions || window.currentUserPermissions.isAdmin || window.currentUserPermissions.canManageWarehouses) ? `
                            <button class="btn btn-success btn-small" onclick="showWarehouseModal('${warehouse.id}')">${window.t('edit')}</button>
                            <button class="btn btn-danger btn-small" onclick="deleteWarehouse('${warehouse.id}')">${window.t('delete')}</button>
                        ` : '<span style="color: #999;">-</span>'}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        window.showWarehouseModal = function(warehouseId = null) {
            // Check permissions
            if (!window.currentUserPermissions || (!window.currentUserPermissions.isAdmin && !window.currentUserPermissions.canManageWarehouses)) {
                showAlert(window.t('noAccess'), 'error');
                return;
            }
            
            window.editingId = warehouseId;
            const modal = document.getElementById('warehouseModal');
            const form = document.getElementById('warehouseForm');
            
            if (warehouseId) {
                const warehouse = window.warehouses.find(w => w.id === warehouseId);
                if (warehouse) {
                    document.getElementById('warehouseModalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªÙˆØ¯Ø¹';
                    document.getElementById('warehouseName').value = warehouse.name;
                    document.getElementById('warehouseLocation').value = warehouse.location || '';
                    document.getElementById('warehouseManager').value = warehouse.manager || '';
                    document.getElementById('warehouseStatus').value = warehouse.status || 'Ù†Ø´Ø·';
                }
            } else {
                document.getElementById('warehouseModalTitle').textContent = window.t('addWarehouse');
                form.reset();
                document.getElementById('warehouseStatus').value = 'Ù†Ø´Ø·';
            }
            modal.classList.add('active');
        };

        async function saveWarehouse(e) {
            e.preventDefault();
            
            // Check permissions
            if (!window.currentUserPermissions || (!window.currentUserPermissions.isAdmin && !window.currentUserPermissions.canManageWarehouses)) {
                showAlert(window.t('noAccess'), 'error');
                return;
            }
            
            const { addDoc, updateDoc, doc, collection } = window.firebaseCollections;
            const db = window.firebaseDb;

            const warehouseData = {
                name: document.getElementById('warehouseName').value,
                location: document.getElementById('warehouseLocation').value,
                manager: document.getElementById('warehouseManager').value,
                status: document.getElementById('warehouseStatus').value
            };

            try {
                if (window.editingId) {
                    const oldWarehouse = window.warehouses.find(w => w.id === window.editingId);
                    await updateDoc(doc(db, 'warehouses', window.editingId), warehouseData);
                    await logActivity('update', 'warehouse', window.editingId, warehouseData.name, warehouseData, oldWarehouse);
                    showAlert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } else {
                    const docRef = await addDoc(collection(db, 'warehouses'), warehouseData);
                    await logActivity('create', 'warehouse', docRef.id, warehouseData.name, warehouseData);
                    showAlert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                }
                closeModal('warehouseModal');
                await loadWarehouses();
            } catch (error) {
                console.error('Error saving warehouse:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹', 'error');
            }
        }

        window.deleteWarehouse = async function(warehouseId) {
            // Check permissions
            if (!window.currentUserPermissions || (!window.currentUserPermissions.isAdmin && !window.currentUserPermissions.canManageWarehouses)) {
                showAlert(window.t('noAccess'), 'error');
                return;
            }
            
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ØŸ')) return;
            
            // Check if warehouse is used in transactions
            const isUsed = await isEntityUsedInTransactions('warehouse', warehouseId);
            if (isUsed) {
                showAlert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ù„Ø£Ù†Ù‡ Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø¹Ù…Ù„ÙŠØ§Øª', 'error');
                return;
            }
            
            try {
                const { deleteDoc, doc } = window.firebaseCollections;
                const warehouse = window.warehouses.find(w => w.id === warehouseId);
                const warehouseName = warehouse ? warehouse.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                await deleteDoc(doc(db, 'warehouses', warehouseId));
                await logActivity('delete', 'warehouse', warehouseId, warehouseName);
                showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                await loadWarehouses();
            } catch (error) {
                console.error('Error deleting warehouse:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹', 'error');
            }
        };

        // ========== WORK SITES MANAGEMENT ==========
        window.workSites = [];

        async function loadWorkSites() {
            try {
                if (typeof loadWorkSiteGroups === 'function') await loadWorkSiteGroups();
                const workSitesRef = collection(db, 'workSites');
                const snapshot = await getDocs(workSitesRef);
                window.workSites = [];
                snapshot.forEach((docSnapshot) => {
                    window.workSites.push({ id: docSnapshot.id, ...docSnapshot.data() });
                });
                displayWorkSites();
                
                // Populate work site selects (filtered by permissions)
                const filteredWorkSites = window.getFilteredWorkSitesSync ? window.getFilteredWorkSitesSync() : window.workSites;
                ['deliverWorkSite', 'returnWorkSite'].forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        const currentValue = select.value;
                        select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„</option>';
                        filteredWorkSites.forEach(ws => {
                            const option = document.createElement('option');
                            option.value = ws.id;
                            option.textContent = ws.name;
                            select.appendChild(option);
                        });
                        select.value = currentValue;
                    }
                });
                
                // Update buttons visibility after loading and displaying work sites
                updateManagementButtonsVisibility();
            } catch (error) {
                console.error('Error loading work sites:', error);
            }
        }

        function displayWorkSites() {
            const tbody = document.getElementById('workSitesTableBody');
            tbody.innerHTML = '';
            // Filter work sites based on permissions
            const filteredWorkSites = window.getFilteredWorkSitesSync ? window.getFilteredWorkSitesSync() : window.workSites;
            const getWorkSiteGroupName = (groupId) => {
                if (!groupId) return '-';
                const g = (window.workSiteGroups || []).find(gr => gr.id === groupId);
                return g ? g.name : '-';
            };
            filteredWorkSites.forEach(workSite => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${workSite.name}</td>
                    <td>${workSite.address || '-'}</td>
                    <td>${getWorkSiteGroupName(workSite.groupId)}</td>
                    <td>${workSite.manager || '-'}</td>
                    <td>${workSite.type || '-'}</td>
                    <td>
                        ${(!window.currentUserPermissions || window.currentUserPermissions.isAdmin || window.currentUserPermissions.canManageWorkSites) ? `
                            <button class="btn btn-success btn-small" onclick="showWorkSiteModal('${workSite.id}')">${window.t('edit')}</button>
                            <button class="btn btn-danger btn-small" onclick="deleteWorkSite('${workSite.id}')">${window.t('delete')}</button>
                        ` : '<span style="color: #999;">-</span>'}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        window.showWorkSiteModal = function(workSiteId = null) {
            // Check permissions
            if (!window.currentUserPermissions || (!window.currentUserPermissions.isAdmin && !window.currentUserPermissions.canManageWorkSites)) {
                showAlert(window.t('noAccess'), 'error');
                return;
            }
            
            window.editingId = workSiteId;
            const modal = document.getElementById('workSiteModal');
            const form = document.getElementById('workSiteForm');
            
            if (workSiteId) {
                const workSite = window.workSites.find(w => w.id === workSiteId);
                if (workSite) {
                    document.getElementById('workSiteModalTitle').textContent = window.t('editWorkSite');
                    document.getElementById('workSiteName').value = workSite.name;
                    document.getElementById('workSiteAddress').value = workSite.address || '';
                    document.getElementById('workSiteManager').value = workSite.manager || '';
                    document.getElementById('workSiteType').value = workSite.type || '';
                    const groupSelect = document.getElementById('workSiteGroupId');
                    if (groupSelect) groupSelect.value = workSite.groupId || '';
                }
            } else {
                document.getElementById('workSiteModalTitle').textContent = window.t('addWorkSite');
                form.reset();
                const groupSelect = document.getElementById('workSiteGroupId');
                if (groupSelect) groupSelect.value = '';
            }
            modal.classList.add('active');
        };

        async function saveWorkSite(e) {
            e.preventDefault();
            
            // Check permissions
            if (!window.currentUserPermissions || (!window.currentUserPermissions.isAdmin && !window.currentUserPermissions.canManageWorkSites)) {
                showAlert(window.t('noAccess'), 'error');
                return;
            }
            
            const { addDoc, updateDoc, doc, collection } = window.firebaseCollections;
            const db = window.firebaseDb;

            const workSiteData = {
                name: document.getElementById('workSiteName').value,
                address: document.getElementById('workSiteAddress').value,
                manager: document.getElementById('workSiteManager').value,
                type: document.getElementById('workSiteType').value,
                groupId: document.getElementById('workSiteGroupId')?.value || null
            };

            try {
                if (window.editingId) {
                    const oldWorkSite = window.workSites.find(w => w.id === window.editingId);
                    await updateDoc(doc(db, 'workSites', window.editingId), workSiteData);
                    await logActivity('update', 'workSite', window.editingId, workSiteData.name, workSiteData, oldWorkSite);
                    showAlert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } else {
                    const docRef = await addDoc(collection(db, 'workSites'), workSiteData);
                    await logActivity('create', 'workSite', docRef.id, workSiteData.name, workSiteData);
                    showAlert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                }
                closeModal('workSiteModal');
                await loadWorkSites();
            } catch (error) {
                console.error('Error saving work site:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„', 'error');
            }
        }

        window.deleteWorkSite = async function(workSiteId) {
            // Check permissions
            if (!window.currentUserPermissions || (!window.currentUserPermissions.isAdmin && !window.currentUserPermissions.canManageWorkSites)) {
                showAlert(window.t('noAccess'), 'error');
                return;
            }
            if (!confirm(window.t('deleteConfirm'))) return;
            
            // Check if workSite is used in transactions
            const isUsed = await isEntityUsedInTransactions('workSite', workSiteId);
            if (isUsed) {
                showAlert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„ Ù‡Ø°Ø§ Ù„Ø£Ù†Ù‡ Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø¹Ù…Ù„ÙŠØ§Øª', 'error');
                return;
            }
            
            try {
                const { deleteDoc, doc } = window.firebaseCollections;
                const workSite = window.workSites.find(w => w.id === workSiteId);
                const workSiteName = workSite ? workSite.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                await deleteDoc(doc(db, 'workSites', workSiteId));
                await logActivity('delete', 'workSite', workSiteId, workSiteName);
                showAlert('ØªÙ… Ø­Ø°Ù Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                await loadWorkSites();
            } catch (error) {
                console.error('Error deleting work site:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„', 'error');
            }
        };

        // ========== WORK SITE GROUPS MANAGEMENT ==========
        window.workSiteGroups = [];

        async function loadWorkSiteGroups() {
            try {
                const { collection, getDocs } = window.firebaseCollections;
                const db = window.firebaseDb;
                const workSiteGroupsRef = collection(db, 'workSiteGroups');
                const snapshot = await getDocs(workSiteGroupsRef);
                window.workSiteGroups = [];
                snapshot.forEach((docSnapshot) => {
                    window.workSiteGroups.push({ id: docSnapshot.id, ...docSnapshot.data() });
                });
                displayWorkSiteGroups();
                // Populate work site group dropdown in work site form
                const groupSelect = document.getElementById('workSiteGroupId');
                if (groupSelect) {
                    const currentValue = groupSelect.value;
                    groupSelect.innerHTML = '<option value="">Ø¨Ø¯ÙˆÙ† Ù…Ø¬Ù…ÙˆØ¹Ø©</option>';
                    window.workSiteGroups.forEach(grp => {
                        const option = document.createElement('option');
                        option.value = grp.id;
                        option.textContent = grp.name;
                        groupSelect.appendChild(option);
                    });
                    groupSelect.value = currentValue || '';
                }
            } catch (error) {
                console.error('Error loading work site groups:', error);
            }
        }

        function displayWorkSiteGroups() {
            const tbody = document.getElementById('workSiteGroupsTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';
            window.workSiteGroups.forEach(grp => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${grp.name}</td>
                    <td>${grp.description || '-'}</td>
                    <td>
                        <button class="btn btn-success btn-small" onclick="showWorkSiteGroupModal('${grp.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn btn-danger btn-small" onclick="deleteWorkSiteGroup('${grp.id}')">Ø­Ø°Ù</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        window.showWorkSiteGroupModal = function(groupId = null) {
            window.editingWorkSiteGroupId = groupId;
            const modal = document.getElementById('workSiteGroupModal');
            const form = document.getElementById('workSiteGroupForm');
            const titleEl = document.getElementById('workSiteGroupModalTitle');
            if (groupId) {
                const grp = window.workSiteGroups.find(g => g.id === groupId);
                if (grp) {
                    titleEl.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù…Ù„';
                    document.getElementById('workSiteGroupName').value = grp.name;
                    document.getElementById('workSiteGroupDescription').value = grp.description || '';
                }
            } else {
                titleEl.textContent = 'Ø¥Ø¶Ø§ÙØ© Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…ÙˆØ§Ù‚Ø¹ Ø¹Ù…Ù„ Ø¬Ø¯ÙŠØ¯Ø©';
                form.reset();
            }
            modal.classList.add('active');
        };

        window.saveWorkSiteGroup = async function(e) {
            e.preventDefault();
            const { addDoc, updateDoc, doc, collection } = window.firebaseCollections;
            const db = window.firebaseDb;
            const name = document.getElementById('workSiteGroupName').value.trim();
            const description = document.getElementById('workSiteGroupDescription').value.trim() || null;
            try {
                if (window.editingWorkSiteGroupId) {
                    await updateDoc(doc(db, 'workSiteGroups', window.editingWorkSiteGroupId), { name, description });
                    await logActivity('update', 'workSiteGroup', window.editingWorkSiteGroupId, name, { name, description });
                    showAlert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } else {
                    const docRef = await addDoc(collection(db, 'workSiteGroups'), { name, description });
                    await logActivity('create', 'workSiteGroup', docRef.id, name, { name, description });
                    showAlert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                }
                closeModal('workSiteGroupModal');
                window.editingWorkSiteGroupId = null;
                await loadWorkSiteGroups();
            } catch (error) {
                console.error('Error saving work site group:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©', 'error');
            }
        };

        window.deleteWorkSiteGroup = async function(groupId) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©ØŸ Ù„Ù† ÙŠØªÙ… Ø­Ø°Ù Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù…Ù„ØŒ Ù„ÙƒÙ†Ù‡Ø§ Ø³ØªÙØ²Ø§Ù„ Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©.')) return;
            try {
                const { deleteDoc, doc } = window.firebaseCollections;
                const db = window.firebaseDb;
                const grp = window.workSiteGroups.find(g => g.id === groupId);
                const grpName = grp ? grp.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                await deleteDoc(doc(db, 'workSiteGroups', groupId));
                await logActivity('delete', 'workSiteGroup', groupId, grpName);
                showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                await loadWorkSiteGroups();
                await loadWorkSites();
            } catch (error) {
                console.error('Error deleting work site group:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©', 'error');
            }
        };

        // ========== SUPPLIERS MANAGEMENT ==========
        window.suppliers = [];

        async function loadSuppliers() {
            try {
                const suppliersRef = collection(db, 'suppliers');
                const snapshot = await getDocs(suppliersRef);
                window.suppliers = [];
                snapshot.forEach((docSnapshot) => {
                    window.suppliers.push({ id: docSnapshot.id, ...docSnapshot.data() });
                });
                displaySuppliers();
                
                // Populate supplier select (filtered by permissions)
                const select = document.getElementById('receiveSupplier');
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø²ÙˆØ¯</option>';
                    const filteredSuppliers = window.getFilteredSuppliersSync ? window.getFilteredSuppliersSync() : window.suppliers;
                    filteredSuppliers.forEach(supplier => {
                        const option = document.createElement('option');
                        option.value = supplier.id;
                        option.textContent = supplier.name;
                        select.appendChild(option);
                    });
                    select.value = currentValue;
                }
                
                // Also update the searchable supplier select
                populateSupplierOptions();
                
                // Update buttons visibility after loading and displaying suppliers
                updateManagementButtonsVisibility();
            } catch (error) {
                console.error('Error loading suppliers:', error);
            }
        }

        function displaySuppliers() {
            const tbody = document.getElementById('suppliersTableBody');
            tbody.innerHTML = '';
            // Filter suppliers based on permissions
            const filteredSuppliers = window.getFilteredSuppliersSync ? window.getFilteredSuppliersSync() : window.suppliers;
            filteredSuppliers.forEach(supplier => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${supplier.name}</td>
                    <td>${supplier.phone || '-'}</td>
                    <td>${supplier.email || '-'}</td>
                    <td>${supplier.materialsType || '-'}</td>
                    <td>
                        ${(!window.currentUserPermissions || window.currentUserPermissions.isAdmin || window.currentUserPermissions.canManageSuppliers) ? `
                            <button class="btn btn-success btn-small" onclick="showSupplierModal('${supplier.id}')">${window.t('edit')}</button>
                            <button class="btn btn-danger btn-small" onclick="deleteSupplier('${supplier.id}')">${window.t('delete')}</button>
                        ` : '<span style="color: #999;">-</span>'}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        window.showSupplierModal = function(supplierId = null) {
            // Check permissions
            if (!window.currentUserPermissions || (!window.currentUserPermissions.isAdmin && !window.currentUserPermissions.canManageSuppliers)) {
                showAlert(window.t('noAccess'), 'error');
                return;
            }
            
            window.editingId = supplierId;
            const modal = document.getElementById('supplierModal');
            const form = document.getElementById('supplierForm');
            
            if (supplierId) {
                const supplier = window.suppliers.find(s => s.id === supplierId);
                if (supplier) {
                    document.getElementById('supplierModalTitle').textContent = window.t('editSupplier');
                    document.getElementById('supplierName').value = supplier.name;
                    document.getElementById('supplierPhone').value = supplier.phone || '';
                    document.getElementById('supplierEmail').value = supplier.email || '';
                    document.getElementById('supplierMaterialsType').value = supplier.materialsType || '';
                    document.getElementById('supplierAddress').value = supplier.address || '';
                }
            } else {
                document.getElementById('supplierModalTitle').textContent = window.t('addSupplier');
                form.reset();
            }
            modal.classList.add('active');
        };

        async function saveSupplier(e) {
            e.preventDefault();
            
            // Check permissions
            if (!window.currentUserPermissions || (!window.currentUserPermissions.isAdmin && !window.currentUserPermissions.canManageSuppliers)) {
                showAlert(window.t('noAccess'), 'error');
                return;
            }
            
            const { addDoc, updateDoc, doc, collection } = window.firebaseCollections;
            const db = window.firebaseDb;

            const supplierData = {
                name: document.getElementById('supplierName').value,
                phone: document.getElementById('supplierPhone').value,
                email: document.getElementById('supplierEmail').value,
                materialsType: document.getElementById('supplierMaterialsType').value,
                address: document.getElementById('supplierAddress').value
            };

            try {
                if (window.editingId) {
                    const oldSupplier = window.suppliers.find(s => s.id === window.editingId);
                    await updateDoc(doc(db, 'suppliers', window.editingId), supplierData);
                    await logActivity('update', 'supplier', window.editingId, supplierData.name, supplierData, oldSupplier);
                    showAlert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø²ÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } else {
                    const docRef = await addDoc(collection(db, 'suppliers'), supplierData);
                    await logActivity('create', 'supplier', docRef.id, supplierData.name, supplierData);
                    showAlert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                }
                closeModal('supplierModal');
                await loadSuppliers();
            } catch (error) {
                console.error('Error saving supplier:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø²ÙˆØ¯', 'error');
            }
        }

        window.deleteSupplier = async function(supplierId) {
            // Check permissions
            if (!window.currentUserPermissions || (!window.currentUserPermissions.isAdmin && !window.currentUserPermissions.canManageSuppliers)) {
                showAlert(window.t('noAccess'), 'error');
                return;
            }
            if (!confirm(window.t('deleteConfirm'))) return;
            
            // Check if supplier is used in transactions
            const isUsed = await isEntityUsedInTransactions('supplier', supplierId);
            if (isUsed) {
                showAlert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø²ÙˆØ¯ Ù„Ø£Ù†Ù‡ Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø¹Ù…Ù„ÙŠØ§Øª', 'error');
                return;
            }
            
            try {
                const { deleteDoc, doc } = window.firebaseCollections;
                const supplier = window.suppliers.find(s => s.id === supplierId);
                const supplierName = supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                await deleteDoc(doc(db, 'suppliers', supplierId));
                await logActivity('delete', 'supplier', supplierId, supplierName);
                showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø²ÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                await loadSuppliers();
            } catch (error) {
                console.error('Error deleting supplier:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø²ÙˆØ¯', 'error');
            }
        };

        // ========== TRANSACTIONS: RECEIVE ==========
        async function generateReceiveNumber() {
            try {
                const { collection, getDocs, query, where } = window.firebaseCollections;
                const db = window.firebaseDb;

                const transactionsRef = collection(db, 'transactions');
                const q = query(transactionsRef, where('type', '==', 'receive'));
                const snapshot = await getDocs(q);

                // Extract numbers from existing receive numbers
                const existingNumbers = [];
                snapshot.forEach((docSnapshot) => {
                    const data = docSnapshot.data();
                    if (data.number) {
                        // Extract number from format like REC-001, REC-002, etc.
                        const match = data.number.match(/REC-(\d+)/);
                        if (match) {
                            const num = parseInt(match[1]);
                            if (!isNaN(num)) {
                                existingNumbers.push(num);
                            }
                        }
                    }
                });

                // Find the next available number starting from 001
                let nextNumber = 1;
                if (existingNumbers.length > 0) {
                    const maxNumber = Math.max(...existingNumbers);
                    nextNumber = maxNumber + 1;
                }

                return `REC-${nextNumber.toString().padStart(3, '0')}`; // Format as REC-001, REC-002, etc.
            } catch (error) {
                console.error('Error generating receive number:', error);
                // Fallback: use timestamp-based number
                return `REC-${Date.now().toString().slice(-6)}`;
            }
        }

        window.showReceiveModal = async function(receiveId = null) {
            const p = window.currentUserPermissions;
            if (p && !p.isAdmin) {
                if (receiveId && !p.receiveEdit) {
                    showAlert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…', 'error');
                    return;
                }
                if (!receiveId && !p.receiveAdd) {
                    showAlert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…', 'error');
                    return;
                }
            }
            const modal = document.getElementById('receiveModal');
            const form = document.getElementById('receiveForm');
            const receiveAlertEl = document.getElementById('receiveModalAlert');
            if (receiveAlertEl) { receiveAlertEl.style.display = 'none'; receiveAlertEl.textContent = ''; }
            window.editingReceiveId = receiveId;
            
            // Ensure data is loaded
            if (!window.suppliers || window.suppliers.length === 0) {
                await loadSuppliers();
            }
            if (!window.warehouses || window.warehouses.length === 0) {
                await loadWarehouses();
            }
            if (!window.materials || window.materials.length === 0) {
                await loadMaterials();
            }
            if (!window.units || window.units.length === 0) {
                await loadUnits();
            }
            
            // Populate supplier options
            populateSupplierOptions();
            
            if (receiveId) {
                // Edit mode - load existing data
                await loadReceiveForEdit(receiveId);
                document.getElementById('receiveModalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ø³ØªÙ„Ø§Ù…';
            } else {
                // Add mode - reset form
                form.reset();
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('receiveDate').value = today;
                document.getElementById('receiveItemsList').innerHTML = '';
                
                // Generate receive number automatically
                const receiveNumber = await generateReceiveNumber();
                document.getElementById('receiveNumber').value = receiveNumber;
                
                document.getElementById('receiveModalTitle').textContent = 'Ø¥Ø¶Ø§ÙØ© Ø§Ø³ØªÙ„Ø§Ù… Ø¬Ø¯ÙŠØ¯';
            }
            
            modal.classList.add('active');
        };

        async function loadReceiveForEdit(receiveId) {
            try {
                const { doc, getDoc } = window.firebaseCollections;
                const db = window.firebaseDb;
                
                const receiveDoc = await getDoc(doc(db, 'transactions', receiveId));
                if (!receiveDoc.exists()) {
                    showAlert('Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error');
                    return;
                }
                
                const data = receiveDoc.data();
                
                // Fill form fields
                const dateValue = data.date ? (data.date.toDate ? data.date.toDate().toISOString().split('T')[0] : new Date(data.date).toISOString().split('T')[0]) : '';
                document.getElementById('receiveDate').value = dateValue;
                document.getElementById('receiveNumber').value = data.number || '';
                document.getElementById('receiveSupplierInvoice').value = data.supplierInvoice || '';
                document.getElementById('receiveNotes').value = data.notes || '';
                
                // Select supplier
                if (data.supplierId) {
                    const supplier = window.suppliers.find(s => s.id === data.supplierId);
                    if (supplier) {
                        selectSupplier(supplier.id, supplier.name);
                    }
                }
                
                // Select warehouse
                if (data.warehouseId) {
                    document.getElementById('receiveWarehouse').value = data.warehouseId;
                }
                
                // Load items
                const itemsList = document.getElementById('receiveItemsList');
                itemsList.innerHTML = '';
                
                if (data.items && data.items.length > 0) {
                    data.items.forEach(item => {
                        addReceiveItemForEdit(item);
                    });
                }
            } catch (error) {
                console.error('Error loading receive for edit:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…', 'error');
            }
        }

        function addReceiveItemForEdit(item) {
            if (!item || !item.materialId) {
                console.error('Invalid item data for edit');
                return;
            }
            
            const itemId = 'item_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const material = window.materials.find(m => m.id === item.materialId);
            
            if (!material) {
                console.error('Material not found:', item.materialId);
                return;
            }
            
            // Create item row first
            const itemRow = document.createElement('div');
            itemRow.className = 'item-row';
            itemRow.style.display = 'flex';
            itemRow.style.gap = '10px';
            itemRow.style.alignItems = 'center';
            itemRow.style.marginBottom = '10px';
            itemRow.style.padding = '10px';
            itemRow.style.border = '1px solid #ddd';
            itemRow.style.borderRadius = '8px';
            
            // Material searchable select
            const materialSelectDiv = document.createElement('div');
            materialSelectDiv.className = 'searchable-select';
            materialSelectDiv.style.width = '100%';
            materialSelectDiv.innerHTML = `
                <div class="selected-value" onclick="toggleMaterialOptions('${itemId}')">
                    <span id="materialDisplay_${itemId}">${material.name}${material.secondName ? ' (' + material.secondName + ')' : ''}</span>
                </div>
                <div class="options-list" id="materialOptions_${itemId}">
                    <input type="text" id="materialSearch_${itemId}" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø§Ø¯Ø©..." onkeyup="filterMaterialOptions('${itemId}')" onclick="event.stopPropagation()">
                    <div id="materialOptionsList_${itemId}"></div>
                </div>
                <input type="hidden" id="materialId_${itemId}" class="material-select" value="${item.materialId}">
            `;
            
            // Populate material options
            const materialOptionsList = materialSelectDiv.querySelector(`#materialOptionsList_${itemId}`);
            window.materials.forEach(m => {
                const option = document.createElement('div');
                option.className = 'option-item';
                option.dataset.value = m.id;
                option.dataset.name = m.name;
                option.textContent = `${m.code || ''} - ${m.name}${m.secondName ? ' (' + m.secondName + ')' : ''}`;
                option.onclick = function() {
                    selectMaterial(itemId, m.id, m.name, m.unit, m.subUnit);
                };
                materialOptionsList.appendChild(option);
            });

            // Quantity - use entered quantity if available, otherwise use base quantity
            const quantityInput = document.createElement('input');
            quantityInput.type = 'number';
            quantityInput.className = 'quantity-input';
            quantityInput.min = '0';
            quantityInput.step = '0.001';
            quantityInput.placeholder = 'Ø§Ù„ÙƒÙ…ÙŠØ©';
            quantityInput.style.width = '120px';
            quantityInput.value = item.enteredQuantity !== undefined ? item.enteredQuantity : (item.quantity || '');

            // Unit select - will be populated by selectMaterial
            const unitSelect = document.createElement('select');
            unitSelect.id = `unitSelect_${itemId}`;
            unitSelect.style.width = '150px';
            unitSelect.disabled = false;

            // Remove button
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn-danger btn-small';
            removeBtn.textContent = 'Ø­Ø°Ù';
            removeBtn.onclick = function() {
                itemRow.remove();
            };
            
            // Append all elements to itemRow
            itemRow.appendChild(materialSelectDiv);
            itemRow.appendChild(quantityInput);
            itemRow.appendChild(unitSelect);
            itemRow.appendChild(removeBtn);

            // Append itemRow to list
            document.getElementById('receiveItemsList').appendChild(itemRow);
            
            // Set the unit - use entered unit if available, otherwise use base unit
            const enteredUnit = item.enteredUnit || item.unit || material.unit;
            // Call selectMaterial with the desired unit value
            selectMaterial(itemId, material.id, material.name, material.unit, material.subUnit, enteredUnit);
        }

        function populateSupplierOptions() {
            const optionsList = document.getElementById('receiveSupplierOptionsList');
            if (!optionsList) return;
            
            optionsList.innerHTML = '';
            const filteredSuppliers = window.getFilteredSuppliersSync ? window.getFilteredSuppliersSync() : window.suppliers;
            filteredSuppliers.forEach(supplier => {
                const option = document.createElement('div');
                option.className = 'option-item';
                option.dataset.value = supplier.id;
                option.dataset.name = supplier.name;
                option.textContent = supplier.name;
                option.onclick = function() {
                    selectSupplier(supplier.id, supplier.name);
                };
                optionsList.appendChild(option);
            });
        }

        function selectSupplier(supplierId, supplierName) {
            const display = document.getElementById('receiveSupplierDisplay');
            const hidden = document.getElementById('receiveSupplier');
            const options = document.getElementById('receiveSupplierOptions');
            const selectedValue = display.parentElement;
            
            display.textContent = supplierName;
            hidden.value = supplierId;
            selectedValue.classList.remove('empty');
            options.classList.remove('show');
        }

        window.toggleSupplierOptions = function() {
            const options = document.getElementById('receiveSupplierOptions');
            options.classList.toggle('show');
        };

        window.filterSupplierOptions = function() {
            const search = document.getElementById('receiveSupplierSearch').value.toLowerCase();
            const options = document.querySelectorAll('#receiveSupplierOptionsList .option-item');
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                option.style.display = text.includes(search) ? 'block' : 'none';
            });
        };

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.searchable-select')) {
                document.querySelectorAll('.options-list').forEach(list => {
                    list.classList.remove('show', 'above', 'floating');
                    list.style.top = list.style.bottom = list.style.left = list.style.width = list.style.boxShadow = '';
                });
            }
        });

        async function loadReceives() {
            try {
                // Ensure data is loaded
                if (!window.suppliers || window.suppliers.length === 0) {
                    await loadSuppliers();
                }
                if (!window.warehouses || window.warehouses.length === 0) {
                    await loadWarehouses();
                }
                
                const { collection, getDocs, query, where, orderBy } = window.firebaseCollections;
                const db = window.firebaseDb;

                const transactionsRef = collection(db, 'transactions');
                // Query without orderBy to avoid index requirement
                const q = query(transactionsRef, where('type', '==', 'receive'));
                
                const snapshot = await getDocs(q);
                
                const tbody = document.getElementById('receivesTableBody');
                if (!tbody) {
                    console.log('receivesTableBody not found');
                    return;
                }
                
                tbody.innerHTML = '';

                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ø³ØªÙ„Ø§Ù…</td></tr>';
                    return;
                }

                // Convert to array and sort by createdAt descending
                const receives = [];
                snapshot.forEach((docSnapshot) => {
                    const data = docSnapshot.data();
                    // Filter by permissions (warehouse and supplier)
                    if (window.hasWarehouseAccess && window.hasSupplierAccess && 
                        window.hasWarehouseAccess(data.warehouseId) && 
                        window.hasSupplierAccess(data.supplierId)) {
                        receives.push({
                            id: docSnapshot.id,
                            ...data,
                            createdAtTimestamp: data.createdAt ? (data.createdAt.toDate ? data.createdAt.toDate().getTime() : new Date(data.createdAt).getTime()) : 0
                        });
                    }
                });

                // Sort by createdAt descending (newest first)
                receives.sort((a, b) => b.createdAtTimestamp - a.createdAtTimestamp);

                // Display sorted results
                const p = window.currentUserPermissions;
                const canEditReceive = p && (p.isAdmin || p.receiveEdit === true);
                const canDeleteReceive = p && (p.isAdmin || p.receiveDelete === true);
                receives.forEach(receive => {
                    const supplier = window.suppliers.find(s => s.id === receive.supplierId);
                    const warehouse = window.warehouses.find(w => w.id === receive.warehouseId);
                    
                    const dateStr = window.formatDate(receive.date);
                    const actions = `
                        <button class="btn btn-success btn-small" onclick="viewReceiveDetails('${receive.id}')">Ø¹Ø±Ø¶</button>
                        <button class="btn btn-info btn-small" onclick="printReceive('${receive.id}')" style="background-color: #17a2b8; color: white;">Ø·Ø¨Ø§Ø¹Ø©</button>
                        ${canEditReceive ? `<button class="btn btn-warning btn-small" onclick="editReceive('${receive.id}')">ØªØ¹Ø¯ÙŠÙ„</button>` : ''}
                        ${canDeleteReceive ? `<button class="btn btn-danger btn-small" onclick="deleteReceive('${receive.id}')">Ø­Ø°Ù</button>` : ''}
                    `;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${receive.number || '-'}</td>
                        <td>${dateStr}</td>
                        <td>${supplier ? supplier.name : '-'}</td>
                        <td>${warehouse ? warehouse.name : '-'}</td>
                        <td>${receive.items?.length || 0}</td>
                        <td>${receive.notes || '-'}</td>
                        <td>${actions}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading receives:', error);
                const tbody = document.getElementById('receivesTableBody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: red;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</td></tr>';
                }
            }
            updateManagementButtonsVisibility();
        }

        window.filterReceives = function() {
            const search = document.getElementById('searchReceives').value.toLowerCase();
            const tbody = document.getElementById('receivesTableBody');
            if (!tbody) return;
            
            const rows = tbody.querySelectorAll('tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        };

        window.viewReceiveDetails = async function(transactionId) {
            try {
                const { doc, getDoc } = window.firebaseCollections;
                const db = window.firebaseDb;
                
                const transactionDoc = await getDoc(doc(db, 'transactions', transactionId));
                if (!transactionDoc.exists()) {
                    showAlert('Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error');
                    return;
                }
                
                const data = transactionDoc.data();
                const supplier = window.suppliers.find(s => s.id === data.supplierId);
                const warehouse = window.warehouses.find(w => w.id === data.warehouseId);
                
                const dateStr = window.formatDate(data.date);
                
                let itemsRows = '';
                data.items?.forEach((item, index) => {
                    const enteredQty = item.enteredQuantity !== undefined ? item.enteredQuantity : item.quantity;
                    const enteredUnit = item.enteredUnit || item.unit;
                    const baseQty = item.quantity || item.enteredQuantity;
                    const baseUnit = item.unit;
                    
                    itemsRows += `
                        <tr>
                            <td style="text-align: center; padding: 8px; border: 1px solid #ddd;">${index + 1}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${item.materialName}</td>
                            <td style="text-align: center; padding: 8px; border: 1px solid #ddd;">${enteredQty}</td>
                            <td style="text-align: center; padding: 8px; border: 1px solid #ddd;">${enteredUnit}</td>
                            <td style="text-align: center; padding: 8px; border: 1px solid #ddd;">${baseQty.toFixed(3)}</td>
                            <td style="text-align: center; padding: 8px; border: 1px solid #ddd;">${baseUnit}</td>
                        </tr>
                    `;
                });
                
                const detailsHtml = `
                    <div style="padding: 20px; max-width: 900px; margin: 0 auto;">
                        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 15px;">
                            <h2 style="margin: 0; color: #333;">ØªÙØ§ØµÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</h2>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                            <div>
                                <p style="margin: 10px 0;"><strong>Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„:</strong> ${data.number || '-'}</p>
                                <p style="margin: 10px 0;"><strong>Ø±Ù‚Ù… Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ù…Ø²ÙˆØ¯:</strong> ${data.supplierInvoice || '-'}</p>
                                <p style="margin: 10px 0;"><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${dateStr}</p>
                            </div>
                            <div>
                                <p style="margin: 10px 0;"><strong>Ø§Ù„Ù…Ø²ÙˆØ¯:</strong> ${supplier ? supplier.name : '-'}</p>
                                <p style="margin: 10px 0;"><strong>Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹:</strong> ${warehouse ? warehouse.name : '-'}</p>
                            </div>
                        </div>
                        ${data.notes ? `<p style="margin: 10px 0;"><strong>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${data.notes}</p>` : ''}
                        <h3 style="margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid #ddd; padding-bottom: 10px;">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©:</h3>
                        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                            <thead>
                                <tr style="background-color: #f5f5f5;">
                                    <th style="text-align: center; padding: 12px; border: 1px solid #ddd;">#</th>
                                    <th style="text-align: right; padding: 12px; border: 1px solid #ddd;">Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                                    <th style="text-align: center; padding: 12px; border: 1px solid #ddd;">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¯Ø®Ù„Ø©</th>
                                    <th style="text-align: center; padding: 12px; border: 1px solid #ddd;">Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø©</th>
                                    <th style="text-align: center; padding: 12px; border: 1px solid #ddd;">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø­ÙˆÙ„Ø©</th>
                                    <th style="text-align: center; padding: 12px; border: 1px solid #ddd;">Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsRows}
                            </tbody>
                        </table>
                    </div>
                `;
                
                // Remove existing modal if any
                const existingModal = document.getElementById('receiveDetailsModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Create and show modal
                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.id = 'receiveDetailsModal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 950px;">
                        <div class="modal-header">
                            <h2>ØªÙØ§ØµÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</h2>
                            <button class="close" onclick="closeModal('receiveDetailsModal')">&times;</button>
                        </div>
                        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                            ${detailsHtml}
                        </div>
                        <div class="modal-footer" style="padding: 15px; text-align: left; border-top: 1px solid #ddd;">
                            <button class="btn btn-info" onclick="printReceive('${transactionId}')" style="background-color: #17a2b8; color: white;">Ø·Ø¨Ø§Ø¹Ø©</button>
                            <button class="btn btn-secondary" onclick="closeModal('receiveDetailsModal')">Ø¥ØºÙ„Ø§Ù‚</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error viewing receive details:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„', 'error');
            }
        };

        window.printReceive = async function(transactionId) {
            try {
                const { doc, getDoc } = window.firebaseCollections;
                const db = window.firebaseDb;
                
                const transactionDoc = await getDoc(doc(db, 'transactions', transactionId));
                if (!transactionDoc.exists()) {
                    showAlert('Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error');
                    return;
                }
                
                const data = transactionDoc.data();
                const supplier = window.suppliers.find(s => s.id === data.supplierId);
                const warehouse = window.warehouses.find(w => w.id === data.warehouseId);
                
                const dateStr = window.formatDate(data.date);
                
                let itemsRows = '';
                data.items?.forEach((item, index) => {
                    const enteredQty = item.enteredQuantity !== undefined ? item.enteredQuantity : item.quantity;
                    const enteredUnit = item.enteredUnit || item.unit;
                    const baseQty = item.quantity || item.enteredQuantity;
                    const baseUnit = item.unit;
                    
                    itemsRows += `
                        <tr>
                            <td style="text-align: center; padding: 8px; border: 1px solid #000;">${index + 1}</td>
                            <td style="padding: 8px; border: 1px solid #000;">${item.materialName}</td>
                            <td style="text-align: center; padding: 8px; border: 1px solid #000;">${enteredQty}</td>
                            <td style="text-align: center; padding: 8px; border: 1px solid #000;">${enteredUnit}</td>
                            <td style="text-align: center; padding: 8px; border: 1px solid #000;">${baseQty.toFixed(3)}</td>
                            <td style="text-align: center; padding: 8px; border: 1px solid #000;">${baseUnit}</td>
                        </tr>
                    `;
                });
                
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html dir="rtl" lang="ar">
                    <head>
                        <meta charset="UTF-8">
                        <title>Ø·Ø¨Ø§Ø¹Ø© Ø§Ø³ØªÙ„Ø§Ù… - ${data.number || ''}</title>
                        <style>
                            @media print {
                                body { margin: 0; }
                                .no-print { display: none; }
                            }
                            body {
                                font-family: Arial, sans-serif;
                                padding: 20px;
                                direction: rtl;
                            }
                            h2 {
                                text-align: center;
                                margin-bottom: 30px;
                                border-bottom: 2px solid #000;
                                padding-bottom: 15px;
                            }
                            .info-grid {
                                display: grid;
                                grid-template-columns: 1fr 1fr;
                                gap: 20px;
                                margin-bottom: 30px;
                            }
                            table {
                                width: 100%;
                                border-collapse: collapse;
                                margin-top: 20px;
                            }
                            th, td {
                                border: 1px solid #000;
                                padding: 10px;
                                text-align: center;
                            }
                            th {
                                background-color: #f0f0f0;
                                font-weight: bold;
                            }
                            .print-btn {
                                margin: 20px 0;
                                padding: 10px 20px;
                                background-color: #007bff;
                                color: white;
                                border: none;
                                cursor: pointer;
                                font-size: 16px;
                            }
                        </style>
                    </head>
                    <body>
                        <div>
                            <h2>Ø¥ÙŠØµØ§Ù„ Ø§Ø³ØªÙ„Ø§Ù…</h2>
                            <div class="info-grid">
                                <div>
                                    <p><strong>Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„:</strong> ${data.number || '-'}</p>
                                    <p><strong>Ø±Ù‚Ù… Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ù…Ø²ÙˆØ¯:</strong> ${data.supplierInvoice || '-'}</p>
                                    <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${dateStr}</p>
                                </div>
                                <div>
                                    <p><strong>Ø§Ù„Ù…Ø²ÙˆØ¯:</strong> ${supplier ? supplier.name : '-'}</p>
                                    <p><strong>Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹:</strong> ${warehouse ? warehouse.name : '-'}</p>
                                </div>
                            </div>
                            ${data.notes ? `<p><strong>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${data.notes}</p>` : ''}
                            <h3>Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©:</h3>
                            <table>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                                        <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¯Ø®Ù„Ø©</th>
                                        <th>Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø©</th>
                                        <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø­ÙˆÙ„Ø©</th>
                                        <th>Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${itemsRows}
                                </tbody>
                            </table>
                            <p style="margin-top: 30px; text-align: left;">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯: ${data.items?.length || 0}</p>
                            <button class="print-btn no-print" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø©</button>
                        </div>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                
                // Auto print after a short delay
                setTimeout(() => {
                    printWindow.print();
                }, 250);
            } catch (error) {
                console.error('Error printing receive:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…', 'error');
            }
        };

        window.addReceiveItem = function() {
            const itemId = 'item_' + Date.now();
            
            // Material searchable select
            const materialSelectDiv = document.createElement('div');
            materialSelectDiv.className = 'searchable-select';
            materialSelectDiv.style.width = '100%';
            materialSelectDiv.innerHTML = `
                <div class="selected-value empty" onclick="toggleMaterialOptions('${itemId}')">
                    <span id="materialDisplay_${itemId}">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</span>
                </div>
                <div class="options-list" id="materialOptions_${itemId}">
                    <input type="text" id="materialSearch_${itemId}" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø§Ø¯Ø©..." onkeyup="filterMaterialOptions('${itemId}')" onclick="event.stopPropagation()">
                    <div id="materialOptionsList_${itemId}"></div>
                </div>
                <input type="hidden" id="materialId_${itemId}" class="material-select">
            `;
            
            // Populate material options
            const materialOptionsList = materialSelectDiv.querySelector(`#materialOptionsList_${itemId}`);
            window.materials.forEach(m => {
                const option = document.createElement('div');
                option.className = 'option-item';
                option.dataset.value = m.id;
                option.dataset.name = m.name;
                option.textContent = `${m.code || ''} - ${m.name}${m.secondName ? ' (' + m.secondName + ')' : ''}`;
                option.onclick = function() {
                    selectMaterial(itemId, m.id, m.name, m.unit, m.subUnit);
                };
                materialOptionsList.appendChild(option);
            });

            const quantityInput = document.createElement('input');
            quantityInput.type = 'number';
            quantityInput.className = 'quantity-input';
            quantityInput.min = '0';
            quantityInput.step = '0.001';
            quantityInput.placeholder = 'Ø§Ù„ÙƒÙ…ÙŠØ©';
            quantityInput.style.width = '120px';

            // Unit select (will be updated based on selected material)
            const unitSelect = document.createElement('select');
            unitSelect.id = `unitSelect_${itemId}`;
            unitSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹</option>';
            unitSelect.style.width = '150px';
            unitSelect.disabled = true;

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn-danger btn-small';
            removeBtn.textContent = 'Ø­Ø°Ù';
            removeBtn.onclick = function() {
                itemRow.remove();
            };

            const itemRow = document.createElement('div');
            itemRow.className = 'item-row';
            itemRow.style.display = 'flex';
            itemRow.style.gap = '10px';
            itemRow.style.alignItems = 'center';
            itemRow.style.marginBottom = '10px';
            itemRow.style.padding = '10px';
            itemRow.style.border = '1px solid #ddd';
            itemRow.style.borderRadius = '8px';
            
            itemRow.appendChild(materialSelectDiv);
            itemRow.appendChild(quantityInput);
            itemRow.appendChild(unitSelect);
            itemRow.appendChild(removeBtn);

            document.getElementById('receiveItemsList').appendChild(itemRow);
            itemRow.scrollIntoView({ behavior: 'smooth', block: 'start' });
        };

        function selectMaterial(itemId, materialId, materialName, baseUnit, subUnit, desiredUnit = null) {
            const materialDisplay = document.getElementById(`materialDisplay_${itemId}`);
            const materialHidden = document.getElementById(`materialId_${itemId}`);
            const unitSelect = document.getElementById(`unitSelect_${itemId}`);
            const materialOptions = document.getElementById(`materialOptions_${itemId}`);
            
            if (!materialDisplay || !materialHidden || !unitSelect || !materialOptions) {
                console.error('Required elements not found for itemId:', itemId);
                return;
            }
            
            const selectedValue = materialDisplay.parentElement;
            const material = window.materials.find(m => m.id === materialId);
            
            // Update display with full name including second name
            const displayText = material ? 
                `${material.name}${material.secondName ? ' (' + material.secondName + ')' : ''}` : 
                materialName;
            materialDisplay.textContent = displayText;
            materialHidden.value = materialId;
            selectedValue.classList.remove('empty');
            materialOptions.classList.remove('show');
            
            // Update unit select based on material
            unitSelect.innerHTML = '';
            unitSelect.disabled = false;
            
            // Determine which unit to select
            const unitToSelect = desiredUnit || unitSelect.value || baseUnit;
            
            // Add base unit
            if (baseUnit) {
                const option = document.createElement('option');
                option.value = baseUnit;
                option.textContent = baseUnit;
                if (unitToSelect === baseUnit) {
                    option.selected = true;
                }
                unitSelect.appendChild(option);
            }
            
            // Add sub unit if exists
            if (subUnit) {
                const option = document.createElement('option');
                option.value = subUnit;
                option.textContent = subUnit;
                if (unitToSelect === subUnit) {
                    option.selected = true;
                }
                unitSelect.appendChild(option);
            }
        }

        window.toggleMaterialOptions = function(itemId) {
            const options = document.getElementById(`materialOptions_${itemId}`);
            const isOpening = !options.classList.contains('show');
            if (isOpening) {
                const itemRow = options.closest('.item-row');
                const trigger = options.parentElement?.querySelector('.selected-value');
                if (itemRow && trigger) {
                    itemRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    options.classList.add('floating');
                    const rect = trigger.getBoundingClientRect();
                    const dropdownHeight = 220;
                    const gap = 4;
                    if (rect.bottom + dropdownHeight + gap <= window.innerHeight - 20) {
                        options.style.top = (rect.bottom + gap) + 'px';
                        options.style.bottom = 'auto';
                        options.style.boxShadow = '0 5px 15px rgba(0,0,0,0.2)';
                    } else {
                        options.style.top = 'auto';
                        options.style.bottom = (window.innerHeight - rect.top + gap) + 'px';
                        options.style.boxShadow = '0 -5px 15px rgba(0,0,0,0.2)';
                    }
                    options.style.left = rect.left + 'px';
                    options.style.width = rect.width + 'px';
                }
            } else {
                options.classList.remove('floating');
                options.style.top = options.style.bottom = options.style.left = options.style.width = options.style.boxShadow = '';
            }
            options.classList.toggle('show');
        };

        window.filterMaterialOptions = function(itemId) {
            const search = document.getElementById(`materialSearch_${itemId}`).value.toLowerCase();
            const options = document.querySelectorAll(`#materialOptionsList_${itemId} .option-item`);
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                option.style.display = text.includes(search) ? 'block' : 'none';
            });
        };
        
        // Material Movement Report - Material Selection Functions
        window.toggleMaterialMovementOptions = function() {
            const options = document.getElementById('materialMovementOptions');
            if (options) {
                options.classList.toggle('show');
            }
        };
        
        window.filterMaterialMovementOptions = function() {
            const search = document.getElementById('materialMovementSearch');
            if (!search) return;
            
            const searchTerm = search.value.toLowerCase();
            const options = document.querySelectorAll('#materialMovementOptionsList .option-item');
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                option.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        };
        
        window.selectMaterialMovement = function(materialId, materialName, secondName) {
            const materialSelectHidden = document.getElementById('materialMovementSelect');
            const materialDisplay = document.getElementById('materialMovementDisplay');
            const materialOptions = document.getElementById('materialMovementOptions');
            const selectedValue = document.querySelector('#materialMovementSelectDiv .selected-value');
            
            if (materialSelectHidden && materialDisplay && selectedValue) {
                materialSelectHidden.value = materialId;
                const displayText = `${materialName}${secondName ? ' (' + secondName + ')' : ''}`;
                materialDisplay.textContent = displayText;
                materialDisplay.style.color = '#333';
                selectedValue.classList.remove('empty');
                selectedValue.style.color = '#333';
                
                if (materialOptions) {
                    materialOptions.classList.remove('show');
                }
            }
        };

        async function saveReceive(e) {
            e.preventDefault();
            const p = window.currentUserPermissions;
            const isEdit = !!window.editingReceiveId;
            if (p && !p.isAdmin) {
                if (isEdit && !p.receiveEdit) {
                    showModalAlert('receiveModal', 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…', 'error');
                    return;
                }
                if (!isEdit && !p.receiveAdd) {
                    showModalAlert('receiveModal', 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…', 'error');
                    return;
                }
            }
            const { addDoc, updateDoc, doc, getDoc, collection, Timestamp } = window.firebaseCollections;
            const db = window.firebaseDb;

            const items = [];
            const itemsList = document.getElementById('receiveItemsList');
            const itemRows = itemsList.querySelectorAll('.item-row');
            
            itemRows.forEach(row => {
                const materialHidden = row.querySelector('input.material-select');
                const quantityInput = row.querySelector('input[type="number"]');
                const unitSelect = row.querySelector('select');
                
                if (materialHidden && materialHidden.value && quantityInput && quantityInput.value) {
                    const material = window.materials.find(m => m.id === materialHidden.value);
                    if (!material) return;
                    
                    const enteredQuantity = parseFloat(quantityInput.value);
                    const enteredUnit = unitSelect ? unitSelect.value : material.unit;
                    
                    // Convert to base unit if sub-unit is selected
                    let baseQuantity = enteredQuantity;
                    let baseUnit = material.unit;
                    
                    // Check if entered unit is sub-unit
                    if (enteredUnit === material.subUnit && material.conversion && material.conversionType) {
                        if (material.conversionType === 'multiply') {
                            // Ø¶Ø±Ø¨: 1 ÙˆØ­Ø¯Ø© ÙØ±Ø¹ÙŠØ© = Ø§Ù„ØªØ¹Ø§Ø¯Ù„ Ã— ÙˆØ­Ø¯Ø© Ø£Ø³Ø§Ø³ÙŠØ©
                            // Ø£ÙŠ: ÙƒÙ…ÙŠØ© Ø£Ø³Ø§Ø³ÙŠØ© = ÙƒÙ…ÙŠØ© ÙØ±Ø¹ÙŠØ© Ã— Ø§Ù„ØªØ¹Ø§Ø¯Ù„
                            baseQuantity = enteredQuantity * material.conversion;
                        } else if (material.conversionType === 'divide') {
                            // Ù‚Ø³Ù…Ø©: Ø§Ù„ØªØ¹Ø§Ø¯Ù„ ÙˆØ­Ø¯Ø© ÙØ±Ø¹ÙŠØ© = 1 ÙˆØ­Ø¯Ø© Ø£Ø³Ø§Ø³ÙŠØ©
                            // Ø£ÙŠ: ÙƒÙ…ÙŠØ© Ø£Ø³Ø§Ø³ÙŠØ© = ÙƒÙ…ÙŠØ© ÙØ±Ø¹ÙŠØ© / Ø§Ù„ØªØ¹Ø§Ø¯Ù„
                            baseQuantity = enteredQuantity / material.conversion;
                        }
                    }
                    
                    items.push({
                        materialId: materialHidden.value,
                        materialName: material.name,
                        enteredQuantity: enteredQuantity,  // Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¯Ø®Ù„Ø©
                        enteredUnit: enteredUnit,          // Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø©
                        quantity: baseQuantity,            // Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø­ÙˆÙ„Ø© Ù„Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                        unit: baseUnit                     // Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                    });
                }
            });

            if (items.length === 0) {
                showModalAlert('receiveModal', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
                return;
            }

            // Validate required fields
            const supplierId = document.getElementById('receiveSupplier').value;
            const warehouseId = document.getElementById('receiveWarehouse').value;
            const receiveDate = document.getElementById('receiveDate').value;
            
            if (!supplierId) {
                showModalAlert('receiveModal', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø²ÙˆØ¯', 'error');
                return;
            }
            
            if (!warehouseId) {
                showModalAlert('receiveModal', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹', 'error');
                return;
            }
            
            if (!receiveDate) {
                showModalAlert('receiveModal', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…', 'error');
                return;
            }

            const transactionData = {
                type: 'receive',
                date: Timestamp.fromDate(new Date(receiveDate)),
                supplierId: supplierId,
                warehouseId: warehouseId,
                number: document.getElementById('receiveNumber').value || null,
                supplierInvoice: document.getElementById('receiveSupplierInvoice').value || null,
                items: items,
                notes: document.getElementById('receiveNotes').value,
                createdAt: Timestamp.now()
            };

            try {
                let oldData = null;
                
                if (window.editingReceiveId) {
                    // Edit mode: validate (Ø§Ø³ØªÙ„Ø§Ù…Ø§Øª + Ù…Ø³ØªØ±Ø¯ - Ù…Ø³Ù„Ù…) >= 0 for each material after excluding this receive, then reverse and apply new
                    const oldReceiveDoc = await getDoc(doc(db, 'transactions', window.editingReceiveId));
                    if (oldReceiveDoc.exists()) {
                        oldData = oldReceiveDoc.data();
                        const whId = oldData.warehouseId;
                        if (oldData.items && oldData.items.length > 0 && typeof window.getComputedWarehouseBalances === 'function') {
                            const balances = await window.getComputedWarehouseBalances(whId, null);
                            for (const oldItem of oldData.items) {
                                const mid = oldItem.materialId;
                                const balance = (balances[mid] != null ? balances[mid] : 0);
                                if (balance < 0) {
                                    const mat = window.materials?.find(m => m.id === mid);
                                    const name = mat ? mat.name : mid;
                                    showModalAlert('receiveModal', 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„Ø±ØµÙŠØ¯ (Ø§Ø³ØªÙ„Ø§Ù…Ø§Øª + Ø§Ø³ØªÙ„Ø§Ù… Ø­Ø§Ù„ÙŠ + Ù…Ø³ØªØ±Ø¯ - Ù…Ø³Ù„Ù… = ' + balance.toFixed(3) + ') ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ØµÙØ± Ø£Ùˆ Ø£ÙƒØ«Ø± Ù„Ù„Ù…Ø§Ø¯Ø© Â«' + name + 'Â»', 'error');
                                    return;
                                }
                            }
                        }
                        // Reverse old inventory changes (subtract old quantities)
                        if (oldData.items) {
                            for (const oldItem of oldData.items) {
                                await updateInventory(oldData.warehouseId, 'warehouse', oldItem.materialId, oldItem.quantity, oldItem.unit, 'subtract');
                            }
                        }
                    }
                    
                    // Update transaction
                    await updateDoc(doc(db, 'transactions', window.editingReceiveId), {
                        ...transactionData,
                        updatedAt: Timestamp.now()
                    });
                    
                    // Apply new inventory changes (add new quantities)
                    for (const item of items) {
                        await updateInventory(transactionData.warehouseId, 'warehouse', item.materialId, item.quantity, item.unit, 'add');
                    }
                    
                    // Log activity
                    await logActivity('update', 'transaction', window.editingReceiveId, `Ø¹Ù…Ù„ÙŠØ© Ø§Ø³ØªÙ„Ø§Ù… - ${transactionData.number || 'Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù…'}`, transactionData, oldData);
                    
                    showAlert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } else {
                    // Add mode: Just save and add to inventory
                    const docRef = await addDoc(collection(db, 'transactions'), transactionData);

                    // Update inventory
                    for (const item of items) {
                        await updateInventory(transactionData.warehouseId, 'warehouse', item.materialId, item.quantity, item.unit, 'add');
                    }
                    
                    // Log activity
                    await logActivity('create', 'transaction', docRef.id, `Ø¹Ù…Ù„ÙŠØ© Ø§Ø³ØªÙ„Ø§Ù… - ${transactionData.number || 'Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù…'}`, transactionData);
                    
                    showAlert('ØªÙ… Ø­ÙØ¸ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
                }

                document.getElementById('receiveForm').reset();
                document.getElementById('receiveItemsList').innerHTML = '';
                window.editingReceiveId = null;
                closeModal('receiveModal');
                await loadDashboard();
                await loadInventory();
                await loadReceives(); // Reload receives table
            } catch (error) {
                console.error('Error saving receive:', error);
                showModalAlert('receiveModal', 'Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…', 'error');
            }
        }

        window.editReceive = async function(receiveId) {
            await showReceiveModal(receiveId);
        };

        window.deleteReceive = async function(receiveId) {
            const p = window.currentUserPermissions;
            if (p && !p.isAdmin && !p.receiveDelete) {
                showAlert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…', 'error');
                return;
            }
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ù‡Ø°Ù‡ØŸ Ø³ÙŠØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†.')) {
                return;
            }

            try {
                const { doc, getDoc, deleteDoc } = window.firebaseCollections;
                const db = window.firebaseDb;

                // Get receive data
                const receiveDoc = await getDoc(doc(db, 'transactions', receiveId));
                if (!receiveDoc.exists()) {
                    showAlert('Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error');
                    return;
                }

                const data = receiveDoc.data();

                // Validate: (Ø§Ø³ØªÙ„Ø§Ù…Ø§Øª + Ù…Ø³ØªØ±Ø¯ - Ù…Ø³Ù„Ù…) >= 0 for each material after removing this receive
                if (data.items && data.items.length > 0 && typeof window.getComputedWarehouseBalances === 'function') {
                    const whId = data.warehouseId;
                    const balances = await window.getComputedWarehouseBalances(whId, receiveId);
                    for (const item of data.items) {
                        const mid = item.materialId;
                        const available = (balances[mid] != null ? balances[mid] : 0);
                        if (available < 0) {
                            const mat = window.materials?.find(m => m.id === mid);
                            const name = mat ? mat.name : mid;
                            showAlert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø­Ø°Ù: Ø§Ù„Ø±ØµÙŠØ¯ Ø³ÙŠØµØ¨Ø­ Ø³Ø§Ù„Ø¨Ø§Ù‹ Ù„Ù„Ù…Ø§Ø¯Ø© Â«' + name + 'Â». (Ø§Ø³ØªÙ„Ø§Ù…Ø§Øª + Ù…Ø³ØªØ±Ø¯ - Ù…Ø³Ù„Ù… = ' + available.toFixed(3) + 'ØŒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ØµÙØ± Ø£Ùˆ Ø£ÙƒØ«Ø±)', 'error');
                            return;
                        }
                    }
                }

                // Reverse inventory changes (subtract quantities from inventory)
                if (data.items) {
                    for (const item of data.items) {
                        await updateInventory(data.warehouseId, 'warehouse', item.materialId, item.quantity, item.unit, 'subtract');
                    }
                }

                // Log activity before deletion
                await logActivity('delete', 'transaction', receiveId, `Ø¹Ù…Ù„ÙŠØ© Ø§Ø³ØªÙ„Ø§Ù… - ${data.number || 'Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù…'}`, null, data);
                
                // Delete transaction
                await deleteDoc(doc(db, 'transactions', receiveId));

                showAlert('ØªÙ… Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
                await loadDashboard();
                await loadInventory();
                await loadReceives(); // Reload receives table
            } catch (error) {
                console.error('Error deleting receive:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…', 'error');
            }
        }

        // ========== TRANSACTIONS: DELIVER ==========
        async function generateDeliverNumber() {
            try {
                const { collection, getDocs, query, where } = window.firebaseCollections;
                const db = window.firebaseDb;

                const transactionsRef = collection(db, 'transactions');
                const q = query(transactionsRef, where('type', '==', 'deliver'));
                const snapshot = await getDocs(q);

                // Extract numbers from existing deliver numbers
                const existingNumbers = [];
                snapshot.forEach((docSnapshot) => {
                    const data = docSnapshot.data();
                    if (data.number) {
                        // Extract number from format like DELIV-001, DELIV-002, etc.
                        const match = data.number.match(/DELIV-(\d+)/);
                        if (match) {
                            const num = parseInt(match[1]);
                            if (!isNaN(num)) {
                                existingNumbers.push(num);
                            }
                        }
                    }
                });

                // Find the next available number starting from 001
                let nextNumber = 1;
                if (existingNumbers.length > 0) {
                    const maxNumber = Math.max(...existingNumbers);
                    nextNumber = maxNumber + 1;
                }

                return `DELIV-${nextNumber.toString().padStart(3, '0')}`; // Format as DELIV-001, DELIV-002, etc.
            } catch (error) {
                console.error('Error generating deliver number:', error);
                // Fallback: use timestamp-based number
                return `DELIV-${Date.now().toString().slice(-6)}`;
            }
        }

        window.showDeliverModal = async function(deliverId = null) {
            const p = window.currentUserPermissions;
            if (p && !p.isAdmin) {
                if (deliverId && !p.deliverEdit) {
                    showAlert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…', 'error');
                    return;
                }
                if (!deliverId && !p.deliverAdd) {
                    showAlert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…', 'error');
                    return;
                }
            }
            const modal = document.getElementById('deliverModal');
            const form = document.getElementById('deliverForm');
            const deliverAlertEl = document.getElementById('deliverModalAlert');
            if (deliverAlertEl) { deliverAlertEl.style.display = 'none'; deliverAlertEl.textContent = ''; }
            window.editingDeliverId = deliverId;
            
            // Ensure data is loaded
            if (!window.warehouses || window.warehouses.length === 0) {
                await loadWarehouses();
            }
            if (!window.workSites || window.workSites.length === 0) {
                await loadWorkSites();
            }
            if (!window.materials || window.materials.length === 0) {
                await loadMaterials();
            }
            if (!window.units || window.units.length === 0) {
                await loadUnits();
            }
            
            if (deliverId) {
                // Edit mode - load existing data
                await loadDeliverForEdit(deliverId);
                document.getElementById('deliverModalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© ØªØ³Ù„ÙŠÙ…';
            } else {
                // Add mode - reset form
                form.reset();
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('deliverDate').value = today;
                document.getElementById('deliverItemsList').innerHTML = '';
                
                // Generate deliver number automatically
                const deliverNumber = await generateDeliverNumber();
                document.getElementById('deliverNumber').value = deliverNumber;
                
                // Clear invoice field for new deliver
                document.getElementById('deliverInvoice').value = '';
                
                document.getElementById('deliverModalTitle').textContent = 'Ø¥Ø¶Ø§ÙØ© ØªØ³Ù„ÙŠÙ… Ø¬Ø¯ÙŠØ¯';
            }
            
            modal.classList.add('active');
        };

        async function loadDelivers() {
            try {
                // Ensure data is loaded
                if (!window.warehouses || window.warehouses.length === 0) {
                    await loadWarehouses();
                }
                if (!window.workSites || window.workSites.length === 0) {
                    await loadWorkSites();
                }
                
                const { collection, getDocs, query, where } = window.firebaseCollections;
                const db = window.firebaseDb;

                const transactionsRef = collection(db, 'transactions');
                const q = query(transactionsRef, where('type', '==', 'deliver'));
                
                const snapshot = await getDocs(q);
                
                const tbody = document.getElementById('deliversTableBody');
                if (!tbody) {
                    console.log('deliversTableBody not found');
                    return;
                }
                
                tbody.innerHTML = '';

                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª ØªØ³Ù„ÙŠÙ…</td></tr>';
                    return;
                }

                // Convert to array and sort by createdAt descending
                const delivers = [];
                snapshot.forEach((docSnapshot) => {
                    const data = docSnapshot.data();
                    // Filter by permissions (check both warehouse and work site access)
                    if (window.hasWarehouseAccess && window.hasWorkSiteAccess && 
                        window.hasWarehouseAccess(data.warehouseId) && 
                        window.hasWorkSiteAccess(data.workSiteId)) {
                        delivers.push({
                            id: docSnapshot.id,
                            ...data,
                            createdAtTimestamp: data.createdAt ? (data.createdAt.toDate ? data.createdAt.toDate().getTime() : new Date(data.createdAt).getTime()) : 0
                        });
                    }
                });

                // Sort by createdAt descending (newest first)
                delivers.sort((a, b) => b.createdAtTimestamp - a.createdAtTimestamp);

                // Display sorted results
                const p = window.currentUserPermissions;
                const canEditDeliver = p && (p.isAdmin || p.deliverEdit === true);
                const canDeleteDeliver = p && (p.isAdmin || p.deliverDelete === true);
                delivers.forEach(deliver => {
                    const warehouse = window.warehouses.find(w => w.id === deliver.warehouseId);
                    const workSite = window.workSites.find(w => w.id === deliver.workSiteId);
                    
                    const dateStr = window.formatDate(deliver.date);
                    const actions = `
                        <button class="btn btn-success btn-small" onclick="viewDeliverDetails('${deliver.id}')">Ø¹Ø±Ø¶</button>
                        <button class="btn btn-info btn-small" onclick="printDeliver('${deliver.id}')" style="background-color: #17a2b8; color: white;">Ø·Ø¨Ø§Ø¹Ø©</button>
                        ${canEditDeliver ? `<button class="btn btn-warning btn-small" onclick="editDeliver('${deliver.id}')">ØªØ¹Ø¯ÙŠÙ„</button>` : ''}
                        ${canDeleteDeliver ? `<button class="btn btn-danger btn-small" onclick="deleteDeliver('${deliver.id}')">Ø­Ø°Ù</button>` : ''}
                    `;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${deliver.number || '-'}</td>
                        <td>${dateStr}</td>
                        <td>${warehouse ? warehouse.name : '-'}</td>
                        <td>${workSite ? workSite.name : '-'}</td>
                        <td>${deliver.items?.length || 0}</td>
                        <td>${deliver.notes || '-'}</td>
                        <td>${actions}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading delivers:', error);
                const tbody = document.getElementById('deliversTableBody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: red;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…</td></tr>';
                }
            }
            updateManagementButtonsVisibility();
        }

        window.filterDelivers = function() {
            const search = document.getElementById('searchDelivers').value.toLowerCase();
            const tbody = document.getElementById('deliversTableBody');
            if (!tbody) return;
            
            const rows = tbody.querySelectorAll('tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        };

        window.viewDeliverDetails = async function(transactionId) {
            try {
                const { doc, getDoc } = window.firebaseCollections;
                const db = window.firebaseDb;
                
                const transactionDoc = await getDoc(doc(db, 'transactions', transactionId));
                if (!transactionDoc.exists()) {
                    showAlert('Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ù„ÙŠÙ… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error');
                    return;
                }
                
                const data = transactionDoc.data();
                const warehouse = window.warehouses.find(w => w.id === data.warehouseId);
                const workSite = window.workSites.find(w => w.id === data.workSiteId);
                
                const dateStr = window.formatDate(data.date);
                
                let itemsRows = '';
                data.items?.forEach((item, index) => {
                    const enteredQty = item.enteredQuantity !== undefined ? item.enteredQuantity : item.quantity;
                    const enteredUnit = item.enteredUnit || item.unit;
                    const baseQty = item.quantity || item.enteredQuantity;
                    const baseUnit = item.unit;
                    
                    itemsRows += `
                        <tr>
                            <td style="text-align: center; padding: 8px; border: 1px solid #ddd;">${index + 1}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${item.materialName}</td>
                            <td style="text-align: center; padding: 8px; border: 1px solid #ddd;">${enteredQty}</td>
                            <td style="text-align: center; padding: 8px; border: 1px solid #ddd;">${enteredUnit}</td>
                            <td style="text-align: center; padding: 8px; border: 1px solid #ddd;">${baseQty.toFixed(3)}</td>
                            <td style="text-align: center; padding: 8px; border: 1px solid #ddd;">${baseUnit}</td>
                        </tr>
                    `;
                });
                
                const detailsHtml = `
                    <div style="padding: 20px; max-width: 900px; margin: 0 auto;">
                        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 15px;">
                            <h2 style="margin: 0; color: #333;">ØªÙØ§ØµÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ù„ÙŠÙ…</h2>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                            <div>
                                <p style="margin: 10px 0;"><strong>Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„ÙŠÙ…:</strong> ${data.number || '-'}</p>
                                <p style="margin: 10px 0;"><strong>Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„:</strong> ${data.invoice || '-'}</p>
                                <p style="margin: 10px 0;"><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${dateStr}</p>
                            </div>
                            <div>
                                <p style="margin: 10px 0;"><strong>Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹:</strong> ${warehouse ? warehouse.name : '-'}</p>
                                <p style="margin: 10px 0;"><strong>Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„:</strong> ${workSite ? workSite.name : '-'}</p>
                            </div>
                        </div>
                        ${data.notes ? `<p style="margin: 10px 0;"><strong>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${data.notes}</p>` : ''}
                        <h3 style="margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid #ddd; padding-bottom: 10px;">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø³Ù„Ù…Ø©:</h3>
                        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                            <thead>
                                <tr style="background-color: #f5f5f5;">
                                    <th style="text-align: center; padding: 12px; border: 1px solid #ddd;">#</th>
                                    <th style="text-align: right; padding: 12px; border: 1px solid #ddd;">Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                                    <th style="text-align: center; padding: 12px; border: 1px solid #ddd;">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¯Ø®Ù„Ø©</th>
                                    <th style="text-align: center; padding: 12px; border: 1px solid #ddd;">Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø©</th>
                                    <th style="text-align: center; padding: 12px; border: 1px solid #ddd;">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø­ÙˆÙ„Ø©</th>
                                    <th style="text-align: center; padding: 12px; border: 1px solid #ddd;">Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsRows}
                            </tbody>
                        </table>
                    </div>
                `;
                
                // Remove existing modal if any
                const existingModal = document.getElementById('deliverDetailsModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Create and show modal
                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.id = 'deliverDetailsModal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 950px;">
                        <div class="modal-header">
                            <h2>ØªÙØ§ØµÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ù„ÙŠÙ…</h2>
                            <button class="close" onclick="closeModal('deliverDetailsModal')">&times;</button>
                        </div>
                        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                            ${detailsHtml}
                        </div>
                        <div class="modal-footer" style="padding: 15px; text-align: left; border-top: 1px solid #ddd;">
                            <button class="btn btn-info" onclick="printDeliver('${transactionId}')" style="background-color: #17a2b8; color: white;">Ø·Ø¨Ø§Ø¹Ø©</button>
                            <button class="btn btn-secondary" onclick="closeModal('deliverDetailsModal')">Ø¥ØºÙ„Ø§Ù‚</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error viewing deliver details:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„', 'error');
            }
        };

        window.printDeliver = async function(transactionId) {
            try {
                const { doc, getDoc } = window.firebaseCollections;
                const db = window.firebaseDb;
                
                const transactionDoc = await getDoc(doc(db, 'transactions', transactionId));
                if (!transactionDoc.exists()) {
                    showAlert('Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ù„ÙŠÙ… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error');
                    return;
                }
                
                const data = transactionDoc.data();
                const warehouse = window.warehouses.find(w => w.id === data.warehouseId);
                const workSite = window.workSites.find(w => w.id === data.workSiteId);
                
                const dateStr = window.formatDate(data.date);
                
                let itemsRows = '';
                data.items?.forEach((item, index) => {
                    const enteredQty = item.enteredQuantity !== undefined ? item.enteredQuantity : item.quantity;
                    const enteredUnit = item.enteredUnit || item.unit;
                    const baseQty = item.quantity || item.enteredQuantity;
                    const baseUnit = item.unit;
                    
                    itemsRows += `
                        <tr>
                            <td style="text-align: center; padding: 8px; border: 1px solid #000;">${index + 1}</td>
                            <td style="padding: 8px; border: 1px solid #000;">${item.materialName}</td>
                            <td style="text-align: center; padding: 8px; border: 1px solid #000;">${enteredQty}</td>
                            <td style="text-align: center; padding: 8px; border: 1px solid #000;">${enteredUnit}</td>
                            <td style="text-align: center; padding: 8px; border: 1px solid #000;">${baseQty.toFixed(3)}</td>
                            <td style="text-align: center; padding: 8px; border: 1px solid #000;">${baseUnit}</td>
                        </tr>
                    `;
                });
                
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html dir="rtl" lang="ar">
                    <head>
                        <meta charset="UTF-8">
                        <title>Ø·Ø¨Ø§Ø¹Ø© ØªØ³Ù„ÙŠÙ… - ${data.number || ''}</title>
                        <style>
                            @media print {
                                body { margin: 0; }
                                .no-print { display: none; }
                            }
                            body {
                                font-family: Arial, sans-serif;
                                padding: 20px;
                                direction: rtl;
                            }
                            h2 {
                                text-align: center;
                                margin-bottom: 30px;
                                border-bottom: 2px solid #000;
                                padding-bottom: 15px;
                            }
                            .info-grid {
                                display: grid;
                                grid-template-columns: 1fr 1fr;
                                gap: 20px;
                                margin-bottom: 30px;
                            }
                            table {
                                width: 100%;
                                border-collapse: collapse;
                                margin-top: 20px;
                            }
                            th, td {
                                border: 1px solid #000;
                                padding: 10px;
                                text-align: center;
                            }
                            th {
                                background-color: #f0f0f0;
                                font-weight: bold;
                            }
                            .print-btn {
                                margin: 20px 0;
                                padding: 10px 20px;
                                background-color: #007bff;
                                color: white;
                                border: none;
                                cursor: pointer;
                                font-size: 16px;
                            }
                        </style>
                    </head>
                    <body>
                        <div>
                            <h2>Ø¥ÙŠØµØ§Ù„ ØªØ³Ù„ÙŠÙ…</h2>
                            <div class="info-grid">
                                <div>
                                    <p><strong>Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„ÙŠÙ…:</strong> ${data.number || '-'}</p>
                                    <p><strong>Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„:</strong> ${data.invoice || '-'}</p>
                                    <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${dateStr}</p>
                                </div>
                                <div>
                                    <p><strong>Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹:</strong> ${warehouse ? warehouse.name : '-'}</p>
                                    <p><strong>Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„:</strong> ${workSite ? workSite.name : '-'}</p>
                                </div>
                            </div>
                            ${data.notes ? `<p><strong>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${data.notes}</p>` : ''}
                            <h3>Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø³Ù„Ù…Ø©:</h3>
                            <table>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                                        <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¯Ø®Ù„Ø©</th>
                                        <th>Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø©</th>
                                        <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø­ÙˆÙ„Ø©</th>
                                        <th>Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${itemsRows}
                                </tbody>
                            </table>
                            <p style="margin-top: 30px; text-align: left;">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯: ${data.items?.length || 0}</p>
                            <button class="print-btn no-print" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø©</button>
                        </div>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                
                // Auto print after a short delay
                setTimeout(() => {
                    printWindow.print();
                }, 250);
            } catch (error) {
                console.error('Error printing deliver:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…', 'error');
            }
        };

        async function loadDeliverForEdit(deliverId) {
            try {
                const { doc, getDoc } = window.firebaseCollections;
                const db = window.firebaseDb;
                
                const deliverDoc = await getDoc(doc(db, 'transactions', deliverId));
                if (!deliverDoc.exists()) {
                    showAlert('Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ù„ÙŠÙ… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error');
                    return;
                }
                
                const data = deliverDoc.data();
                
                // Fill form fields
                const dateValue = data.date ? (data.date.toDate ? data.date.toDate().toISOString().split('T')[0] : new Date(data.date).toISOString().split('T')[0]) : '';
                document.getElementById('deliverDate').value = dateValue;
                document.getElementById('deliverNumber').value = data.number || '';
                document.getElementById('deliverInvoice').value = data.invoice || '';
                document.getElementById('deliverNotes').value = data.notes || '';
                
                // Select warehouse
                if (data.warehouseId) {
                    document.getElementById('deliverWarehouse').value = data.warehouseId;
                    await loadWarehouseInventory(data.warehouseId, 'deliver');
                }
                
                // Select work site
                if (data.workSiteId) {
                    document.getElementById('deliverWorkSite').value = data.workSiteId;
                }
                
                // Load items
                const itemsList = document.getElementById('deliverItemsList');
                itemsList.innerHTML = '';
                
                if (data.items && data.items.length > 0) {
                    for (const item of data.items) {
                        await addDeliverItemForEdit(item, data.warehouseId);
                    }
                }
            } catch (error) {
                console.error('Error loading deliver for edit:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ù„ÙŠÙ…', 'error');
            }
        }

        window.editDeliver = async function(deliverId) {
            await showDeliverModal(deliverId);
        };

        window.deleteDeliver = async function(deliverId) {
            const p = window.currentUserPermissions;
            if (p && !p.isAdmin && !p.deliverDelete) {
                showAlert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…', 'error');
                return;
            }
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ù„ÙŠÙ… Ù‡Ø°Ù‡ØŸ Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ Ù„Ù„Ù…Ø³ØªÙˆØ¯Ø¹ ÙˆØ¥Ø²Ø§Ù„ØªÙ‡Ø§ Ù…Ù† Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„.')) {
                return;
            }

            try {
                const { doc, getDoc, deleteDoc } = window.firebaseCollections;
                const db = window.firebaseDb;

                // Get deliver data
                const deliverDoc = await getDoc(doc(db, 'transactions', deliverId));
                if (!deliverDoc.exists()) {
                    showAlert('Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ù„ÙŠÙ… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error');
                    return;
                }

                const data = deliverDoc.data();

                // Reverse inventory changes (return to warehouse, remove from work site)
                if (data.items) {
                    for (const item of data.items) {
                        await updateInventory(data.warehouseId, 'warehouse', item.materialId, item.quantity, item.unit, 'add');
                        await updateInventory(data.workSiteId, 'workSite', item.materialId, item.quantity, item.unit, 'subtract');
                    }
                }

                // Log activity before deletion
                await logActivity('delete', 'transaction', deliverId, `Ø¹Ù…Ù„ÙŠØ© ØªØ³Ù„ÙŠÙ… - ${data.number || 'Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù…'}`, null, data);
                
                // Delete transaction
                await deleteDoc(doc(db, 'transactions', deliverId));

                showAlert('ØªÙ… Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­', 'success');
                await loadDashboard();
                await loadInventory();
                await loadDelivers(); // Reload delivers table
            } catch (error) {
                console.error('Error deleting deliver:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ù„ÙŠÙ…', 'error');
            }
        };

        window.addDeliverItem = function() {
            const warehouseId = document.getElementById('deliverWarehouse').value;
            if (!warehouseId) {
                showModalAlert('deliverModal', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }

            const itemId = 'deliver_item_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // Material searchable select
            const materialSelectDiv = document.createElement('div');
            materialSelectDiv.className = 'searchable-select';
            materialSelectDiv.style.width = '100%';
            materialSelectDiv.innerHTML = `
                <div class="selected-value empty" onclick="toggleDeliverMaterialOptions('${itemId}')">
                    <span id="deliverMaterialDisplay_${itemId}">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</span>
                </div>
                <div class="options-list" id="deliverMaterialOptions_${itemId}">
                    <input type="text" id="deliverMaterialSearch_${itemId}" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø§Ø¯Ø©..." onkeyup="filterDeliverMaterialOptions('${itemId}')" onclick="event.stopPropagation()">
                    <div id="deliverMaterialOptionsList_${itemId}"></div>
                </div>
                <input type="hidden" id="deliverMaterialId_${itemId}" class="deliver-material-select">
            `;
            
            // Populate material options (only materials in warehouse inventory)
            // Use querySelector on the div itself since it's not in DOM yet
            const materialOptionsList = materialSelectDiv.querySelector(`#deliverMaterialOptionsList_${itemId}`);
            Object.keys(window.warehouseInventory[warehouseId] || {}).forEach(materialId => {
                const material = window.materials.find(m => m.id === materialId);
                if (material && window.warehouseInventory[warehouseId][materialId] > 0) {
                    const availableQty = window.warehouseInventory[warehouseId][materialId];
                    const option = document.createElement('div');
                    option.className = 'option-item';
                    option.dataset.value = material.id;
                    option.dataset.name = material.name;
                    option.textContent = `${material.code || ''} - ${material.name}${material.secondName ? ' (' + material.secondName + ')' : ''} (Ù…ØªÙˆÙØ±: ${availableQty})`;
                    option.onclick = function() {
                        selectDeliverMaterial(itemId, material.id, material.name, material.unit, material.subUnit, availableQty);
                    };
                    materialOptionsList.appendChild(option);
                }
            });

            const quantityInput = document.createElement('input');
            quantityInput.type = 'number';
            quantityInput.className = 'quantity-input';
            quantityInput.min = '0';
            quantityInput.step = '0.001';
            quantityInput.placeholder = 'Ø§Ù„ÙƒÙ…ÙŠØ©';
            quantityInput.style.width = '120px';
            quantityInput.id = `deliverQuantity_${itemId}`;
            
            // Add validation on input (will be set after material selection)
            quantityInput.onchange = function() {
                const materialId = this.dataset.materialId;
                if (!materialId) return;
                
                const material = window.materials.find(m => m.id === materialId);
                if (!material) return;
                
                const unitSelect = document.getElementById(`deliverUnitSelect_${itemId}`);
                if (!unitSelect) return;
                
                const enteredQty = parseFloat(this.value) || 0;
                const selectedUnit = unitSelect.value;
                
                // Convert to base unit for comparison
                let baseQty = enteredQty;
                if (selectedUnit === material.subUnit && material.conversion && material.conversionType) {
                    if (material.conversionType === 'multiply') {
                        baseQty = enteredQty * material.conversion;
                    } else if (material.conversionType === 'divide') {
                        baseQty = enteredQty / material.conversion;
                    }
                }
                
                const availableBaseQty = parseFloat(this.dataset.availableBaseQty) || 0;
                if (baseQty > availableBaseQty) {
                    this.style.borderColor = 'red';
                    showModalAlert('deliverModal', `Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (${baseQty.toFixed(3)}) Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…ØªÙˆÙØ± (${availableBaseQty.toFixed(3)})`, 'error');
                } else {
                    this.style.borderColor = '';
                }
            };

            // Unit select (will be updated based on selected material)
            const unitSelect = document.createElement('select');
            unitSelect.id = `deliverUnitSelect_${itemId}`;
            unitSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹</option>';
            unitSelect.style.width = '150px';
            unitSelect.disabled = true;

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn-danger btn-small';
            removeBtn.textContent = 'Ø­Ø°Ù';
            removeBtn.onclick = function() {
                itemRow.remove();
            };

            const itemRow = document.createElement('div');
            itemRow.className = 'item-row';
            itemRow.style.display = 'flex';
            itemRow.style.gap = '10px';
            itemRow.style.alignItems = 'center';
            itemRow.style.marginBottom = '10px';
            itemRow.style.padding = '10px';
            itemRow.style.border = '1px solid #ddd';
            itemRow.style.borderRadius = '8px';
            
            itemRow.appendChild(materialSelectDiv);
            itemRow.appendChild(quantityInput);
            itemRow.appendChild(unitSelect);
            itemRow.appendChild(removeBtn);

            document.getElementById('deliverItemsList').appendChild(itemRow);
            itemRow.scrollIntoView({ behavior: 'smooth', block: 'start' });
        };

        function selectDeliverMaterial(itemId, materialId, materialName, baseUnit, subUnit, availableQty) {
            const materialDisplay = document.getElementById(`deliverMaterialDisplay_${itemId}`);
            const materialHidden = document.getElementById(`deliverMaterialId_${itemId}`);
            const unitSelect = document.getElementById(`deliverUnitSelect_${itemId}`);
            const materialOptions = document.getElementById(`deliverMaterialOptions_${itemId}`);
            const quantityInput = document.getElementById(`deliverQuantity_${itemId}`);
            const selectedValue = materialDisplay.parentElement;
            
            const material = window.materials.find(m => m.id === materialId);
            
            materialDisplay.textContent = `${materialName} (Ù…ØªÙˆÙØ±: ${availableQty} ${baseUnit || ''})`;
            materialHidden.value = materialId;
            selectedValue.classList.remove('empty');
            materialOptions.classList.remove('show');
            
            // Store available quantity in base unit for later use
            if (quantityInput) {
                quantityInput.dataset.availableBaseQty = availableQty;
                quantityInput.dataset.materialId = materialId;
            }
            
            // Update unit select based on material
            unitSelect.innerHTML = '';
            unitSelect.disabled = false;
            
            // Add base unit
            if (baseUnit) {
                const option = document.createElement('option');
                option.value = baseUnit;
                option.textContent = baseUnit;
                option.selected = true;
                unitSelect.appendChild(option);
            }
            
            // Add sub unit if exists
            if (subUnit) {
                const option = document.createElement('option');
                option.value = subUnit;
                option.textContent = subUnit;
                unitSelect.appendChild(option);
            }
            
            // Function to update max quantity based on selected unit
            const updateMaxQuantity = function() {
                if (!quantityInput || !material) return;
                
                const selectedUnit = unitSelect.value;
                const baseAvailableQty = parseFloat(quantityInput.dataset.availableBaseQty) || 0;
                
                if (selectedUnit === material.subUnit && material.conversion && material.conversionType) {
                    // Convert available quantity to sub-unit for max
                    let maxQty;
                    if (material.conversionType === 'multiply') {
                        // Ø¶Ø±Ø¨: 1 ÙˆØ­Ø¯Ø© ÙØ±Ø¹ÙŠØ© = Ø§Ù„ØªØ¹Ø§Ø¯Ù„ Ã— ÙˆØ­Ø¯Ø© Ø£Ø³Ø§Ø³ÙŠØ©
                        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…ØªÙˆÙØ± ÙÙŠ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©ØŒ ÙÙÙŠ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ© = Ø§Ù„Ù…ØªÙˆÙØ± / Ø§Ù„ØªØ¹Ø§Ø¯Ù„
                        maxQty = baseAvailableQty / material.conversion;
                    } else if (material.conversionType === 'divide') {
                        // Ù‚Ø³Ù…Ø©: Ø§Ù„ØªØ¹Ø§Ø¯Ù„ ÙˆØ­Ø¯Ø© ÙØ±Ø¹ÙŠØ© = 1 ÙˆØ­Ø¯Ø© Ø£Ø³Ø§Ø³ÙŠØ©
                        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…ØªÙˆÙØ± ÙÙŠ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©ØŒ ÙÙÙŠ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ© = Ø§Ù„Ù…ØªÙˆÙØ± Ã— Ø§Ù„ØªØ¹Ø§Ø¯Ù„
                        maxQty = baseAvailableQty * material.conversion;
                    } else {
                        maxQty = baseAvailableQty;
                    }
                    quantityInput.max = maxQty;
                    // Update display with available in selected unit
                    materialDisplay.textContent = `${materialName} (Ù…ØªÙˆÙØ±: ${maxQty.toFixed(3)} ${selectedUnit})`;
                } else {
                    // Base unit selected
                    quantityInput.max = baseAvailableQty;
                    materialDisplay.textContent = `${materialName} (Ù…ØªÙˆÙØ±: ${baseAvailableQty} ${baseUnit || ''})`;
                }
            };
            
            // Set initial max quantity
            updateMaxQuantity();
            
            // Update max quantity when unit changes
            unitSelect.onchange = updateMaxQuantity;
        }

        window.toggleDeliverMaterialOptions = function(itemId) {
            const options = document.getElementById(`deliverMaterialOptions_${itemId}`);
            const isOpening = !options.classList.contains('show');
            if (isOpening) {
                const itemRow = options.closest('.item-row');
                const trigger = options.parentElement?.querySelector('.selected-value');
                if (itemRow && trigger) {
                    itemRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    options.classList.add('floating');
                    const rect = trigger.getBoundingClientRect();
                    const dropdownHeight = 220;
                    const gap = 4;
                    if (rect.bottom + dropdownHeight + gap <= window.innerHeight - 20) {
                        options.style.top = (rect.bottom + gap) + 'px';
                        options.style.bottom = 'auto';
                        options.style.boxShadow = '0 5px 15px rgba(0,0,0,0.2)';
                    } else {
                        options.style.top = 'auto';
                        options.style.bottom = (window.innerHeight - rect.top + gap) + 'px';
                        options.style.boxShadow = '0 -5px 15px rgba(0,0,0,0.2)';
                    }
                    options.style.left = rect.left + 'px';
                    options.style.width = rect.width + 'px';
                }
            } else {
                options.classList.remove('floating');
                options.style.top = options.style.bottom = options.style.left = options.style.width = options.style.boxShadow = '';
            }
            options.classList.toggle('show');
        };

        window.filterDeliverMaterialOptions = function(itemId) {
            const search = document.getElementById(`deliverMaterialSearch_${itemId}`).value.toLowerCase();
            const options = document.querySelectorAll(`#deliverMaterialOptionsList_${itemId} .option-item`);
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                option.style.display = text.includes(search) ? 'block' : 'none';
            });
        };

        async function addDeliverItemForEdit(item, warehouseId) {
            const itemId = 'deliver_item_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const material = window.materials.find(m => m.id === item.materialId);
            
            // Get available quantity from inventory + add old quantity (will be returned on save)
            const baseAvailableQty = window.warehouseInventory[warehouseId]?.[item.materialId] || 0;
            const oldQty = item.quantity || 0;
            const availableQty = baseAvailableQty + oldQty; // Add old quantity since it will be returned
            
            // Material searchable select
            const materialSelectDiv = document.createElement('div');
            materialSelectDiv.className = 'searchable-select';
            materialSelectDiv.style.width = '100%';
            materialSelectDiv.innerHTML = `
                <div class="selected-value" onclick="toggleDeliverMaterialOptions('${itemId}')">
                    <span id="deliverMaterialDisplay_${itemId}">${material ? `${material.name} (Ù…ØªÙˆÙØ±: ${availableQty})` : 'Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©'}</span>
                </div>
                <div class="options-list" id="deliverMaterialOptions_${itemId}">
                    <input type="text" id="deliverMaterialSearch_${itemId}" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø§Ø¯Ø©..." onkeyup="filterDeliverMaterialOptions('${itemId}')" onclick="event.stopPropagation()">
                    <div id="deliverMaterialOptionsList_${itemId}"></div>
                </div>
                <input type="hidden" id="deliverMaterialId_${itemId}" class="deliver-material-select" value="${item.materialId}">
            `;
            
            // Populate material options
            // Use querySelector on the div itself since it's not in DOM yet
            const materialOptionsList = materialSelectDiv.querySelector(`#deliverMaterialOptionsList_${itemId}`);
            const addedMaterials = new Set();
            
            // Add current material first (even if not in inventory)
            if (material) {
                const baseAvail = window.warehouseInventory[warehouseId]?.[item.materialId] || 0;
                const availQty = baseAvail + oldQty;
                const option = document.createElement('div');
                option.className = 'option-item';
                option.dataset.value = material.id;
                option.dataset.name = material.name;
                option.textContent = `${material.code || ''} - ${material.name}${material.secondName ? ' (' + material.secondName + ')' : ''} (Ù…ØªÙˆÙØ±: ${availQty})`;
                option.onclick = function() {
                    selectDeliverMaterial(itemId, material.id, material.name, material.unit, material.subUnit, availQty);
                };
                materialOptionsList.appendChild(option);
                addedMaterials.add(material.id);
            }
            
            // Add other materials from inventory
            Object.keys(window.warehouseInventory[warehouseId] || {}).forEach(materialId => {
                if (addedMaterials.has(materialId)) return;
                const m = window.materials.find(mat => mat.id === materialId);
                if (m && window.warehouseInventory[warehouseId][materialId] > 0) {
                    const availQty = window.warehouseInventory[warehouseId][materialId];
                    const option = document.createElement('div');
                    option.className = 'option-item';
                    option.dataset.value = m.id;
                    option.dataset.name = m.name;
                    option.textContent = `${m.code || ''} - ${m.name}${m.secondName ? ' (' + m.secondName + ')' : ''} (Ù…ØªÙˆÙØ±: ${availQty})`;
                    option.onclick = function() {
                        selectDeliverMaterial(itemId, m.id, m.name, m.unit, m.subUnit, availQty);
                    };
                    materialOptionsList.appendChild(option);
                }
            });

            // Quantity - use entered quantity if available, otherwise use base quantity
            const quantityInput = document.createElement('input');
            quantityInput.type = 'number';
            quantityInput.className = 'quantity-input';
            quantityInput.min = '0';
            quantityInput.step = '0.001';
            quantityInput.placeholder = 'Ø§Ù„ÙƒÙ…ÙŠØ©';
            quantityInput.style.width = '120px';
            quantityInput.id = `deliverQuantity_${itemId}`;
            quantityInput.value = item.enteredQuantity !== undefined ? item.enteredQuantity : item.quantity;
            
            // Store available quantity in base unit
            if (material) {
                quantityInput.dataset.availableBaseQty = availableQty;
                quantityInput.dataset.materialId = material.id;
            }
            
            // Add validation on input
            quantityInput.onchange = function() {
                const materialId = this.dataset.materialId;
                if (!materialId) return;
                
                const mat = window.materials.find(m => m.id === materialId);
                if (!mat) return;
                
                const enteredQty = parseFloat(this.value) || 0;
                const selectedUnit = unitSelect.value;
                
                // Convert to base unit for comparison
                let baseQty = enteredQty;
                if (selectedUnit === mat.subUnit && mat.conversion && mat.conversionType) {
                    if (mat.conversionType === 'multiply') {
                        baseQty = enteredQty * mat.conversion;
                    } else if (mat.conversionType === 'divide') {
                        baseQty = enteredQty / mat.conversion;
                    }
                }
                
                const availableBaseQty = parseFloat(this.dataset.availableBaseQty) || 0;
                if (baseQty > availableBaseQty) {
                    this.style.borderColor = 'red';
                    showModalAlert('deliverModal', `Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (${baseQty.toFixed(3)}) Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…ØªÙˆÙØ± (${availableBaseQty.toFixed(3)})`, 'error');
                } else {
                    this.style.borderColor = '';
                }
            };

            // Unit select
            const unitSelect = document.createElement('select');
            unitSelect.id = `deliverUnitSelect_${itemId}`;
            unitSelect.style.width = '150px';
            
            // Function to update max quantity based on selected unit
            const updateMaxQuantityForEdit = function() {
                if (!quantityInput || !material) return;
                
                const selectedUnit = unitSelect.value;
                const baseAvailableQty = parseFloat(quantityInput.dataset.availableBaseQty) || 0;
                
                if (selectedUnit === material.subUnit && material.conversion && material.conversionType) {
                    // Convert available quantity to sub-unit for max
                    let maxQty;
                    if (material.conversionType === 'multiply') {
                        maxQty = baseAvailableQty / material.conversion;
                    } else if (material.conversionType === 'divide') {
                        maxQty = baseAvailableQty * material.conversion;
                    } else {
                        maxQty = baseAvailableQty;
                    }
                    quantityInput.max = maxQty;
                    // Update display
                    const display = document.getElementById(`deliverMaterialDisplay_${itemId}`);
                    if (display) {
                        display.textContent = `${material.name} (Ù…ØªÙˆÙØ±: ${maxQty.toFixed(3)} ${selectedUnit})`;
                    }
                } else {
                    // Base unit selected
                    quantityInput.max = baseAvailableQty;
                    const display = document.getElementById(`deliverMaterialDisplay_${itemId}`);
                    if (display) {
                        display.textContent = `${material.name} (Ù…ØªÙˆÙØ±: ${availableQty} ${material.unit || ''})`;
                    }
                }
            };
            
            // Set unit based on material
            if (material) {
                if (material.unit) {
                    const baseOption = document.createElement('option');
                    baseOption.value = material.unit;
                    baseOption.textContent = material.unit;
                    if ((item.enteredUnit || item.unit) === material.unit) {
                        baseOption.selected = true;
                    }
                    unitSelect.appendChild(baseOption);
                }
                
                if (material.subUnit) {
                    const subOption = document.createElement('option');
                    subOption.value = material.subUnit;
                    subOption.textContent = material.subUnit;
                    if ((item.enteredUnit || item.unit) === material.subUnit) {
                        subOption.selected = true;
                    }
                    unitSelect.appendChild(subOption);
                }
                unitSelect.disabled = false;
                
                // Set initial max quantity and add change listener
                updateMaxQuantityForEdit();
                unitSelect.onchange = updateMaxQuantityForEdit;
            } else {
                unitSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹</option>';
                unitSelect.disabled = true;
            }

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn-danger btn-small';
            removeBtn.textContent = 'Ø­Ø°Ù';
            removeBtn.onclick = function() {
                itemRow.remove();
            };

            const itemRow = document.createElement('div');
            itemRow.className = 'item-row';
            itemRow.style.display = 'flex';
            itemRow.style.gap = '10px';
            itemRow.style.alignItems = 'center';
            itemRow.style.marginBottom = '10px';
            itemRow.style.padding = '10px';
            itemRow.style.border = '1px solid #ddd';
            itemRow.style.borderRadius = '8px';
            
            itemRow.appendChild(materialSelectDiv);
            itemRow.appendChild(quantityInput);
            itemRow.appendChild(unitSelect);
            itemRow.appendChild(removeBtn);

            document.getElementById('deliverItemsList').appendChild(itemRow);
        }

        window.loadWarehouseInventory = async function(warehouseId, type) {
            if (!warehouseId) return;
            
            try {
                const { collection, getDocs, query, where } = window.firebaseCollections;
                const db = window.firebaseDb;
                
                // Load inventory for this warehouse
                const inventoryRef = collection(db, 'inventory');
                const q = query(inventoryRef, where('locationId', '==', warehouseId), where('locationType', '==', 'warehouse'));
                const snapshot = await getDocs(q);
                
                window.warehouseInventory[warehouseId] = {};
                snapshot.forEach((docSnapshot) => {
                    const data = docSnapshot.data();
                    window.warehouseInventory[warehouseId][data.materialId] = data.quantity || 0;
                });

                // Clear items list if deliver and not in edit mode
                if (type === 'deliver' && !window.editingDeliverId) {
                    document.getElementById('deliverItemsList').innerHTML = '';
                }
            } catch (error) {
                console.error('Error loading warehouse inventory:', error);
            }
        };

        async function saveDeliver(e) {
            e.preventDefault();
            const p = window.currentUserPermissions;
            const isEdit = !!window.editingDeliverId;
            if (p && !p.isAdmin) {
                if (isEdit && !p.deliverEdit) {
                    showModalAlert('deliverModal', 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…', 'error');
                    return;
                }
                if (!isEdit && !p.deliverAdd) {
                    showModalAlert('deliverModal', 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…', 'error');
                    return;
                }
            }
            const { addDoc, collection, Timestamp } = window.firebaseCollections;
            const db = window.firebaseDb;

            const items = [];
            const itemsList = document.getElementById('deliverItemsList');
            const itemRows = itemsList.querySelectorAll('.item-row');
            
            // Validate required fields first
            const warehouseId = document.getElementById('deliverWarehouse').value;
            const workSiteId = document.getElementById('deliverWorkSite').value;
            const deliverDate = document.getElementById('deliverDate').value;
            
            if (!warehouseId) {
                showModalAlert('deliverModal', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹', 'error');
                return;
            }
            
            if (!workSiteId) {
                showModalAlert('deliverModal', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„', 'error');
                return;
            }
            
            if (!deliverDate) {
                showModalAlert('deliverModal', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…', 'error');
                return;
            }
            
            // Get old items if editing (will be reused later)
            let oldData = null;
            let oldItemsMap = {};
            if (window.editingDeliverId) {
                try {
                    const { doc, getDoc } = window.firebaseCollections;
                    const oldDeliverDoc = await getDoc(doc(db, 'transactions', window.editingDeliverId));
                    if (oldDeliverDoc.exists()) {
                        oldData = oldDeliverDoc.data();
                        oldData.items?.forEach(oldItem => {
                            oldItemsMap[oldItem.materialId] = oldItem.quantity || 0;
                        });
                    }
                } catch (e) {
                    console.error('Error loading old deliver data:', e);
                }
            }
            
            let validationError = null;
            const materialQuantitiesMap = {}; // Track total quantities per material (to handle duplicates)
            
            for (let i = 0; i < itemRows.length; i++) {
                const row = itemRows[i];
                const materialHidden = row.querySelector('input.deliver-material-select');
                const quantityInput = row.querySelector('input[type="number"]');
                const unitSelect = row.querySelector('select');
                
                if (materialHidden && materialHidden.value && quantityInput && quantityInput.value) {
                    const material = window.materials.find(m => m.id === materialHidden.value);
                    if (!material) continue;
                    
                    const enteredQuantity = parseFloat(quantityInput.value);
                    const enteredUnit = unitSelect ? unitSelect.value : material.unit;
                    
                    // Convert to base unit if sub-unit is selected
                    let baseQuantity = enteredQuantity;
                    let baseUnit = material.unit;
                    
                    // Check if entered unit is sub-unit
                    if (enteredUnit === material.subUnit && material.conversion && material.conversionType) {
                        if (material.conversionType === 'multiply') {
                            baseQuantity = enteredQuantity * material.conversion;
                        } else if (material.conversionType === 'divide') {
                            baseQuantity = enteredQuantity / material.conversion;
                        }
                    }
                    
                    // Accumulate quantity for this material (in case same material appears multiple times)
                    if (!materialQuantitiesMap[materialHidden.value]) {
                        materialQuantitiesMap[materialHidden.value] = 0;
                    }
                    materialQuantitiesMap[materialHidden.value] += baseQuantity;
                    
                    items.push({
                        materialId: materialHidden.value,
                        materialName: material.name,
                        enteredQuantity: enteredQuantity,  // Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¯Ø®Ù„Ø©
                        enteredUnit: enteredUnit,          // Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø©
                        quantity: baseQuantity,            // Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø­ÙˆÙ„Ø© Ù„Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                        unit: baseUnit                     // Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                    });
                }
            }
            
            // Validate total quantities per material
            for (const materialId in materialQuantitiesMap) {
                const totalQuantity = materialQuantitiesMap[materialId];
                const material = window.materials.find(m => m.id === materialId);
                
                // Check available quantity in base unit (add old quantity if editing)
                let available = window.warehouseInventory[warehouseId]?.[materialId] || 0;
                if (window.editingDeliverId && oldItemsMap[materialId]) {
                    available += oldItemsMap[materialId]; // Add old quantity that will be returned
                }
                
                if (totalQuantity > available) {
                    validationError = `Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (${totalQuantity.toFixed(3)}) Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…ØªÙˆÙØ± (${available.toFixed(3)}) Ù„Ù„Ù…Ø§Ø¯Ø© ${material ? material.name : materialId}`;
                    break;
                }
            }
            
            if (validationError) {
                showModalAlert('deliverModal', validationError, 'error');
                return;
            }

            if (items.length === 0) {
                showModalAlert('deliverModal', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
                return;
            }

            const transactionData = {
                type: 'deliver',
                date: Timestamp.fromDate(new Date(deliverDate)),
                warehouseId: warehouseId,
                workSiteId: workSiteId,
                number: document.getElementById('deliverNumber').value || null,
                invoice: document.getElementById('deliverInvoice').value || null,
                items: items,
                notes: document.getElementById('deliverNotes').value,
                createdAt: window.editingDeliverId && oldData ? oldData.createdAt : Timestamp.now() // Preserve original createdAt when editing
            };

            try {
                const { addDoc, updateDoc, doc, collection } = window.firebaseCollections;
                
                if (window.editingDeliverId && oldData) {
                    // Edit mode: Reverse old inventory changes, then apply new changes
                    // Reverse old inventory changes
                    if (oldData.items) {
                        for (const oldItem of oldData.items) {
                            await updateInventory(oldData.warehouseId, 'warehouse', oldItem.materialId, oldItem.quantity, oldItem.unit, 'add');
                            await updateInventory(oldData.workSiteId, 'workSite', oldItem.materialId, oldItem.quantity, oldItem.unit, 'subtract');
                        }
                    }
                    
                    // Update transaction
                    const { Timestamp } = window.firebaseCollections;
                    await updateDoc(doc(db, 'transactions', window.editingDeliverId), {
                        ...transactionData,
                        updatedAt: Timestamp.now()
                    });
                    
                    // Apply new inventory changes
                    for (const item of items) {
                        await updateInventory(transactionData.warehouseId, 'warehouse', item.materialId, item.quantity, item.unit, 'subtract');
                        await updateInventory(transactionData.workSiteId, 'workSite', item.materialId, item.quantity, item.unit, 'add');
                    }
                    
                    // Log activity
                    await logActivity('update', 'transaction', window.editingDeliverId, `Ø¹Ù…Ù„ÙŠØ© ØªØ³Ù„ÙŠÙ… - ${transactionData.number || 'Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù…'}`, transactionData, oldData);
                    
                    showAlert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } else {
                    // Add mode: Just save and update inventory
                    const docRef = await addDoc(collection(db, 'transactions'), transactionData);

                    // Update inventory - remove from warehouse, add to work site
                    for (const item of items) {
                        await updateInventory(transactionData.warehouseId, 'warehouse', item.materialId, item.quantity, item.unit, 'subtract');
                        await updateInventory(transactionData.workSiteId, 'workSite', item.materialId, item.quantity, item.unit, 'add');
                    }
                    
                    // Log activity
                    await logActivity('create', 'transaction', docRef.id, `Ø¹Ù…Ù„ÙŠØ© ØªØ³Ù„ÙŠÙ… - ${transactionData.number || 'Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù…'}`, transactionData);
                    
                    showAlert('ØªÙ… Ø­ÙØ¸ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­', 'success');
                }

                document.getElementById('deliverForm').reset();
                document.getElementById('deliverItemsList').innerHTML = '';
                window.editingDeliverId = null;
                closeModal('deliverModal');
                await loadDashboard();
                await loadInventory();
                await loadDelivers(); // Reload delivers table
            } catch (error) {
                console.error('Error saving deliver:', error);
                showModalAlert('deliverModal', 'Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ù„ÙŠÙ…', 'error');
            }
        }

        // ========== TRANSACTIONS: RETURN ==========
        async function generateReturnNumber() {
            try {
                const { collection, getDocs, query, where } = window.firebaseCollections;
                const db = window.firebaseDb;

                const transactionsRef = collection(db, 'transactions');
                const q = query(transactionsRef, where('type', '==', 'return'));
                const snapshot = await getDocs(q);

                // Extract numbers from existing return numbers
                const existingNumbers = [];
                snapshot.forEach((docSnapshot) => {
                    const data = docSnapshot.data();
                    if (data.number) {
                        // Extract number from format like RET-001, RET-002, etc.
                        const match = data.number.match(/RET-(\d+)/);
                        if (match) {
                            const num = parseInt(match[1]);
                            if (!isNaN(num)) {
                                existingNumbers.push(num);
                            }
                        }
                    }
                });

                // Find the next available number starting from 001
                let nextNumber = 1;
                if (existingNumbers.length > 0) {
                    const maxNumber = Math.max(...existingNumbers);
                    nextNumber = maxNumber + 1;
                }

                return `RET-${nextNumber.toString().padStart(3, '0')}`; // Format as RET-001, RET-002, etc.
            } catch (error) {
                console.error('Error generating return number:', error);
                // Fallback: use timestamp-based number
                return `RET-${Date.now().toString().slice(-6)}`;
            }
        }

        window.showReturnModal = async function(returnId = null) {
            const p = window.currentUserPermissions;
            if (p && !p.isAdmin) {
                if (returnId && !p.returnEdit) {
                    showAlert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯', 'error');
                    return;
                }
                if (!returnId && !p.returnAdd) {
                    showAlert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯', 'error');
                    return;
                }
            }
            const modal = document.getElementById('returnModal');
            const form = document.getElementById('returnForm');
            const returnAlertEl = document.getElementById('returnModalAlert');
            if (returnAlertEl) { returnAlertEl.style.display = 'none'; returnAlertEl.textContent = ''; }
            window.editingReturnId = returnId;
            
            // Ensure data is loaded
            if (!window.warehouses || window.warehouses.length === 0) {
                await loadWarehouses();
            }
            if (!window.workSites || window.workSites.length === 0) {
                await loadWorkSites();
            }
            if (!window.materials || window.materials.length === 0) {
                await loadMaterials();
            }
            if (!window.units || window.units.length === 0) {
                await loadUnits();
            }
            
            if (returnId) {
                // Edit mode - load existing data
                await loadReturnForEdit(returnId);
                document.getElementById('returnModalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ø³ØªØ±Ø¯Ø§Ø¯';
            } else {
                // Add mode - reset form
                form.reset();
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('returnDate').value = today;
                document.getElementById('returnItemsList').innerHTML = '';
                
                // Generate return number automatically
                const returnNumber = await generateReturnNumber();
                document.getElementById('returnNumber').value = returnNumber;
                
                // Clear invoice field for new return
                document.getElementById('returnInvoice').value = '';
                
                document.getElementById('returnModalTitle').textContent = 'Ø¥Ø¶Ø§ÙØ© Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø¬Ø¯ÙŠØ¯';
            }
            
            modal.classList.add('active');
        };

        window.loadReturns = async function() {
            try {
                // Ensure data is loaded
                if (!window.warehouses || window.warehouses.length === 0) {
                    await loadWarehouses();
                }
                if (!window.workSites || window.workSites.length === 0) {
                    await loadWorkSites();
                }
                
                const { collection, getDocs, query, where } = window.firebaseCollections;
                const db = window.firebaseDb;

                const transactionsRef = collection(db, 'transactions');
                const q = query(transactionsRef, where('type', '==', 'return'));
                
                const snapshot = await getDocs(q);
                
                const tbody = document.getElementById('returnsTableBody');
                if (!tbody) {
                    console.log('returnsTableBody not found');
                    return;
                }
                
                tbody.innerHTML = '';

                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ø³ØªØ±Ø¯Ø§Ø¯</td></tr>';
                    return;
                }

                // Convert to array and sort by createdAt descending
                const returns = [];
                snapshot.forEach((docSnapshot) => {
                    const data = docSnapshot.data();
                    // Filter by permissions (check both warehouse and work site access)
                    if (window.hasWarehouseAccess && window.hasWorkSiteAccess && 
                        window.hasWarehouseAccess(data.warehouseId) && 
                        window.hasWorkSiteAccess(data.workSiteId)) {
                        returns.push({
                            id: docSnapshot.id,
                            ...data,
                            createdAtTimestamp: data.createdAt ? (data.createdAt.toDate ? data.createdAt.toDate().getTime() : new Date(data.createdAt).getTime()) : 0
                        });
                    }
                });

                // Sort by createdAt descending (newest first)
                returns.sort((a, b) => b.createdAtTimestamp - a.createdAtTimestamp);

                // Display sorted results
                const p = window.currentUserPermissions;
                const canEditReturn = p && (p.isAdmin || p.returnEdit === true);
                const canDeleteReturn = p && (p.isAdmin || p.returnDelete === true);
                returns.forEach(returnTrans => {
                    const warehouse = window.warehouses.find(w => w.id === returnTrans.warehouseId);
                    const workSite = window.workSites.find(w => w.id === returnTrans.workSiteId);
                    
                    const dateStr = window.formatDate(returnTrans.date);
                    const actions = `
                        <button class="btn btn-success btn-small" onclick="viewReturnDetails('${returnTrans.id}')">Ø¹Ø±Ø¶</button>
                        <button class="btn btn-info btn-small" onclick="printReturn('${returnTrans.id}')" style="background-color: #17a2b8; color: white;">Ø·Ø¨Ø§Ø¹Ø©</button>
                        ${canEditReturn ? `<button class="btn btn-warning btn-small" onclick="editReturn('${returnTrans.id}')">ØªØ¹Ø¯ÙŠÙ„</button>` : ''}
                        ${canDeleteReturn ? `<button class="btn btn-danger btn-small" onclick="deleteReturn('${returnTrans.id}')">Ø­Ø°Ù</button>` : ''}
                    `;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${returnTrans.number || '-'}</td>
                        <td>${dateStr}</td>
                        <td>${workSite ? workSite.name : '-'}</td>
                        <td>${warehouse ? warehouse.name : '-'}</td>
                        <td>${returnTrans.items?.length || 0}</td>
                        <td>${returnTrans.notes || '-'}</td>
                        <td>${actions}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading returns:', error);
                const tbody = document.getElementById('returnsTableBody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: red;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯</td></tr>';
                }
            }
            updateManagementButtonsVisibility();
        };

        window.filterReturns = function() {
            const search = document.getElementById('searchReturns').value.toLowerCase();
            const tbody = document.getElementById('returnsTableBody');
            if (!tbody) return;
            
            const rows = tbody.querySelectorAll('tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        };

        window.addReturnItem = function() {
            const workSiteId = document.getElementById('returnWorkSite').value;
            if (!workSiteId) {
                showModalAlert('returnModal', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„ Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }

            const materialSelect = document.createElement('select');
            materialSelect.className = 'form-group';
            materialSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</option>';
            
            // Filter materials that exist in work site inventory
            Object.keys(window.workSiteInventory[workSiteId] || {}).forEach(materialId => {
                const material = window.materials.find(m => m.id === materialId);
                if (material && window.workSiteInventory[workSiteId][materialId] > 0) {
                    const option = document.createElement('option');
                    option.value = material.id;
                    option.textContent = `${material.name}`;
                    materialSelect.appendChild(option);
                }
            });

            const quantityInput = document.createElement('input');
            quantityInput.type = 'number';
            quantityInput.className = 'quantity-input';
            quantityInput.min = '0';
            quantityInput.step = '0.001';
            quantityInput.placeholder = 'Ø§Ù„ÙƒÙ…ÙŠØ©';
            quantityInput.style.width = '120px';
            const itemId = 'return_item_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            quantityInput.id = `returnQuantity_${itemId}`;

            // Unit select (will be updated based on selected material)
            const unitSelect = document.createElement('select');
            unitSelect.id = `returnUnitSelect_${itemId}`;
            unitSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹</option>';
            unitSelect.style.width = '150px';
            unitSelect.disabled = true;

            // Available quantity display
            const availableDisplay = document.createElement('span');
            availableDisplay.id = `returnAvailable_${itemId}`;
            availableDisplay.style.fontSize = '12px';
            availableDisplay.style.color = '#666';
            availableDisplay.style.marginRight = '5px';
            availableDisplay.textContent = '';

            materialSelect.onchange = function() {
                const material = window.materials.find(m => m.id === materialSelect.value);
                if (material) {
                    // Update unit select based on material
                    unitSelect.innerHTML = '';
                    unitSelect.disabled = false;
                    
                    // Add base unit
                    if (material.unit) {
                        const option = document.createElement('option');
                        option.value = material.unit;
                        option.textContent = material.unit;
                        option.selected = true;
                        unitSelect.appendChild(option);
                    }
                    
                    // Add sub unit if exists
                    if (material.subUnit) {
                        const option = document.createElement('option');
                        option.value = material.subUnit;
                        option.textContent = material.subUnit;
                        unitSelect.appendChild(option);
                    }
                    
                    // Update max quantity based on available (in base unit)
                    const availableBaseQty = window.workSiteInventory[workSiteId]?.[materialSelect.value] || 0;
                    quantityInput.max = availableBaseQty;
                    
                    // Store available quantity in base unit for later use
                    quantityInput.dataset.availableBaseQty = availableBaseQty;
                    quantityInput.dataset.materialId = material.id;
                    
                    // Get delivered and returned quantities for display
                    const deliveredBaseQty = (window.workSiteDeliveredQuantities && window.workSiteDeliveredQuantities[workSiteId] && window.workSiteDeliveredQuantities[workSiteId][materialSelect.value]) || 0;
                    const returnedBaseQty = (window.workSiteReturnedQuantities && window.workSiteReturnedQuantities[workSiteId] && window.workSiteReturnedQuantities[workSiteId][materialSelect.value]) || 0;
                    
                    // Store delivered quantity for use in display
                    quantityInput.dataset.deliveredBaseQty = deliveredBaseQty;
                    quantityInput.dataset.returnedBaseQty = returnedBaseQty;
                    
                    // Function to update available display
                    const updateAvailableDisplay = function() {
                        const selectedUnit = unitSelect.value;
                        const baseAvailableQty = parseFloat(quantityInput.dataset.availableBaseQty) || 0;
                        const deliveredBaseQty = parseFloat(quantityInput.dataset.deliveredBaseQty) || 0;
                        const returnedBaseQty = parseFloat(quantityInput.dataset.returnedBaseQty) || 0;
                        
                        let displayAvailable, displayDelivered, displayReturned;
                        let unitSymbol = material.unit || '';
                        
                        if (selectedUnit === material.subUnit && material.conversion && material.conversionType) {
                            // Convert all quantities to sub-unit
                            if (material.conversionType === 'multiply') {
                                displayAvailable = baseAvailableQty / material.conversion;
                                displayDelivered = deliveredBaseQty / material.conversion;
                                displayReturned = returnedBaseQty / material.conversion;
                            } else if (material.conversionType === 'divide') {
                                displayAvailable = baseAvailableQty * material.conversion;
                                displayDelivered = deliveredBaseQty * material.conversion;
                                displayReturned = returnedBaseQty * material.conversion;
                            } else {
                                displayAvailable = baseAvailableQty;
                                displayDelivered = deliveredBaseQty;
                                displayReturned = returnedBaseQty;
                            }
                            unitSymbol = selectedUnit;
                        } else {
                            displayAvailable = baseAvailableQty;
                            displayDelivered = deliveredBaseQty;
                            displayReturned = returnedBaseQty;
                            unitSymbol = material.unit || '';
                        }
                        
                        availableDisplay.innerHTML = `
                            <div style="font-size: 11px; line-height: 1.4;">
                                <div><strong>Ù…Ø³Ù„Ù…Ø©:</strong> ${displayDelivered.toFixed(3)} ${unitSymbol}</div>
                                <div><strong>Ù…Ø³ØªØ±Ø¯Ø©:</strong> ${displayReturned.toFixed(3)} ${unitSymbol}</div>
                                <div style="color: #007bff; font-weight: bold;"><strong>Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯:</strong> ${displayAvailable.toFixed(3)} ${unitSymbol}</div>
                            </div>
                        `;
                    };
                    
                    // Initial display
                    updateAvailableDisplay();
                    
                    // Update max and display when unit changes
                    unitSelect.onchange = function() {
                        const selectedUnit = unitSelect.value;
                        const baseAvailableQty = parseFloat(quantityInput.dataset.availableBaseQty) || 0;
                        
                        if (selectedUnit === material.subUnit && material.conversion && material.conversionType) {
                            let maxQty;
                            if (material.conversionType === 'multiply') {
                                maxQty = baseAvailableQty / material.conversion;
                            } else if (material.conversionType === 'divide') {
                                maxQty = baseAvailableQty * material.conversion;
                            } else {
                                maxQty = baseAvailableQty;
                            }
                            quantityInput.max = maxQty;
                        } else {
                            quantityInput.max = baseAvailableQty;
                        }
                        
                        // Update display
                        updateAvailableDisplay();
                    };
                }
            };

            const reasonSelect = document.createElement('select');
            reasonSelect.innerHTML = `
                <option value="Ø²Ø§Ø¦Ø¯Ø©">Ø²Ø§Ø¦Ø¯Ø©</option>
                <option value="ØªØ§Ù„Ù">ØªØ§Ù„Ù</option>
                <option value="ØºÙŠØ± Ù…Ù†Ø§Ø³Ø¨">ØºÙŠØ± Ù…Ù†Ø§Ø³Ø¨</option>
                <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
            `;

            const statusSelect = document.createElement('select');
            statusSelect.innerHTML = `
                <option value="Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…">Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</option>
                <option value="ØªØ§Ù„Ù">ØªØ§Ù„Ù</option>
            `;

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn-danger btn-small';
            removeBtn.textContent = 'Ø­Ø°Ù';
            removeBtn.onclick = function() {
                itemRow.remove();
            };

            const itemRow = document.createElement('div');
            itemRow.className = 'item-row';
            itemRow.style.display = 'flex';
            itemRow.style.gap = '10px';
            itemRow.style.alignItems = 'center';
            itemRow.style.marginBottom = '10px';
            itemRow.style.padding = '10px';
            itemRow.style.border = '1px solid #ddd';
            itemRow.style.borderRadius = '8px';
            
            itemRow.appendChild(materialSelect);
            const quantityContainer = document.createElement('div');
            quantityContainer.style.display = 'flex';
            quantityContainer.style.flexDirection = 'column';
            quantityContainer.style.gap = '3px';
            quantityContainer.appendChild(quantityInput);
            quantityContainer.appendChild(availableDisplay);
            itemRow.appendChild(quantityContainer);
            itemRow.appendChild(unitSelect);
            itemRow.appendChild(reasonSelect);
            itemRow.appendChild(statusSelect);
            itemRow.appendChild(removeBtn);

            document.getElementById('returnItemsList').appendChild(itemRow);
        };

        function addReturnItemForEdit(item, workSiteId) {
            if (!item || !item.materialId) {
                console.error('Invalid item data for edit');
                return;
            }
            
            const material = window.materials.find(m => m.id === item.materialId);
            if (!material) {
                console.error('Material not found:', item.materialId);
                return;
            }
            
            const itemId = 'return_item_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // Get available quantity (add old quantity since it will be returned)
            const baseAvailableQty = window.workSiteInventory[workSiteId]?.[item.materialId] || 0;
            const oldQty = item.quantity || 0;
            const availableQty = baseAvailableQty + oldQty;
            
            const materialSelect = document.createElement('select');
            materialSelect.className = 'form-group';
            materialSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</option>';
            
            // Add current material
            const option = document.createElement('option');
            option.value = material.id;
            option.selected = true;
            option.textContent = material.name;
            materialSelect.appendChild(option);
            
            const quantityInput = document.createElement('input');
            quantityInput.type = 'number';
            quantityInput.className = 'quantity-input';
            quantityInput.min = '0';
            quantityInput.step = '0.001';
            quantityInput.placeholder = 'Ø§Ù„ÙƒÙ…ÙŠØ©';
            quantityInput.style.width = '120px';
            quantityInput.id = `returnQuantity_${itemId}`;
            quantityInput.value = item.enteredQuantity !== undefined ? item.enteredQuantity : item.quantity;
            quantityInput.max = availableQty;
            quantityInput.dataset.availableBaseQty = availableQty;
            quantityInput.dataset.materialId = material.id;
            
            // Available quantity display
            const availableDisplay = document.createElement('span');
            availableDisplay.id = `returnAvailable_${itemId}`;
            availableDisplay.style.fontSize = '12px';
            availableDisplay.style.color = '#666';
            availableDisplay.style.marginRight = '5px';
            
            // Unit select
            const unitSelect = document.createElement('select');
            unitSelect.id = `returnUnitSelect_${itemId}`;
            unitSelect.style.width = '150px';
            
            const enteredUnit = item.enteredUnit || item.unit || material.unit;
            
            if (material.unit) {
                const baseOption = document.createElement('option');
                baseOption.value = material.unit;
                baseOption.textContent = material.unit;
                if (enteredUnit === material.unit) {
                    baseOption.selected = true;
                }
                unitSelect.appendChild(baseOption);
            }
            
            if (material.subUnit) {
                const subOption = document.createElement('option');
                subOption.value = material.subUnit;
                subOption.textContent = material.subUnit;
                if (enteredUnit === material.subUnit) {
                    subOption.selected = true;
                }
                unitSelect.appendChild(subOption);
            }
            unitSelect.disabled = false;
            
            // Get delivered and returned quantities for display
            const deliveredBaseQty = (window.workSiteDeliveredQuantities && window.workSiteDeliveredQuantities[workSiteId] && window.workSiteDeliveredQuantities[workSiteId][item.materialId]) || 0;
            const returnedBaseQty = (window.workSiteReturnedQuantities && window.workSiteReturnedQuantities[workSiteId] && window.workSiteReturnedQuantities[workSiteId][item.materialId]) || 0;
            // Add old returned quantity back for display (since it will be returned)
            const actualReturnedBaseQty = returnedBaseQty + oldQty;
            
            // Store delivered quantity for use in display
            quantityInput.dataset.deliveredBaseQty = deliveredBaseQty;
            quantityInput.dataset.returnedBaseQty = actualReturnedBaseQty;
            
            // Function to update available display
            const updateAvailableDisplay = function() {
                const selectedUnit = unitSelect.value;
                const baseAvailableQty = parseFloat(quantityInput.dataset.availableBaseQty) || 0;
                const deliveredBaseQty = parseFloat(quantityInput.dataset.deliveredBaseQty) || 0;
                const returnedBaseQty = parseFloat(quantityInput.dataset.returnedBaseQty) || 0;
                
                let displayAvailable, displayDelivered, displayReturned;
                let unitSymbol = material.unit || '';
                
                if (selectedUnit === material.subUnit && material.conversion && material.conversionType) {
                    // Convert all quantities to sub-unit
                    if (material.conversionType === 'multiply') {
                        displayAvailable = baseAvailableQty / material.conversion;
                        displayDelivered = deliveredBaseQty / material.conversion;
                        displayReturned = returnedBaseQty / material.conversion;
                    } else if (material.conversionType === 'divide') {
                        displayAvailable = baseAvailableQty * material.conversion;
                        displayDelivered = deliveredBaseQty * material.conversion;
                        displayReturned = returnedBaseQty * material.conversion;
                    } else {
                        displayAvailable = baseAvailableQty;
                        displayDelivered = deliveredBaseQty;
                        displayReturned = returnedBaseQty;
                    }
                    unitSymbol = selectedUnit;
                } else {
                    displayAvailable = baseAvailableQty;
                    displayDelivered = deliveredBaseQty;
                    displayReturned = returnedBaseQty;
                    unitSymbol = material.unit || '';
                }
                
                availableDisplay.innerHTML = `
                    <div style="font-size: 11px; line-height: 1.4;">
                        <div><strong>Ù…Ø³Ù„Ù…Ø©:</strong> ${displayDelivered.toFixed(3)} ${unitSymbol}</div>
                        <div><strong>Ù…Ø³ØªØ±Ø¯Ø©:</strong> ${displayReturned.toFixed(3)} ${unitSymbol}</div>
                        <div style="color: #007bff; font-weight: bold;"><strong>Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯:</strong> ${displayAvailable.toFixed(3)} ${unitSymbol}</div>
                    </div>
                `;
            };
            
            // Initial display
            updateAvailableDisplay();
            
            // Update max and display when unit changes
            unitSelect.onchange = function() {
                const selectedUnit = unitSelect.value;
                const baseAvailableQty = parseFloat(quantityInput.dataset.availableBaseQty) || 0;
                
                if (selectedUnit === material.subUnit && material.conversion && material.conversionType) {
                    let maxQty;
                    if (material.conversionType === 'multiply') {
                        maxQty = baseAvailableQty / material.conversion;
                    } else if (material.conversionType === 'divide') {
                        maxQty = baseAvailableQty * material.conversion;
                    } else {
                        maxQty = baseAvailableQty;
                    }
                    quantityInput.max = maxQty;
                } else {
                    quantityInput.max = baseAvailableQty;
                }
                
                // Update display
                updateAvailableDisplay();
            };
            
            const reasonSelect = document.createElement('select');
            reasonSelect.id = `returnReason_${itemId}`;
            reasonSelect.innerHTML = `
                <option value="Ø²Ø§Ø¦Ø¯Ø©">Ø²Ø§Ø¦Ø¯Ø©</option>
                <option value="ØªØ§Ù„Ù">ØªØ§Ù„Ù</option>
                <option value="ØºÙŠØ± Ù…Ù†Ø§Ø³Ø¨">ØºÙŠØ± Ù…Ù†Ø§Ø³Ø¨</option>
                <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
            `;
            if (item.reason) {
                reasonSelect.value = item.reason;
            }
            
            const statusSelect = document.createElement('select');
            statusSelect.id = `returnStatus_${itemId}`;
            statusSelect.innerHTML = `
                <option value="Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…">Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</option>
                <option value="ØªØ§Ù„Ù">ØªØ§Ù„Ù</option>
            `;
            if (item.status) {
                statusSelect.value = item.status;
            }
            
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn-danger btn-small';
            removeBtn.textContent = 'Ø­Ø°Ù';
            removeBtn.onclick = function() {
                itemRow.remove();
            };
            
            const itemRow = document.createElement('div');
            itemRow.className = 'item-row';
            itemRow.style.display = 'flex';
            itemRow.style.gap = '10px';
            itemRow.style.alignItems = 'center';
            itemRow.style.marginBottom = '10px';
            itemRow.style.padding = '10px';
            itemRow.style.border = '1px solid #ddd';
            itemRow.style.borderRadius = '8px';
            
            itemRow.appendChild(materialSelect);
            const quantityContainer = document.createElement('div');
            quantityContainer.style.display = 'flex';
            quantityContainer.style.flexDirection = 'column';
            quantityContainer.style.gap = '3px';
            quantityContainer.appendChild(quantityInput);
            quantityContainer.appendChild(availableDisplay);
            itemRow.appendChild(quantityContainer);
            itemRow.appendChild(unitSelect);
            itemRow.appendChild(reasonSelect);
            itemRow.appendChild(statusSelect);
            itemRow.appendChild(removeBtn);
            
            document.getElementById('returnItemsList').appendChild(itemRow);
        }

        window.loadWorkSiteInventory = async function(workSiteId, type) {
            if (!workSiteId) return;
            
            try {
                const { collection, getDocs, query, where } = window.firebaseCollections;
                const db = window.firebaseDb;
                
                // Calculate available quantities for return = delivered - returned
                // Step 1: Calculate total delivered quantities to this work site
                const deliveredQuantities = {};
                const deliverTransactionsRef = collection(db, 'transactions');
                const deliverQuery = query(deliverTransactionsRef, where('type', '==', 'deliver'), where('workSiteId', '==', workSiteId));
                const deliverSnapshot = await getDocs(deliverQuery);
                
                deliverSnapshot.forEach((docSnapshot) => {
                    const data = docSnapshot.data();
                    if (data.items) {
                        data.items.forEach(item => {
                            const materialId = item.materialId;
                            const quantity = item.quantity || 0; // Use base unit quantity
                            
                            if (!deliveredQuantities[materialId]) {
                                deliveredQuantities[materialId] = 0;
                            }
                            deliveredQuantities[materialId] += quantity;
                        });
                    }
                });
                
                // Step 2: Calculate total returned quantities from this work site
                const returnedQuantities = {};
                const returnTransactionsRef = collection(db, 'transactions');
                const returnQuery = query(returnTransactionsRef, where('type', '==', 'return'), where('workSiteId', '==', workSiteId));
                const returnSnapshot = await getDocs(returnQuery);
                
                returnSnapshot.forEach((docSnapshot) => {
                    const data = docSnapshot.data();
                    // Skip current return being edited (will be added back to available)
                    if (window.editingReturnId && docSnapshot.id === window.editingReturnId) {
                        return;
                    }
                    
                    if (data.items) {
                        data.items.forEach(item => {
                            const materialId = item.materialId;
                            // Use quantity (base unit) from the item
                            const quantity = item.quantity || (item.enteredQuantity || 0);
                            
                            if (!returnedQuantities[materialId]) {
                                returnedQuantities[materialId] = 0;
                            }
                            returnedQuantities[materialId] += quantity;
                        });
                    }
                });
                
                // Step 3: Calculate available for return = delivered - returned
                // Also store delivered and returned quantities for display
                window.workSiteInventory[workSiteId] = {};
                window.workSiteDeliveredQuantities = window.workSiteDeliveredQuantities || {};
                window.workSiteReturnedQuantities = window.workSiteReturnedQuantities || {};
                window.workSiteDeliveredQuantities[workSiteId] = deliveredQuantities;
                window.workSiteReturnedQuantities[workSiteId] = returnedQuantities;
                
                Object.keys(deliveredQuantities).forEach(materialId => {
                    const delivered = deliveredQuantities[materialId] || 0;
                    const returned = returnedQuantities[materialId] || 0;
                    const available = Math.max(0, delivered - returned);
                    window.workSiteInventory[workSiteId][materialId] = available;
                });

                // Clear items list if return and not in edit mode
                if (type === 'return' && !window.editingReturnId) {
                    document.getElementById('returnItemsList').innerHTML = '';
                }
            } catch (error) {
                console.error('Error loading work site inventory:', error);
            }
        };

        async function saveReturn(e) {
            e.preventDefault();
            const p = window.currentUserPermissions;
            const isEdit = !!window.editingReturnId;
            if (p && !p.isAdmin) {
                if (isEdit && !p.returnEdit) {
                    showModalAlert('returnModal', 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯', 'error');
                    return;
                }
                if (!isEdit && !p.returnAdd) {
                    showModalAlert('returnModal', 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯', 'error');
                    return;
                }
            }
            const { addDoc, collection, Timestamp } = window.firebaseCollections;
            const db = window.firebaseDb;

            const items = [];
            const itemsList = document.getElementById('returnItemsList');
            const itemRows = itemsList.querySelectorAll('.item-row');
            
            const workSiteId = document.getElementById('returnWorkSite').value;
            
            let validationError = null;
            const materialQuantitiesMap = {}; // Track total quantities per material (to handle duplicates)
            
            for (let i = 0; i < itemRows.length; i++) {
                const row = itemRows[i];
                const materialSelect = row.querySelector('select');
                const quantityInput = row.querySelector('input[type="number"]');
                const unitSelect = row.querySelector('select[id^="returnUnitSelect_"]') || row.querySelectorAll('select')[0];
                const reasonSelect = row.querySelectorAll('select')[row.querySelectorAll('select').length - 2] || row.querySelectorAll('select')[1];
                const statusSelect = row.querySelectorAll('select')[row.querySelectorAll('select').length - 1] || row.querySelectorAll('select')[2];
                
                if (materialSelect && materialSelect.value && quantityInput && quantityInput.value) {
                    const material = window.materials.find(m => m.id === materialSelect.value);
                    if (!material) continue;
                    
                    const enteredQuantity = parseFloat(quantityInput.value);
                    const enteredUnit = unitSelect ? unitSelect.value : material.unit;
                    
                    // Convert to base unit if sub-unit is selected
                    let baseQuantity = enteredQuantity;
                    let baseUnit = material.unit;
                    
                    // Check if entered unit is sub-unit
                    if (enteredUnit === material.subUnit && material.conversion && material.conversionType) {
                        if (material.conversionType === 'multiply') {
                            baseQuantity = enteredQuantity * material.conversion;
                        } else if (material.conversionType === 'divide') {
                            baseQuantity = enteredQuantity / material.conversion;
                        }
                    }
                    
                    // Accumulate quantity for this material (in case same material appears multiple times)
                    if (!materialQuantitiesMap[materialSelect.value]) {
                        materialQuantitiesMap[materialSelect.value] = 0;
                    }
                    materialQuantitiesMap[materialSelect.value] += baseQuantity;
                    
                    items.push({
                        materialId: materialSelect.value,
                        materialName: material.name,
                        enteredQuantity: enteredQuantity,  // Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¯Ø®Ù„Ø©
                        enteredUnit: enteredUnit,          // Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø©
                        quantity: baseQuantity,            // Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø­ÙˆÙ„Ø© Ù„Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                        unit: baseUnit,                   // Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                        reason: reasonSelect ? reasonSelect.value : '',
                        status: statusSelect ? statusSelect.value : ''
                    });
                }
            }
            
            // Validate total quantities per material
            for (const materialId in materialQuantitiesMap) {
                const totalQuantity = materialQuantitiesMap[materialId];
                const material = window.materials.find(m => m.id === materialId);
                
                // Check available quantity in base unit
                const available = window.workSiteInventory[workSiteId]?.[materialId] || 0;
                
                if (totalQuantity > available) {
                    validationError = `Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (${totalQuantity.toFixed(3)}) Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ (${available.toFixed(3)}) Ù„Ù„Ù…Ø§Ø¯Ø© ${material ? material.name : materialId}`;
                    break;
                }
            }
            
            if (validationError) {
                showModalAlert('returnModal', validationError, 'error');
                return;
            }

            if (items.length === 0) {
                showModalAlert('returnModal', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
                return;
            }

            const transactionData = {
                type: 'return',
                date: Timestamp.fromDate(new Date(document.getElementById('returnDate').value)),
                workSiteId: document.getElementById('returnWorkSite').value,
                warehouseId: document.getElementById('returnWarehouse').value,
                number: document.getElementById('returnNumber').value || null,
                invoice: document.getElementById('returnInvoice').value || null,
                items: items,
                notes: document.getElementById('returnNotes').value,
                createdAt: window.editingReturnId && oldData ? oldData.createdAt : Timestamp.now()
            };

            try {
                const { addDoc, updateDoc, doc, getDoc, collection } = window.firebaseCollections;
                
                // Get old items if editing
                let oldData = null;
                if (window.editingReturnId) {
                    try {
                        const oldReturnDoc = await getDoc(doc(db, 'transactions', window.editingReturnId));
                        if (oldReturnDoc.exists()) {
                            oldData = oldReturnDoc.data();
                            
                            // Reverse old inventory changes
                            if (oldData.items) {
                                for (const oldItem of oldData.items) {
                                    await updateInventory(oldData.workSiteId, 'workSite', oldItem.materialId, oldItem.quantity, oldItem.unit, 'add');
                                    if (oldItem.status === 'Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…') {
                                        await updateInventory(oldData.warehouseId, 'warehouse', oldItem.materialId, oldItem.quantity, oldItem.unit, 'subtract');
                                    }
                                }
                            }
                        }
                    } catch (e) {
                        console.error('Error loading old return data:', e);
                    }
                }
                
                if (window.editingReturnId && oldData) {
                    // Edit mode: Update transaction
                    const { Timestamp } = window.firebaseCollections;
                    await updateDoc(doc(db, 'transactions', window.editingReturnId), {
                        ...transactionData,
                        updatedAt: Timestamp.now()
                    });
                    
                    // Apply new inventory changes
                    for (const item of items) {
                        await updateInventory(transactionData.workSiteId, 'workSite', item.materialId, item.quantity, item.unit, 'subtract');
                        if (item.status === 'Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…') {
                            await updateInventory(transactionData.warehouseId, 'warehouse', item.materialId, item.quantity, item.unit, 'add');
                        }
                    }
                    
                    // Log activity
                    await logActivity('update', 'transaction', window.editingReturnId, `Ø¹Ù…Ù„ÙŠØ© Ø§Ø³ØªØ±Ø¯Ø§Ø¯ - ${transactionData.number || 'Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù…'}`, transactionData, oldData);
                    
                    showAlert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } else {
                    // Add mode: Save transaction
                    const docRef = await addDoc(collection(db, 'transactions'), transactionData);

                    // Update inventory - remove from work site, add to warehouse (only if status is usable)
                    for (const item of items) {
                        await updateInventory(transactionData.workSiteId, 'workSite', item.materialId, item.quantity, item.unit, 'subtract');
                        if (item.status === 'Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…') {
                            await updateInventory(transactionData.warehouseId, 'warehouse', item.materialId, item.quantity, item.unit, 'add');
                        }
                    }
                    
                    // Log activity
                    await logActivity('create', 'transaction', docRef.id, `Ø¹Ù…Ù„ÙŠØ© Ø§Ø³ØªØ±Ø¯Ø§Ø¯ - ${transactionData.number || 'Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù…'}`, transactionData);
                    
                    showAlert('ØªÙ… Ø­ÙØ¸ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                }

                document.getElementById('returnForm').reset();
                document.getElementById('returnItemsList').innerHTML = '';
                window.editingReturnId = null;
                closeModal('returnModal');
                await loadDashboard();
                await loadInventory();
                await loadReturns();
            } catch (error) {
                console.error('Error saving return:', error);
                showModalAlert('returnModal', 'Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯', 'error');
            }
        }

        async function loadReturnForEdit(returnId) {
            try {
                const { doc, getDoc } = window.firebaseCollections;
                const db = window.firebaseDb;
                
                const returnDoc = await getDoc(doc(db, 'transactions', returnId));
                if (!returnDoc.exists()) {
                    showAlert('Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error');
                    return;
                }
                
                const data = returnDoc.data();
                
                // Fill form fields
                const dateValue = data.date ? (data.date.toDate ? data.date.toDate().toISOString().split('T')[0] : new Date(data.date).toISOString().split('T')[0]) : '';
                document.getElementById('returnDate').value = dateValue;
                document.getElementById('returnNumber').value = data.number || '';
                document.getElementById('returnInvoice').value = data.invoice || '';
                document.getElementById('returnNotes').value = data.notes || '';
                
                // Select work site
                if (data.workSiteId) {
                    document.getElementById('returnWorkSite').value = data.workSiteId;
                    await loadWorkSiteInventory(data.workSiteId, 'return');
                }
                
                // Select warehouse
                if (data.warehouseId) {
                    document.getElementById('returnWarehouse').value = data.warehouseId;
                }
                
                // Load items
                const itemsList = document.getElementById('returnItemsList');
                itemsList.innerHTML = '';
                
                if (data.items && data.items.length > 0) {
                    for (const item of data.items) {
                        addReturnItemForEdit(item, data.workSiteId);
                    }
                }
            } catch (error) {
                console.error('Error loading return for edit:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯', 'error');
            }
        }

        window.editReturn = async function(returnId) {
            await showReturnModal(returnId);
        };

        window.deleteReturn = async function(returnId) {
            const p = window.currentUserPermissions;
            if (p && !p.isAdmin && !p.returnDelete) {
                showAlert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯', 'error');
                return;
            }
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ù‡Ø°Ù‡ØŸ Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„ ÙˆØ¥Ø²Ø§Ù„ØªÙ‡Ø§ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹.')) {
                return;
            }

            try {
                const { doc, getDoc, deleteDoc } = window.firebaseCollections;
                const db = window.firebaseDb;

                // Get return data
                const returnDoc = await getDoc(doc(db, 'transactions', returnId));
                if (!returnDoc.exists()) {
                    showAlert('Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error');
                    return;
                }

                const data = returnDoc.data();

                // Reverse inventory changes (return to work site, remove from warehouse)
                if (data.items) {
                    for (const item of data.items) {
                        await updateInventory(data.workSiteId, 'workSite', item.materialId, item.quantity, item.unit, 'add');
                        if (item.status === 'Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…') {
                            await updateInventory(data.warehouseId, 'warehouse', item.materialId, item.quantity, item.unit, 'subtract');
                        }
                    }
                }

                // Log activity before deletion
                await logActivity('delete', 'transaction', returnId, `Ø¹Ù…Ù„ÙŠØ© Ø§Ø³ØªØ±Ø¯Ø§Ø¯ - ${data.number || 'Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù…'}`, null, data);
                
                // Delete transaction
                await deleteDoc(doc(db, 'transactions', returnId));

                showAlert('ØªÙ… Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                await loadDashboard();
                await loadInventory();
                await loadReturns();
            } catch (error) {
                console.error('Error deleting return:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯', 'error');
            }
        };

        window.viewReturnDetails = async function(transactionId) {
            try {
                const { doc, getDoc } = window.firebaseCollections;
                const db = window.firebaseDb;
                
                const transactionDoc = await getDoc(doc(db, 'transactions', transactionId));
                if (!transactionDoc.exists()) {
                    showAlert('Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error');
                    return;
                }
                
                const data = transactionDoc.data();
                const warehouse = window.warehouses.find(w => w.id === data.warehouseId);
                const workSite = window.workSites.find(w => w.id === data.workSiteId);
                
                const dateStr = window.formatDate(data.date);
                
                let itemsRows = '';
                data.items?.forEach((item, index) => {
                    const enteredQty = item.enteredQuantity !== undefined ? item.enteredQuantity : item.quantity;
                    const enteredUnit = item.enteredUnit || item.unit;
                    const baseQty = item.quantity || item.enteredQuantity;
                    const baseUnit = item.unit;
                    
                    itemsRows += `
                        <tr>
                            <td style="text-align: center; padding: 8px; border: 1px solid #ddd;">${index + 1}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${item.materialName}</td>
                            <td style="text-align: center; padding: 8px; border: 1px solid #ddd;">${enteredQty}</td>
                            <td style="text-align: center; padding: 8px; border: 1px solid #ddd;">${enteredUnit}</td>
                            <td style="text-align: center; padding: 8px; border: 1px solid #ddd;">${baseQty.toFixed(3)}</td>
                            <td style="text-align: center; padding: 8px; border: 1px solid #ddd;">${baseUnit}</td>
                            <td style="text-align: center; padding: 8px; border: 1px solid #ddd;">${item.reason || '-'}</td>
                            <td style="text-align: center; padding: 8px; border: 1px solid #ddd;">${item.status || '-'}</td>
                        </tr>
                    `;
                });
                
                const detailsHtml = `
                    <div style="padding: 20px; max-width: 900px; margin: 0 auto;">
                        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 15px;">
                            <h2 style="margin: 0; color: #333;">ØªÙØ§ØµÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯</h2>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                            <div>
                                <p style="margin: 10px 0;"><strong>Ø±Ù‚Ù… Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯:</strong> ${data.number || '-'}</p>
                                <p style="margin: 10px 0;"><strong>Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„:</strong> ${data.invoice || '-'}</p>
                                <p style="margin: 10px 0;"><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${dateStr}</p>
                            </div>
                            <div>
                                <p style="margin: 10px 0;"><strong>Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„:</strong> ${workSite ? workSite.name : '-'}</p>
                                <p style="margin: 10px 0;"><strong>Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹:</strong> ${warehouse ? warehouse.name : '-'}</p>
                            </div>
                        </div>
                        ${data.notes ? `<p style="margin: 10px 0;"><strong>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${data.notes}</p>` : ''}
                        <h3 style="margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid #ddd; padding-bottom: 10px;">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø³ØªØ±Ø¯Ø©:</h3>
                        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                            <thead>
                                <tr style="background-color: #f5f5f5;">
                                    <th style="text-align: center; padding: 12px; border: 1px solid #ddd;">#</th>
                                    <th style="text-align: right; padding: 12px; border: 1px solid #ddd;">Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                                    <th style="text-align: center; padding: 12px; border: 1px solid #ddd;">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¯Ø®Ù„Ø©</th>
                                    <th style="text-align: center; padding: 12px; border: 1px solid #ddd;">Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø©</th>
                                    <th style="text-align: center; padding: 12px; border: 1px solid #ddd;">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø­ÙˆÙ„Ø©</th>
                                    <th style="text-align: center; padding: 12px; border: 1px solid #ddd;">Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</th>
                                    <th style="text-align: center; padding: 12px; border: 1px solid #ddd;">Ø§Ù„Ø³Ø¨Ø¨</th>
                                    <th style="text-align: center; padding: 12px; border: 1px solid #ddd;">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsRows}
                            </tbody>
                        </table>
                    </div>
                `;
                
                // Remove existing modal if any
                const existingModal = document.getElementById('returnDetailsModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Create and show modal
                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.id = 'returnDetailsModal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 950px;">
                        <div class="modal-header">
                            <h2>ØªÙØ§ØµÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯</h2>
                            <button class="close" onclick="closeModal('returnDetailsModal')">&times;</button>
                        </div>
                        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                            ${detailsHtml}
                        </div>
                        <div class="modal-footer" style="padding: 15px; text-align: left; border-top: 1px solid #ddd;">
                            <button class="btn btn-info" onclick="printReturn('${transactionId}')" style="background-color: #17a2b8; color: white;">Ø·Ø¨Ø§Ø¹Ø©</button>
                            <button class="btn btn-secondary" onclick="closeModal('returnDetailsModal')">Ø¥ØºÙ„Ø§Ù‚</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error viewing return details:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„', 'error');
            }
        };

        window.printReturn = async function(transactionId) {
            try {
                const { doc, getDoc } = window.firebaseCollections;
                const db = window.firebaseDb;
                
                const transactionDoc = await getDoc(doc(db, 'transactions', transactionId));
                if (!transactionDoc.exists()) {
                    showAlert('Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error');
                    return;
                }
                
                const data = transactionDoc.data();
                const warehouse = window.warehouses.find(w => w.id === data.warehouseId);
                const workSite = window.workSites.find(w => w.id === data.workSiteId);
                
                const dateStr = window.formatDate(data.date);
                
                let itemsRows = '';
                data.items?.forEach((item, index) => {
                    const enteredQty = item.enteredQuantity !== undefined ? item.enteredQuantity : item.quantity;
                    const enteredUnit = item.enteredUnit || item.unit;
                    const baseQty = item.quantity || item.enteredQuantity;
                    const baseUnit = item.unit;
                    
                    itemsRows += `
                        <tr>
                            <td style="text-align: center; padding: 8px; border: 1px solid #000;">${index + 1}</td>
                            <td style="padding: 8px; border: 1px solid #000;">${item.materialName}</td>
                            <td style="text-align: center; padding: 8px; border: 1px solid #000;">${enteredQty}</td>
                            <td style="text-align: center; padding: 8px; border: 1px solid #000;">${enteredUnit}</td>
                            <td style="text-align: center; padding: 8px; border: 1px solid #000;">${baseQty.toFixed(3)}</td>
                            <td style="text-align: center; padding: 8px; border: 1px solid #000;">${baseUnit}</td>
                            <td style="text-align: center; padding: 8px; border: 1px solid #000;">${item.reason || '-'}</td>
                            <td style="text-align: center; padding: 8px; border: 1px solid #000;">${item.status || '-'}</td>
                        </tr>
                    `;
                });
                
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html dir="rtl" lang="ar">
                    <head>
                        <meta charset="UTF-8">
                        <title>Ø·Ø¨Ø§Ø¹Ø© Ø§Ø³ØªØ±Ø¯Ø§Ø¯ - ${data.number || ''}</title>
                        <style>
                            @media print {
                                body { margin: 0; }
                                .no-print { display: none; }
                            }
                            body {
                                font-family: Arial, sans-serif;
                                padding: 20px;
                                direction: rtl;
                            }
                            h2 {
                                text-align: center;
                                margin-bottom: 30px;
                                border-bottom: 2px solid #000;
                                padding-bottom: 15px;
                            }
                            .info-grid {
                                display: grid;
                                grid-template-columns: 1fr 1fr;
                                gap: 20px;
                                margin-bottom: 30px;
                            }
                            table {
                                width: 100%;
                                border-collapse: collapse;
                                margin-top: 20px;
                            }
                            th, td {
                                border: 1px solid #000;
                                padding: 10px;
                                text-align: center;
                            }
                            th {
                                background-color: #f0f0f0;
                                font-weight: bold;
                            }
                            .print-btn {
                                margin: 20px 0;
                                padding: 10px 20px;
                                background-color: #007bff;
                                color: white;
                                border: none;
                                cursor: pointer;
                                font-size: 16px;
                            }
                        </style>
                    </head>
                    <body>
                        <div>
                            <h2>Ø¥ÙŠØµØ§Ù„ Ø§Ø³ØªØ±Ø¯Ø§Ø¯</h2>
                            <div class="info-grid">
                                <div>
                                    <p><strong>Ø±Ù‚Ù… Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯:</strong> ${data.number || '-'}</p>
                                    <p><strong>Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„:</strong> ${data.invoice || '-'}</p>
                                    <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${dateStr}</p>
                                </div>
                                <div>
                                    <p><strong>Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„:</strong> ${workSite ? workSite.name : '-'}</p>
                                    <p><strong>Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹:</strong> ${warehouse ? warehouse.name : '-'}</p>
                                </div>
                            </div>
                            ${data.notes ? `<p><strong>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${data.notes}</p>` : ''}
                            <h3>Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø³ØªØ±Ø¯Ø©:</h3>
                            <table>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                                        <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¯Ø®Ù„Ø©</th>
                                        <th>Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø©</th>
                                        <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø­ÙˆÙ„Ø©</th>
                                        <th>Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</th>
                                        <th>Ø§Ù„Ø³Ø¨Ø¨</th>
                                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${itemsRows}
                                </tbody>
                            </table>
                            <p style="margin-top: 30px; text-align: left;">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯: ${data.items?.length || 0}</p>
                            <button class="print-btn no-print" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø©</button>
                        </div>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                
                // Auto print after a short delay
                setTimeout(() => {
                    printWindow.print();
                }, 250);
            } catch (error) {
                console.error('Error printing return:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯', 'error');
            }
        };

        // ========== INVENTORY MANAGEMENT ==========
        /** Compute warehouse balances from transactions (receive - deliver + return usable). Optionally exclude one transaction (e.g. when editing that receive). */
        window.getComputedWarehouseBalances = async function(warehouseId, excludeTransactionId) {
            const db = window.firebaseDb;
            const { collection, getDocs, query, where } = window.firebaseCollections;
            if (!db) return {};
            const balances = {};
            const add = (mid, qty) => { balances[mid] = (balances[mid] || 0) + qty; };
            const sub = (mid, qty) => { balances[mid] = (balances[mid] || 0) - qty; };
            const tr = (docSnap, type) => {
                if (excludeTransactionId && docSnap.id === excludeTransactionId) return;
                const d = docSnap.data();
                const whId = d.warehouseId;
                const wsId = d.workSiteId;
                if (whId !== warehouseId) return;
                d.items?.forEach(item => {
                    const mid = item.materialId;
                    const qty = item.quantity || 0;
                    if (type === 'receive') add(mid, qty);
                    else if (type === 'deliver') sub(mid, qty);
                    else if (type === 'return' && item.status === 'Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…') add(mid, qty);
                });
            };
            const receiveSnap = await getDocs(query(collection(db, 'transactions'), where('type', '==', 'receive')));
            receiveSnap.forEach(d => tr(d, 'receive'));
            const deliverSnap = await getDocs(query(collection(db, 'transactions'), where('type', '==', 'deliver')));
            deliverSnap.forEach(d => {
                if (excludeTransactionId && d.id === excludeTransactionId) return;
                const data = d.data();
                if (data.warehouseId !== warehouseId) return;
                data.items?.forEach(item => {
                    sub(item.materialId, item.quantity || 0);
                });
            });
            const returnSnap = await getDocs(query(collection(db, 'transactions'), where('type', '==', 'return')));
            returnSnap.forEach(d => {
                if (excludeTransactionId && d.id === excludeTransactionId) return;
                const data = d.data();
                if (data.warehouseId !== warehouseId) return;
                data.items?.forEach(item => {
                    if (item.status === 'Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…') add(item.materialId, item.quantity || 0);
                });
            });
            return balances;
        };

        /** Get computed balance for one material in a warehouse (from transactions). Use excludeTransactionId when editing that transaction. */
        window.getComputedWarehouseBalance = async function(warehouseId, materialId, excludeTransactionId) {
            const balances = await window.getComputedWarehouseBalances(warehouseId, excludeTransactionId);
            return balances[materialId] != null ? balances[materialId] : 0;
        };

        async function updateInventory(locationId, locationType, materialId, quantity, unit, operation) {
            const { collection, getDocs, query, where, addDoc, updateDoc, doc, Timestamp } = window.firebaseCollections;
            const db = window.firebaseDb;

            try {
                // Find existing inventory record
                const inventoryRef = collection(db, 'inventory');
                const q = query(
                    inventoryRef, 
                    where('locationId', '==', locationId),
                    where('locationType', '==', locationType),
                    where('materialId', '==', materialId)
                );
                const snapshot = await getDocs(q);

                if (!snapshot.empty) {
                    // Update existing
                    const inventoryDoc = snapshot.docs[0];
                    const currentQuantity = inventoryDoc.data().quantity || 0;
                    const newQuantity = operation === 'add' 
                        ? currentQuantity + quantity 
                        : Math.max(0, currentQuantity - quantity);
                    
                    await updateDoc(doc(db, 'inventory', inventoryDoc.id), {
                        quantity: newQuantity,
                        unit: unit,
                        updatedAt: Timestamp.now()
                    });
                } else if (operation === 'add') {
                    // Create new
                    await addDoc(inventoryRef, {
                        locationId: locationId,
                        locationType: locationType,
                        materialId: materialId,
                        quantity: quantity,
                        unit: unit,
                        createdAt: Timestamp.now(),
                        updatedAt: Timestamp.now()
                    });
                }
            } catch (error) {
                console.error('Error updating inventory:', error);
                throw error;
            }
        }

        window.inventorySelectedMaterials = new Set();

        window.toggleInventoryMaterialOptions = function() {
            const options = document.getElementById('inventoryMaterialOptions');
            if (options) options.classList.toggle('show');
        };

        window.filterInventoryMaterialOptions = function() {
            const search = (document.getElementById('inventoryMaterialSearch')?.value || '').toLowerCase().trim();
            const options = document.querySelectorAll('#inventoryMaterialOptionsList .option-item');
            options.forEach(option => {
                const text = (option.textContent || '').toLowerCase();
                const match = !search || text.includes(search);
                option.style.display = match ? 'block' : 'none';
            });
        };

        window.selectInventoryMaterial = function(materialId) {
            if (!window.inventorySelectedMaterials) window.inventorySelectedMaterials = new Set();
            if (window.inventorySelectedMaterials.has(materialId)) {
                window.inventorySelectedMaterials.delete(materialId);
            } else {
                window.inventorySelectedMaterials.add(materialId);
            }
            window.updateInventoryMaterialDisplay();
            window.populateInventoryMaterialOptions();
            window.filterInventoryMaterialOptions();
            window.loadInventory();
        };

        window.clearInventoryMaterialSelection = function() {
            window.inventorySelectedMaterials = new Set();
            const opts = document.getElementById('inventoryMaterialOptions');
            if (opts) opts.classList.remove('show');
            window.updateInventoryMaterialDisplay();
            window.populateInventoryMaterialOptions();
            window.loadInventory();
        };

        window.updateInventoryMaterialDisplay = function() {
            const display = document.getElementById('inventoryMaterialDisplay');
            if (!display) return;
            const count = window.inventorySelectedMaterials?.size || 0;
            if (count === 0) {
                display.textContent = 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯';
            } else {
                const names = [];
                (window.materials || []).forEach(m => {
                    if (window.inventorySelectedMaterials.has(m.id)) {
                        names.push((m.code ? m.code + ' - ' : '') + m.name);
                    }
                });
                display.textContent = names.length > 3 ? count + ' Ù…ÙˆØ§Ø¯ Ù…Ø­Ø¯Ø¯Ø©' : names.join('ØŒ ') || count + ' Ù…ÙˆØ§Ø¯ Ù…Ø­Ø¯Ø¯Ø©';
            }
        };

        window.populateInventoryMaterialOptions = function() {
            const list = document.getElementById('inventoryMaterialOptionsList');
            if (!list) return;
            list.innerHTML = '';
            const searchInput = document.getElementById('inventoryMaterialSearch');
            if (searchInput) searchInput.value = '';
            const allOpt = document.createElement('div');
            allOpt.className = 'option-item' + (!window.inventorySelectedMaterials?.size ? ' selected' : '');
            allOpt.textContent = 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯';
            allOpt.style.fontWeight = 'bold';
            allOpt.style.borderBottom = '1px solid #eee';
            allOpt.style.paddingBottom = '8px';
            allOpt.style.marginBottom = '4px';
            allOpt.onclick = function(e) { e.stopPropagation(); window.clearInventoryMaterialSelection(); };
            list.appendChild(allOpt);
            (window.materials || []).forEach(m => {
                const opt = document.createElement('div');
                opt.className = 'option-item' + (window.inventorySelectedMaterials?.has(m.id) ? ' selected' : '');
                opt.textContent = (m.code ? m.code + ' - ' : '') + m.name;
                opt.dataset.value = m.id;
                opt.onclick = function(e) { e.stopPropagation(); window.selectInventoryMaterial(m.id); };
                list.appendChild(opt);
            });
        };

        window.loadInventory = async function() {
            try {
                const { collection, getDocs, query, where } = window.firebaseCollections;
                const db = window.firebaseDb;

                const warehouseFilter = document.getElementById('inventoryWarehouse').value;
                const materialFilterIds = Array.from(window.inventorySelectedMaterials || []);

                const inventoryRef = collection(db, 'inventory');
                let q = query(inventoryRef);

                if (warehouseFilter) {
                    q = query(inventoryRef, where('locationId', '==', warehouseFilter), where('locationType', '==', 'warehouse'));
                }

                const snapshot = await getDocs(q);
                const rows = [];

                snapshot.forEach((docSnapshot) => {
                    const data = docSnapshot.data();
                    if (materialFilterIds.length > 0 && !materialFilterIds.includes(data.materialId)) return;

                    const material = window.materials.find(m => m.id === data.materialId);
                    const location = data.locationType === 'warehouse'
                        ? window.warehouses.find(w => w.id === data.locationId)
                        : window.workSites.find(w => w.id === data.locationId);

                    if (!material || !location) return;
                    if (data.locationType === 'warehouse') {
                        if (window.hasWarehouseAccess && !window.hasWarehouseAccess(data.locationId)) return;
                    } else if (data.locationType === 'workSite') {
                        if (window.hasWorkSiteAccess && !window.hasWorkSiteAccess(data.locationId)) return;
                    }

                    const minStock = material.minStock || 0;
                    const qty = parseFloat(data.quantity) || 0;
                    const statusBadge = qty < 0
                        ? '<span class="badge badge-danger">Ø³Ø§Ù„Ø¨</span>'
                        : (qty <= minStock ? '<span class="badge badge-danger">Ù…Ù†Ø®ÙØ¶</span>' : '<span class="badge badge-success">Ø·Ø¨ÙŠØ¹ÙŠ</span>');
                    const qtyStyle = qty < 0 ? ' style="color: red; font-weight: bold;"' : '';
                    rows.push({ data, material, location, statusBadge, qtyStyle, qtyStr: qty.toFixed(3) });
                });

                rows.sort((a, b) => {
                    const codeA = (a.material.code || '').toString().toLowerCase();
                    const codeB = (b.material.code || '').toString().toLowerCase();
                    return codeA.localeCompare(codeB, 'ar');
                });

                const tbody = document.getElementById('inventoryTableBody');
                tbody.innerHTML = '';
                rows.forEach(({ data, material, location, statusBadge, qtyStyle, qtyStr }) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${material.code || '-'}</td>
                        <td>${location.name} (${data.locationType === 'warehouse' ? 'Ù…Ø³ØªÙˆØ¯Ø¹' : 'Ù…ÙˆÙ‚Ø¹ Ø¹Ù…Ù„'})</td>
                        <td>${material.name}</td>
                        <td${qtyStyle}>${qtyStr}</td>
                        <td>${data.unit || material.unit || '-'}</td>
                        <td>${statusBadge}</td>
                    `;
                    tbody.appendChild(row);
                });

                window.populateInventoryMaterialOptions();
                window.updateInventoryMaterialDisplay();
            } catch (error) {
                console.error('Error loading inventory:', error);
            }
        };

        // ========== INVENTORY VERIFICATION & MAINTENANCE ==========
        window.inventoryVerificationDiscrepancies = [];

        window.loadInventoryVerificationSection = function() {
            const scope = document.getElementById('inventoryVerifyScope');
            const whSelect = document.getElementById('inventoryVerifyWarehouse');
            const wsSelect = document.getElementById('inventoryVerifyWorkSite');
            const matSelect = document.getElementById('inventoryVerifyMaterial');
            if (!whSelect || !wsSelect || !matSelect) return;
            whSelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª</option>';
            (window.warehouses || []).forEach(w => {
                const opt = document.createElement('option');
                opt.value = w.id;
                opt.textContent = w.name;
                whSelect.appendChild(opt);
            });
            wsSelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù…Ù„</option>';
            (window.workSites || []).forEach(w => {
                const opt = document.createElement('option');
                opt.value = w.id;
                opt.textContent = w.name;
                wsSelect.appendChild(opt);
            });
            matSelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯</option>';
            (window.materials || []).forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.id;
                opt.textContent = m.name;
                matSelect.appendChild(opt);
            });
            const whGroup = document.getElementById('inventoryVerifyWarehouseGroup');
            const wsGroup = document.getElementById('inventoryVerifyWorkSiteGroup');
            function toggleFilterGroups() {
                const v = scope ? scope.value : 'all';
                if (whGroup) whGroup.style.display = (v === 'workSite') ? 'none' : 'block';
                if (wsGroup) wsGroup.style.display = (v === 'warehouse') ? 'none' : 'block';
            }
            if (scope) scope.onchange = toggleFilterGroups;
            toggleFilterGroups();
            document.getElementById('inventoryVerifyStatus').textContent = '';
            document.getElementById('inventoryVerifyTable').style.display = 'none';
            document.getElementById('inventoryVerifyRepairBtn').style.display = 'none';
        };

        window.runInventoryVerification = async function() {
            const statusEl = document.getElementById('inventoryVerifyStatus');
            const scanBtn = document.getElementById('inventoryVerifyScanBtn');
            const repairBtn = document.getElementById('inventoryVerifyRepairBtn');
            const scope = document.getElementById('inventoryVerifyScope').value;
            const warehouseId = document.getElementById('inventoryVerifyWarehouse').value;
            const workSiteId = document.getElementById('inventoryVerifyWorkSite').value;
            const materialId = document.getElementById('inventoryVerifyMaterial').value;
            try {
                if (scanBtn) scanBtn.disabled = true;
                statusEl.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...';
                const { collection, getDocs, query, where } = window.firebaseCollections;
                const db = window.firebaseDb;
                const computed = {};
                function key(locType, locId, matId) { return locType + '\x01' + locId + '\x01' + matId; }
                function ensureComputed(k, unit) {
                    if (!computed[k]) computed[k] = { quantity: 0, unit: unit || '', received: 0, delivered: 0, returned: 0 };
                }
                function addToComputed(locType, locId, matId, qty, unit, category) {
                    const k = key(locType, locId, matId);
                    ensureComputed(k, unit);
                    computed[k].quantity += qty;
                    computed[k].unit = computed[k].unit || unit || '';
                    if (category === 'receive') computed[k].received += qty;
                    else if (category === 'deliver') computed[k].delivered += qty;
                    else if (category === 'return') computed[k].returned += qty;
                }
                function subtractFromComputed(locType, locId, matId, qty, unit, category) {
                    const k = key(locType, locId, matId);
                    ensureComputed(k, unit);
                    computed[k].quantity -= qty;
                    computed[k].unit = computed[k].unit || unit || '';
                    if (category === 'deliver') computed[k].delivered += qty;
                    else if (category === 'return') computed[k].returned += qty;
                }
                if (scope !== 'workSite') {
                    const receiveSnap = await getDocs(query(collection(db, 'transactions'), where('type', '==', 'receive')));
                    receiveSnap.forEach(doc => {
                        const d = doc.data();
                        const whId = d.warehouseId;
                        if (warehouseId && whId !== warehouseId) return;
                        d.items?.forEach(item => {
                            const mid = item.materialId;
                            if (materialId && mid !== materialId) return;
                            addToComputed('warehouse', whId, mid, item.quantity || 0, item.unit, 'receive');
                        });
                    });
                    const deliverSnap = await getDocs(query(collection(db, 'transactions'), where('type', '==', 'deliver')));
                    deliverSnap.forEach(doc => {
                        const d = doc.data();
                        const whId = d.warehouseId;
                        const wsId = d.workSiteId;
                        if (warehouseId && whId !== warehouseId) return;
                        if (workSiteId && wsId !== workSiteId) return;
                        d.items?.forEach(item => {
                            const mid = item.materialId;
                            if (materialId && mid !== materialId) return;
                            subtractFromComputed('warehouse', whId, mid, item.quantity || 0, item.unit, 'deliver');
                            addToComputed('workSite', wsId, mid, item.quantity || 0, item.unit, 'deliver');
                        });
                    });
                    const returnSnap = await getDocs(query(collection(db, 'transactions'), where('type', '==', 'return')));
                    returnSnap.forEach(doc => {
                        const d = doc.data();
                        const whId = d.warehouseId;
                        const wsId = d.workSiteId;
                        if (warehouseId && whId !== warehouseId) return;
                        if (workSiteId && wsId !== workSiteId) return;
                        d.items?.forEach(item => {
                            const mid = item.materialId;
                            if (materialId && mid !== materialId) return;
                            const qty = item.quantity || 0;
                            subtractFromComputed('workSite', wsId, mid, qty, item.unit, 'return');
                            if (item.status === 'Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…') addToComputed('warehouse', whId, mid, qty, item.unit, 'return');
                        });
                    });
                }
                if (scope === 'workSite') {
                    const deliverSnap = await getDocs(query(collection(db, 'transactions'), where('type', '==', 'deliver')));
                    deliverSnap.forEach(doc => {
                        const d = doc.data();
                        const wsId = d.workSiteId;
                        if (workSiteId && wsId !== workSiteId) return;
                        d.items?.forEach(item => {
                            const mid = item.materialId;
                            if (materialId && mid !== materialId) return;
                            addToComputed('workSite', wsId, mid, item.quantity || 0, item.unit, 'deliver');
                        });
                    });
                    const returnSnap = await getDocs(query(collection(db, 'transactions'), where('type', '==', 'return')));
                    returnSnap.forEach(doc => {
                        const d = doc.data();
                        const wsId = d.workSiteId;
                        if (workSiteId && wsId !== workSiteId) return;
                        d.items?.forEach(item => {
                            const mid = item.materialId;
                            if (materialId && mid !== materialId) return;
                            subtractFromComputed('workSite', wsId, mid, item.quantity || 0, item.unit, 'return');
                        });
                    });
                }
                const stored = {};
                const invSnap = await getDocs(query(collection(db, 'inventory')));
                invSnap.forEach(docSnap => {
                    const d = docSnap.data();
                    const locType = d.locationType;
                    const locId = d.locationId;
                    const mid = d.materialId;
                    if (scope === 'warehouse' && locType !== 'warehouse') return;
                    if (scope === 'workSite' && locType !== 'workSite') return;
                    if (warehouseId && locType === 'warehouse' && locId !== warehouseId) return;
                    if (workSiteId && locType === 'workSite' && locId !== workSiteId) return;
                    if (materialId && mid !== materialId) return;
                    const k = key(locType, locId, mid);
                    stored[k] = { quantity: d.quantity || 0, unit: d.unit || '', docId: docSnap.id };
                });
                const discrepancies = [];
                const allKeys = new Set([...Object.keys(computed), ...Object.keys(stored)]);
                allKeys.forEach(k => {
                    const parts = k.split('\x01');
                    const locType = parts[0];
                    const locId = parts[1];
                    const mid = parts[2];
                    const comp = computed[k];
                    const st = stored[k];
                    const compQty = comp ? comp.quantity : 0;
                    const stQty = st ? st.quantity : 0;
                    if (Math.abs(compQty - stQty) < 0.0001) return;
                    const locationName = locType === 'warehouse'
                        ? (window.warehouses?.find(w => w.id === locId)?.name || locId)
                        : (window.workSites?.find(w => w.id === locId)?.name || locId);
                    const material = window.materials?.find(m => m.id === mid);
                    discrepancies.push({
                        locationId: locId,
                        locationType: locType,
                        locationName: locationName,
                        materialId: mid,
                        materialName: material ? material.name : mid,
                        received: comp ? (comp.received || 0) : 0,
                        delivered: comp ? (comp.delivered || 0) : 0,
                        returned: comp ? (comp.returned || 0) : 0,
                        computedQuantity: compQty,
                        storedQuantity: stQty,
                        inventoryDocId: st ? st.docId : null,
                        unit: (comp || st || {}).unit || ''
                    });
                });
                window.inventoryVerificationDiscrepancies = discrepancies;
                const tbody = document.getElementById('inventoryVerifyTableBody');
                const table = document.getElementById('inventoryVerifyTable');
                tbody.innerHTML = '';
                if (discrepancies.length === 0) {
                    statusEl.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ±ÙˆÙ‚Ø§Øª. Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³Ø¬Ù„ Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ù…Ø­Ø³ÙˆØ¨ Ù…Ù† Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª.';
                    statusEl.style.color = '#27ae60';
                    table.style.display = 'none';
                    repairBtn.style.display = 'none';
                } else {
                    statusEl.textContent = 'ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ' + discrepancies.length + ' ÙØ±Ù‚. Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª.';
                    statusEl.style.color = '#e74c3c';
                    table.style.display = 'table';
                    repairBtn.style.display = 'inline-block';
                    discrepancies.forEach((row, idx) => {
                        const tr = document.createElement('tr');
                        const diff = (row.computedQuantity - row.storedQuantity).toFixed(3);
                        tr.innerHTML = `
                            <td style="padding: 8px; border: 1px solid #ddd;">${row.locationName}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${row.locationType === 'warehouse' ? 'Ù…Ø³ØªÙˆØ¯Ø¹' : 'Ù…ÙˆÙ‚Ø¹ Ø¹Ù…Ù„'}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${row.materialName}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${(row.received ?? 0).toFixed(3)}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${(row.delivered ?? 0).toFixed(3)}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${(row.returned ?? 0).toFixed(3)}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${row.computedQuantity.toFixed(3)}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${row.storedQuantity.toFixed(3)}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${diff}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;"><input type="checkbox" class="inventory-verify-repair-cb" data-idx="${idx}"></td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            } catch (err) {
                console.error('Inventory verification error:', err);
                showAlert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ÙØ­Øµ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: ' + (err.message || err), 'error');
                statusEl.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙØ­Øµ.';
                statusEl.style.color = '#e74c3c';
            } finally {
                if (scanBtn) scanBtn.disabled = false;
            }
        };

        window.repairInventoryDiscrepancies = async function() {
            if (!window.currentUserPermissions || (!window.currentUserPermissions.isAdmin && window.currentUserPermissions.permissionType !== 'full')) {
                showAlert('ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø¯ÙŠØ± Ù…Ø·Ù„ÙˆØ¨Ø© Ù„ØªØ´ØºÙŠÙ„ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†.', 'error');
                return;
            }
            const list = window.inventoryVerificationDiscrepancies || [];
            const checked = document.querySelectorAll('.inventory-verify-repair-cb:checked');
            if (checked.length === 0) {
                showAlert('Ù„Ù… ØªØ®ØªØ± Ø£ÙŠ ØµÙÙˆÙ Ù„Ù„Ø¥ØµÙ„Ø§Ø­. Ø­Ø¯Ø¯ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ ØªØµØ­ÙŠØ­Ù‡Ø§.', 'error');
                return;
            }
            if (!confirm('Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³Ø¬Ù„ Ù„ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­Ø³ÙˆØ¨ Ù„Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) return;
            const cols = window.firebaseCollections;
            const db = window.firebaseDb;
            if (!cols || !db) {
                showAlert('Ø®Ø·Ø£: Ø§ØªØµØ§Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªÙˆÙØ±.', 'error');
                return;
            }
            const { collection, addDoc, updateDoc, doc, Timestamp } = cols;
            const invRef = collection(db, 'inventory');
            let fixed = 0;
            let firstSkipReason = null;
            try {
                for (const cb of checked) {
                    const idx = parseInt(cb.getAttribute('data-idx'), 10);
                    if (isNaN(idx) || idx < 0 || idx >= list.length) {
                        if (firstSkipReason === null) firstSkipReason = 'ÙÙ‡Ø±Ø³ ØºÙŠØ± ØµØ§Ù„Ø­: ' + cb.getAttribute('data-idx');
                        continue;
                    }
                    const row = list[idx];
                    if (!row || row.locationId == null || row.locationType == null || row.materialId == null) {
                        if (firstSkipReason === null) firstSkipReason = 'ØµÙ Ù†Ø§Ù‚Øµ (Ù…ÙˆÙ‚Ø¹ Ø£Ùˆ Ù…Ø§Ø¯Ø©)';
                        continue;
                    }
                    const newQty = Math.max(0, Number(row.computedQuantity) || 0);
                    const unit = (row.unit != null && row.unit !== '') ? String(row.unit) : '';
                    if (row.inventoryDocId) {
                        await updateDoc(doc(db, 'inventory', row.inventoryDocId), {
                            quantity: newQty,
                            unit: unit,
                            updatedAt: Timestamp.now()
                        });
                        fixed++;
                    } else {
                        if (newQty > 0) {
                            await addDoc(invRef, {
                                locationId: row.locationId,
                                locationType: row.locationType,
                                materialId: row.materialId,
                                quantity: newQty,
                                unit: unit,
                                createdAt: Timestamp.now(),
                                updatedAt: Timestamp.now()
                            });
                            fixed++;
                        } else {
                            if (firstSkipReason === null) firstSkipReason = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­Ø³ÙˆØ¨ ØµÙØ± (Ù„Ø§ ÙŠÙÙ†Ø´Ø£ Ø³Ø¬Ù„)';
                        }
                    }
                }
                if (fixed > 0) {
                    showAlert('ØªÙ… Ø¥ØµÙ„Ø§Ø­ ' + fixed + ' Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­.', 'success');
                    try {
                        await runInventoryVerification();
                    } catch (scanErr) {
                        console.warn('Re-scan after repair failed:', scanErr);
                        showAlert('ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø¨Ù†Ø¬Ø§Ø­ØŒ Ù„ÙƒÙ† Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙØ­Øµ ÙØ´Ù„Øª. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ´ØºÙŠÙ„ "ÙØ­Øµ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†" ÙŠØ¯ÙˆÙŠØ§Ù‹.', 'error');
                    }
                } else {
                    if (firstSkipReason) console.warn('repairInventoryDiscrepancies: no row fixed. First skip reason:', firstSkipReason);
                    showAlert('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø£ÙŠ Ø³Ø¬Ù„. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± ØµÙÙˆÙ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±ØµÙŠØ¯ Ù…Ø­Ø³ÙˆØ¨ Ø£Ùˆ Ø³Ø¬Ù„ Ù…Ø®Ø²ÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯.', 'error');
                }
            } catch (err) {
                console.error('Repair error:', err);
                showAlert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥ØµÙ„Ø§Ø­: ' + (err.message || err), 'error');
            }
        };

        // ========== DASHBOARD ==========
        async function loadDashboard() {
            try {
                const { collection, getDocs, query, where, Timestamp } = window.firebaseCollections;
                const db = window.firebaseDb;

                // Counts
                document.getElementById('statTotalMaterials').textContent = window.materials.length;
                document.getElementById('statTotalWarehouses').textContent = window.warehouses.length;
                document.getElementById('statTotalWorkSites').textContent = window.workSites.length;

                // Recent transactions
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayTimestamp = Timestamp.fromDate(today);

                const transactionsRef = collection(db, 'transactions');
                const q = query(transactionsRef, where('createdAt', '>=', todayTimestamp), orderBy('createdAt', 'desc'));
                const snapshot = await getDocs(q);
                
                let todayCount = 0;
                const recentDiv = document.getElementById('recentTransactions');
                recentDiv.innerHTML = '';

                snapshot.forEach((docSnapshot) => {
                    todayCount++;
                    const data = docSnapshot.data();
                    const typeLabels = {
                        'receive': 'Ø§Ø³ØªÙ„Ø§Ù…',
                        'deliver': 'ØªØ³Ù„ÙŠÙ…',
                        'return': 'Ø§Ø³ØªØ±Ø¯Ø§Ø¯'
                    };
                    const typeBadges = {
                        'receive': 'badge-info',
                        'deliver': 'badge-success',
                        'return': 'badge-warning'
                    };

                    const location = data.warehouseId 
                        ? window.warehouses.find(w => w.id === data.warehouseId)?.name
                        : window.workSites.find(w => w.id === data.workSiteId)?.name;

                    const transactionItem = document.createElement('div');
                    transactionItem.className = 'transaction-item';
                    transactionItem.innerHTML = `
                        <div class="transaction-item-header">
                            <span><strong>${typeLabels[data.type] || data.type}</strong> - ${data.number || 'Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù…'}</span>
                            <span class="badge ${typeBadges[data.type] || 'badge-info'}">${typeLabels[data.type] || data.type}</span>
                        </div>
                        <div>Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${location || '-'}</div>
                        <div>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯: ${data.items?.length || 0}</div>
                        <div>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${window.formatDate(data.date)}</div>
                    `;
                    recentDiv.appendChild(transactionItem);
                });

                document.getElementById('statTotalTransactions').textContent = todayCount;

                if (todayCount === 0) {
                    recentDiv.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ…</p>';
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // ========== REPORTS ==========
        // Load reports section - populate dropdowns
        window.loadReportsSection = async function() {
            try {
                if (!window.warehouses || window.warehouses.length === 0) {
                    await loadWarehouses();
                }
                if (!window.workSites || window.workSites.length === 0) {
                    await loadWorkSites();
                }
                if (!window.materials || window.materials.length === 0) {
                    await loadMaterials();
                }
                
                // Populate warehouse select
                const warehouseSelect = document.getElementById('warehouseReportSelect');
                if (warehouseSelect) {
                    const currentValue = warehouseSelect.value;
                    warehouseSelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª</option>';
                    const filteredWarehouses = window.getFilteredWarehousesSync ? window.getFilteredWarehousesSync() : window.warehouses;
                    filteredWarehouses.forEach(warehouse => {
                        const option = document.createElement('option');
                        option.value = warehouse.id;
                        option.textContent = warehouse.name;
                        warehouseSelect.appendChild(option);
                    });
                    warehouseSelect.value = currentValue;
                }
                
                // Populate work site select
                const workSiteSelect = document.getElementById('workSiteReportSelect');
                if (workSiteSelect) {
                    const currentValue = workSiteSelect.value;
                    workSiteSelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù…Ù„</option>';
                    const filteredWorkSites = window.getFilteredWorkSitesSync ? window.getFilteredWorkSitesSync() : window.workSites;
                    filteredWorkSites.forEach(workSite => {
                        const option = document.createElement('option');
                        option.value = workSite.id;
                        option.textContent = workSite.name;
                        workSiteSelect.appendChild(option);
                    });
                    workSiteSelect.value = currentValue;
                }
                
                // Populate material searchable select for movement report
                const materialSelectHidden = document.getElementById('materialMovementSelect');
                const materialOptionsList = document.getElementById('materialMovementOptionsList');
                const materialDisplay = document.getElementById('materialMovementDisplay');
                
                if (materialOptionsList && materialSelectHidden) {
                    const currentValue = materialSelectHidden.value;
                    materialOptionsList.innerHTML = '';
                    
                    // Sort materials by name
                    const sortedMaterials = [...window.materials].sort((a, b) => {
                        const nameA = (a.name || '').toLowerCase();
                        const nameB = (b.name || '').toLowerCase();
                        return nameA.localeCompare(nameB);
                    });
                    
                    sortedMaterials.forEach(material => {
                        const option = document.createElement('div');
                        option.className = 'option-item';
                        option.style.color = '#333';
                        option.style.backgroundColor = 'white';
                        option.dataset.value = material.id;
                        option.dataset.name = material.name;
                        const displayText = `${material.code ? material.code + ' - ' : ''}${material.name}${material.secondName ? ' (' + material.secondName + ')' : ''}`;
                        option.textContent = displayText;
                        option.onclick = function() {
                            selectMaterialMovement(material.id, material.name, material.secondName);
                        };
                        materialOptionsList.appendChild(option);
                    });
                    
                    // Restore selected value if exists
                    if (currentValue) {
                        const selectedMaterial = window.materials.find(m => m.id === currentValue);
                        if (selectedMaterial && materialDisplay) {
                            selectMaterialMovement(currentValue, selectedMaterial.name, selectedMaterial.secondName);
                        }
                    }
                }
                
                // Populate warehouse select for movement report (filtered by permissions)
                const warehouseMovementSelect = document.getElementById('warehouseMovementSelect');
                if (warehouseMovementSelect) {
                    const currentValue = warehouseMovementSelect.value;
                    warehouseMovementSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</option>';
                    const filteredWarehouses = window.getFilteredWarehousesSync ? window.getFilteredWarehousesSync() : window.warehouses;
                    filteredWarehouses.forEach(warehouse => {
                        const option = document.createElement('option');
                        option.value = warehouse.id;
                        option.textContent = warehouse.name;
                        warehouseMovementSelect.appendChild(option);
                    });
                    warehouseMovementSelect.value = currentValue;
                }
                if (typeof window.populateWarehouseReportMaterialOptions === 'function') {
                    window.populateWarehouseReportMaterialOptions();
                    window.updateWarehouseReportMaterialDisplay();
                }
            } catch (error) {
                console.error('Error loading reports section:', error);
            }
        };

        window.warehouseReportSelectedMaterials = new Set();

        window.toggleWarehouseReportMaterialOptions = function() {
            const options = document.getElementById('warehouseReportMaterialOptions');
            if (options) options.classList.toggle('show');
        };

        window.filterWarehouseReportMaterialOptions = function() {
            const search = (document.getElementById('warehouseReportMaterialSearch')?.value || '').toLowerCase().trim();
            document.querySelectorAll('#warehouseReportMaterialOptionsList .option-item').forEach(option => {
                const text = (option.textContent || '').toLowerCase();
                option.style.display = !search || text.includes(search) ? 'block' : 'none';
            });
        };

        window.selectWarehouseReportMaterial = function(materialId) {
            if (!window.warehouseReportSelectedMaterials) window.warehouseReportSelectedMaterials = new Set();
            if (window.warehouseReportSelectedMaterials.has(materialId)) {
                window.warehouseReportSelectedMaterials.delete(materialId);
            } else {
                window.warehouseReportSelectedMaterials.add(materialId);
            }
            window.updateWarehouseReportMaterialDisplay();
            window.populateWarehouseReportMaterialOptions();
            window.filterWarehouseReportMaterialOptions();
        };

        window.clearWarehouseReportMaterialSelection = function() {
            window.warehouseReportSelectedMaterials = new Set();
            document.getElementById('warehouseReportMaterialOptions')?.classList.remove('show');
            window.updateWarehouseReportMaterialDisplay();
            window.populateWarehouseReportMaterialOptions();
        };

        window.updateWarehouseReportMaterialDisplay = function() {
            const display = document.getElementById('warehouseReportMaterialDisplay');
            if (!display) return;
            const count = window.warehouseReportSelectedMaterials?.size || 0;
            if (count === 0) {
                display.textContent = 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯';
            } else {
                const names = [];
                (window.materials || []).forEach(m => {
                    if (window.warehouseReportSelectedMaterials.has(m.id)) {
                        names.push((m.code ? m.code + ' - ' : '') + m.name);
                    }
                });
                display.textContent = names.length > 3 ? count + ' Ù…ÙˆØ§Ø¯ Ù…Ø­Ø¯Ø¯Ø©' : names.join('ØŒ ') || count + ' Ù…ÙˆØ§Ø¯ Ù…Ø­Ø¯Ø¯Ø©';
            }
        };

        window.populateWarehouseReportMaterialOptions = function() {
            const list = document.getElementById('warehouseReportMaterialOptionsList');
            if (!list) return;
            list.innerHTML = '';
            const searchInput = document.getElementById('warehouseReportMaterialSearch');
            if (searchInput) searchInput.value = '';
            const allOpt = document.createElement('div');
            allOpt.className = 'option-item' + (!window.warehouseReportSelectedMaterials?.size ? ' selected' : '');
            allOpt.textContent = 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯';
            allOpt.style.fontWeight = 'bold';
            allOpt.style.borderBottom = '1px solid #eee';
            allOpt.style.paddingBottom = '8px';
            allOpt.style.marginBottom = '4px';
            allOpt.onclick = function(e) { e.stopPropagation(); window.clearWarehouseReportMaterialSelection(); };
            list.appendChild(allOpt);
            (window.materials || []).forEach(m => {
                const opt = document.createElement('div');
                opt.className = 'option-item' + (window.warehouseReportSelectedMaterials?.has(m.id) ? ' selected' : '');
                opt.textContent = (m.code ? m.code + ' - ' : '') + m.name;
                opt.dataset.value = m.id;
                opt.onclick = function(e) { e.stopPropagation(); window.selectWarehouseReportMaterial(m.id); };
                list.appendChild(opt);
            });
        };

        // Warehouse Inventory Report
        window.loadWarehouseInventoryReport = async function() {
            try {
                const warehouseId = document.getElementById('warehouseReportSelect').value;
                const materialFilterIds = Array.from(window.warehouseReportSelectedMaterials || []);
                const { collection, getDocs, query, where } = window.firebaseCollections;
                const db = window.firebaseDb;
                
                // Ensure data is loaded
                if (!window.warehouses || window.warehouses.length === 0) {
                    await loadWarehouses();
                }
                if (!window.materials || window.materials.length === 0) {
                    await loadMaterials();
                }
                
                // Get all transactions for the warehouse(s)
                const transactionsRef = collection(db, 'transactions');
                
                // Get receive transactions (Ø§Ø³ØªÙ„Ø§Ù…)
                let receiveQuery = query(transactionsRef, where('type', '==', 'receive'));
                if (warehouseId) {
                    receiveQuery = query(transactionsRef, where('type', '==', 'receive'), where('warehouseId', '==', warehouseId));
                }
                const receiveSnapshot = await getDocs(receiveQuery);
                
                // Get deliver transactions (ØªØ³Ù„ÙŠÙ…)
                let deliverQuery = query(transactionsRef, where('type', '==', 'deliver'));
                if (warehouseId) {
                    deliverQuery = query(transactionsRef, where('type', '==', 'deliver'), where('warehouseId', '==', warehouseId));
                }
                const deliverSnapshot = await getDocs(deliverQuery);
                
                // Get return transactions (Ø§Ø³ØªØ±Ø¯Ø§Ø¯)
                let returnQuery = query(transactionsRef, where('type', '==', 'return'));
                if (warehouseId) {
                    returnQuery = query(transactionsRef, where('type', '==', 'return'), where('warehouseId', '==', warehouseId));
                }
                const returnSnapshot = await getDocs(returnQuery);
                
                // Aggregate data by warehouse and material
                const warehousesData = {};
                
                // Process receive transactions
                receiveSnapshot.forEach((doc) => {
                    const data = doc.data();
                    const whId = data.warehouseId;
                    if (!whId) return;
                    
                    // Filter by permissions (warehouse and supplier access)
                    if (window.hasWarehouseAccess && !window.hasWarehouseAccess(whId)) return;
                    if (window.hasSupplierAccess && data.supplierId && !window.hasSupplierAccess(data.supplierId)) return;
                    
                    if (!warehousesData[whId]) {
                        warehousesData[whId] = {};
                    }
                    
                    data.items?.forEach(item => {
                        const matId = item.materialId;
                        if (!warehousesData[whId][matId]) {
                            warehousesData[whId][matId] = {
                                warehouseId: whId,
                                materialId: matId,
                                received: 0,
                                delivered: 0,
                                returnedUsable: 0,
                                returnedDamaged: 0,
                                returned: 0,
                                current: 0,
                                currentUsable: 0,
                                currentDamaged: 0,
                                unit: item.unit
                            };
                        }
                        warehousesData[whId][matId].received += parseFloat(item.quantity) || 0;
                    });
                });
                
                // Process deliver transactions
                deliverSnapshot.forEach((doc) => {
                    const data = doc.data();
                    const whId = data.warehouseId;
                    if (!whId) return;
                    
                    // Filter by permissions (warehouse and work site access)
                    if (window.hasWarehouseAccess && !window.hasWarehouseAccess(whId)) return;
                    if (window.hasWorkSiteAccess && data.workSiteId && !window.hasWorkSiteAccess(data.workSiteId)) return;
                    
                    if (!warehousesData[whId]) {
                        warehousesData[whId] = {};
                    }
                    
                    data.items?.forEach(item => {
                        const matId = item.materialId;
                        if (!warehousesData[whId][matId]) {
                            warehousesData[whId][matId] = {
                                warehouseId: whId,
                                materialId: matId,
                                received: 0,
                                delivered: 0,
                                returnedUsable: 0,
                                returnedDamaged: 0,
                                returned: 0,
                                current: 0,
                                currentUsable: 0,
                                currentDamaged: 0,
                                unit: item.unit
                            };
                        }
                        warehousesData[whId][matId].delivered += parseFloat(item.quantity) || 0;
                    });
                });
                
                // Process return transactions
                returnSnapshot.forEach((doc) => {
                    const data = doc.data();
                    const whId = data.warehouseId;
                    if (!whId) return;
                    
                    // Filter by permissions (warehouse and work site access)
                    if (window.hasWarehouseAccess && !window.hasWarehouseAccess(whId)) return;
                    if (window.hasWorkSiteAccess && data.workSiteId && !window.hasWorkSiteAccess(data.workSiteId)) return;
                    
                    if (!warehousesData[whId]) {
                        warehousesData[whId] = {};
                    }
                    
                    data.items?.forEach(item => {
                        const matId = item.materialId;
                        if (!warehousesData[whId][matId]) {
                            warehousesData[whId][matId] = {
                                warehouseId: whId,
                                materialId: matId,
                                received: 0,
                                delivered: 0,
                                returnedUsable: 0,
                                returnedDamaged: 0,
                                returned: 0,
                                current: 0,
                                currentUsable: 0,
                                currentDamaged: 0,
                                unit: item.unit
                            };
                        }
                        const quantity = parseFloat(item.quantity) || 0;
                        warehousesData[whId][matId].returned += quantity;
                        if (item.status === 'Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…') {
                            warehousesData[whId][matId].returnedUsable += quantity;
                        } else if (item.status === 'ØªØ§Ù„Ù') {
                            warehousesData[whId][matId].returnedDamaged += quantity;
                        }
                    });
                });
                
                // Calculate current inventory
                Object.keys(warehousesData).forEach(whId => {
                    Object.keys(warehousesData[whId]).forEach(matId => {
                        const item = warehousesData[whId][matId];
                        // Total current = received - delivered + returned
                        item.current = item.received - item.delivered + item.returned;
                        // Usable = received - delivered + returned (usable only)
                        item.currentUsable = item.received - item.delivered + item.returnedUsable;
                        // Damaged = returned (damaged only)
                        item.currentDamaged = item.returnedDamaged;
                    });
                });
                
                // Convert to array format for each warehouse
                const warehousesDataArray = {};
                Object.keys(warehousesData).forEach(whId => {
                    warehousesDataArray[whId] = Object.values(warehousesData[whId]);
                });
                
                // Generate report HTML
                const reportDiv = document.getElementById('warehouseInventoryReport');
                const contentDiv = document.getElementById('warehouseInventoryReportContent');
                
                if (Object.keys(warehousesDataArray).length === 0) {
                    contentDiv.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø®Ø²ÙˆÙ† ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</p>';
                    reportDiv.style.display = 'block';
                    window.warehouseInventoryReportData = { warehousesData: warehousesDataArray, warehouseId };
                    return;
                }
                
                // Sort warehouses by name
                const sortedWarehouseIds = Object.keys(warehousesDataArray).sort((a, b) => {
                    const whA = window.warehouses.find(w => w.id === a);
                    const whB = window.warehouses.find(w => w.id === b);
                    return (whA?.name || '').localeCompare(whB?.name || '');
                });
                
                let html = '';
                sortedWarehouseIds.forEach(whId => {
                    const warehouse = window.warehouses.find(w => w.id === whId);
                    let items = warehousesDataArray[whId];
                    if (materialFilterIds.length > 0) {
                        items = items.filter(item => materialFilterIds.includes(item.materialId));
                    }
                    if (items.length === 0) return;
                    items = items.sort((a, b) => {
                        const matA = window.materials.find(m => m.id === a.materialId);
                        const matB = window.materials.find(m => m.id === b.materialId);
                        const codeA = (matA?.code || '').toString().toLowerCase();
                        const codeB = (matB?.code || '').toString().toLowerCase();
                        return codeA.localeCompare(codeB, 'ar');
                    });
                    
                    html += `
                        <div style="margin-bottom: 30px;">
                            <h4 style="color: #667eea; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #667eea;">
                                Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹: ${warehouse ? warehouse.name : whId}
                            </h4>
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">#</th>
                                        <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">Ø±Ù…Ø² Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                                        <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                                        <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ</th>
                                        <th style="padding: 12px; text-align: center; border: 1px solid #ddd; color: #27ae60;">Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©</th>
                                        <th style="padding: 12px; text-align: center; border: 1px solid #ddd; color: #e74c3c;">Ø§Ù„Ù…Ø³Ù„Ù…Ø©</th>
                                        <th style="padding: 12px; text-align: center; border: 1px solid #ddd; color: #f39c12;">Ø§Ù„Ù…Ø³ØªØ±Ø¯Ø©</th>
                                        <th colspan="2" style="padding: 12px; text-align: center; border: 1px solid #ddd; color: #3498db; font-weight: bold; background: #e3f2fd;">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</th>
                                        <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                    </tr>
                                    <tr style="background: #f8f9fa;">
                                        <th colspan="7" style="padding: 8px; text-align: center; border: 1px solid #ddd;"></th>
                                        <th style="padding: 8px; text-align: center; border: 1px solid #ddd; color: #27ae60; font-weight: bold;">Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</th>
                                        <th style="padding: 8px; text-align: center; border: 1px solid #ddd; color: #e74c3c; font-weight: bold;">ØªØ§Ù„Ù</th>
                                        <th style="padding: 8px; text-align: center; border: 1px solid #ddd;"></th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    items.forEach((item, index) => {
                        const material = window.materials.find(m => m.id === item.materialId);
                        if (material) {
                            const received = parseFloat(item.received) || 0;
                            const delivered = parseFloat(item.delivered) || 0;
                            const returned = parseFloat(item.returned) || 0;
                            const currentUsable = parseFloat(item.currentUsable) || 0;
                            const currentDamaged = parseFloat(item.currentDamaged) || 0;
                            const usableStyle = currentUsable < 0 ? 'color: red; font-weight: bold;' : (currentUsable === 0 ? 'color: #999;' : 'color: #27ae60; font-weight: bold;');
                            const damagedStyle = currentDamaged < 0 ? 'color: red; font-weight: bold;' : (currentDamaged === 0 ? 'color: #999;' : 'color: #e74c3c; font-weight: bold;');
                            
                            html += `
                                <tr>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${index + 1}</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${material.code || '-'}</td>
                                    <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${material.name}</td>
                                    <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${material.secondName || '-'}</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #ddd; color: #27ae60; font-weight: bold;">${received.toFixed(3)}</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #ddd; color: #e74c3c; font-weight: bold;">${delivered.toFixed(3)}</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #ddd; color: #f39c12; font-weight: bold;">${returned.toFixed(3)}</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #ddd; ${usableStyle}">${currentUsable.toFixed(3)}</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #ddd; ${damagedStyle}">${currentDamaged.toFixed(3)}</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${item.unit || material.unit || '-'}</td>
                                </tr>
                            `;
                        }
                    });
                    
                    // Calculate totals
                    const totalReceived = items.reduce((sum, item) => sum + (parseFloat(item.received) || 0), 0);
                    const totalDelivered = items.reduce((sum, item) => sum + (parseFloat(item.delivered) || 0), 0);
                    const totalReturned = items.reduce((sum, item) => sum + (parseFloat(item.returned) || 0), 0);
                    const totalCurrentUsable = items.reduce((sum, item) => sum + (parseFloat(item.currentUsable) || 0), 0);
                    const totalCurrentDamaged = items.reduce((sum, item) => sum + (parseFloat(item.currentDamaged) || 0), 0);
                    
                    html += `
                                </tbody>
                                <tfoot>
                                    <tr style="background: #f8f9fa; font-weight: bold;">
                                        <td colspan="4" style="padding: 10px; text-align: right; border: 1px solid #ddd;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</td>
                                        <td style="padding: 10px; text-align: center; border: 1px solid #ddd; color: #27ae60;">${totalReceived.toFixed(3)}</td>
                                        <td style="padding: 10px; text-align: center; border: 1px solid #ddd; color: #e74c3c;">${totalDelivered.toFixed(3)}</td>
                                        <td style="padding: 10px; text-align: center; border: 1px solid #ddd; color: #f39c12;">${totalReturned.toFixed(3)}</td>
                                        <td style="padding: 10px; text-align: center; border: 1px solid #ddd; color: #27ae60;">${totalCurrentUsable.toFixed(3)}</td>
                                        <td style="padding: 10px; text-align: center; border: 1px solid #ddd; color: #e74c3c;">${totalCurrentDamaged.toFixed(3)}</td>
                                        <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${items.length} Ù…Ø§Ø¯Ø©</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    `;
                });
                
                if (!html) {
                    contentDiv.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</p>';
                } else {
                    contentDiv.innerHTML = html;
                }
                reportDiv.style.display = 'block';
                window.warehouseInventoryReportData = { warehousesData: warehousesDataArray, warehouseId };
            } catch (error) {
                console.error('Error loading warehouse inventory report:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª', 'error');
            }
        };

        // Print Warehouse Inventory Report
        window.printWarehouseInventoryReport = function() {
            if (!window.warehouseInventoryReportData) {
                showAlert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }
            
            const { warehousesData, warehouseId } = window.warehouseInventoryReportData;
            const reportDiv = document.getElementById('warehouseInventoryReportContent');
            
            if (!reportDiv || !reportDiv.innerHTML) {
                showAlert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©', 'error');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            const warehouseName = warehouseId 
                ? window.warehouses.find(w => w.id === warehouseId)?.name || 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª'
                : 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª';
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <title>ØªÙ‚Ø±ÙŠØ± Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª</title>
                    <style>
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                        body {
                            font-family: Arial, sans-serif;
                            padding: 20px;
                            direction: rtl;
                        }
                        h2 {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 2px solid #667eea;
                            padding-bottom: 15px;
                            color: #667eea;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 30px;
                        }
                        th, td {
                            border: 1px solid #000;
                            padding: 10px;
                            text-align: center;
                        }
                        th {
                            background-color: #f0f0f0;
                            font-weight: bold;
                        }
                        .warehouse-header {
                            background-color: #e8eaf6;
                            padding: 15px;
                            margin-bottom: 15px;
                            border-right: 4px solid #667eea;
                            font-weight: bold;
                            font-size: 1.1em;
                        }
                        .print-btn {
                            margin: 20px 0;
                            padding: 10px 20px;
                            background-color: #667eea;
                            color: white;
                            border: none;
                            cursor: pointer;
                            font-size: 16px;
                        }
                    </style>
                </head>
                <body>
                    <div>
                        <h2>ØªÙ‚Ø±ÙŠØ± Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª</h2>
                        <p style="text-align: center; margin-bottom: 20px;"><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${window.formatDate(new Date())}</p>
                        ${reportDiv.innerHTML}
                        <button class="print-btn no-print" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø©</button>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            setTimeout(() => printWindow.print(), 250);
        };

        // Work Site Delivered Materials Report
        window.loadWorkSiteDeliveredReport = async function() {
            try {
                const workSiteId = document.getElementById('workSiteReportSelect').value;
                const { collection, getDocs, query, where } = window.firebaseCollections;
                const db = window.firebaseDb;
                
                // Ensure data is loaded
                if (!window.workSites || window.workSites.length === 0) {
                    await loadWorkSites();
                }
                if (!window.materials || window.materials.length === 0) {
                    await loadMaterials();
                }
                
                // Get all deliver transactions
                let deliverQuery = query(collection(db, 'transactions'), where('type', '==', 'deliver'));
                const snapshot = await getDocs(deliverQuery);
                
                const deliveredData = {};
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (workSiteId && data.workSiteId !== workSiteId) return;
                    if (!data.workSiteId) return;
                    
                    data.items?.forEach(item => {
                        const key = `${data.workSiteId}_${item.materialId}`;
                        if (!deliveredData[key]) {
                            deliveredData[key] = {
                                workSiteId: data.workSiteId,
                                materialId: item.materialId,
                                totalQuantity: 0,
                                unit: item.unit,
                                receiptNumbers: []
                            };
                        }
                        // Use base quantity (already converted)
                        deliveredData[key].totalQuantity += item.quantity || 0;
                        // Collect receipt numbers
                        if (data.invoice && !deliveredData[key].receiptNumbers.includes(data.invoice)) {
                            deliveredData[key].receiptNumbers.push(data.invoice);
                        }
                    });
                });
                
                // Get returned quantities to calculate available
                const returnQuery = query(collection(db, 'transactions'), where('type', '==', 'return'));
                const returnSnapshot = await getDocs(returnQuery);
                
                const returnedData = {};
                returnSnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (workSiteId && data.workSiteId !== workSiteId) return;
                    if (!data.workSiteId) return;
                    
                    data.items?.forEach(item => {
                        const key = `${data.workSiteId}_${item.materialId}`;
                        if (!returnedData[key]) {
                            returnedData[key] = 0;
                        }
                        returnedData[key] += item.quantity || 0;
                    });
                });
                
                // Group by work site
                const workSitesData = {};
                Object.values(deliveredData).forEach(item => {
                    if (!workSitesData[item.workSiteId]) {
                        workSitesData[item.workSiteId] = [];
                    }
                    const key = `${item.workSiteId}_${item.materialId}`;
                    const returned = returnedData[key] || 0;
                    workSitesData[item.workSiteId].push({
                        ...item,
                        returnedQuantity: returned,
                        availableQuantity: Math.max(0, item.totalQuantity - returned)
                    });
                });
                
                // Generate report HTML
                const reportDiv = document.getElementById('workSiteDeliveredReport');
                const contentDiv = document.getElementById('workSiteDeliveredReportContent');
                
                if (Object.keys(workSitesData).length === 0) {
                    contentDiv.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ Ù…Ø³Ù„Ù…Ø© Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</p>';
                    reportDiv.style.display = 'block';
                    return;
                }
                
                let html = '';
                Object.keys(workSitesData).forEach(wsId => {
                    const workSite = window.workSites.find(w => w.id === wsId);
                    const items = workSitesData[wsId].sort((a, b) => {
                        const matA = window.materials.find(m => m.id === a.materialId);
                        const matB = window.materials.find(m => m.id === b.materialId);
                        return (matA?.name || '').localeCompare(matB?.name || '');
                    });
                    
                    html += `
                        <div style="margin-bottom: 30px;">
                            <h4 style="color: #f5576c; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #f5576c;">
                                Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„: ${workSite ? workSite.name : wsId}
                            </h4>
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">#</th>
                                        <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                                        <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ</th>
                                        <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„</th>
                                        <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Ø§Ù„Ù…Ø³Ù„Ù…Ø©</th>
                                        <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Ø§Ù„Ù…Ø³ØªØ±Ø¯Ø©</th>
                                        <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</th>
                                        <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    items.forEach((item, index) => {
                        const material = window.materials.find(m => m.id === item.materialId);
                        if (material) {
                            const receiptNumbersStr = (item.receiptNumbers && item.receiptNumbers.length > 0) 
                                ? item.receiptNumbers.join(', ') 
                                : '-';
                            html += `
                                <tr>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${index + 1}</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${material.code || '-'}</td>
                                    <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${material.name}</td>
                                    <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${material.secondName || '-'}</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${receiptNumbersStr}</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #ddd; font-weight: bold; color: #27ae60;">${item.totalQuantity.toFixed(3)}</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #ddd; color: #e74c3c;">${item.returnedQuantity.toFixed(3)}</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #ddd; font-weight: bold; color: #3498db;">${item.availableQuantity.toFixed(3)}</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${item.unit || material.unit || '-'}</td>
                                </tr>
                            `;
                        }
                    });
                    
                    html += `
                                </tbody>
                                <tfoot>
                                    <tr style="background: #f8f9fa; font-weight: bold;">
                                        <td colspan="5" style="padding: 10px; text-align: right; border: 1px solid #ddd;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</td>
                                        <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${items.length}</td>
                                        <td colspan="3" style="padding: 10px; text-align: center; border: 1px solid #ddd;">Ù…Ø§Ø¯Ø©</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    `;
                });
                
                contentDiv.innerHTML = html;
                reportDiv.style.display = 'block';
                window.workSiteDeliveredReportData = { workSitesData, workSiteId };
            } catch (error) {
                console.error('Error loading work site delivered report:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø³Ù„Ù…Ø©', 'error');
            }
        };

        // Material Movement Report
        window.loadMaterialMovementReport = async function() {
            try {
                const materialId = document.getElementById('materialMovementSelect').value;
                const warehouseId = document.getElementById('warehouseMovementSelect').value;
                const fromDate = document.getElementById('materialMovementFromDate').value;
                const toDate = document.getElementById('materialMovementToDate').value;
                
                if (!materialId || !warehouseId) {
                    showAlert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§Ø¯Ø© ÙˆØ§Ù„Ù…Ø³ØªÙˆØ¯Ø¹', 'error');
                    return;
                }
                
                const { collection, getDocs, query, where } = window.firebaseCollections;
                const db = window.firebaseDb;
                
                // Ensure data is loaded
                if (!window.materials || window.materials.length === 0) {
                    await loadMaterials();
                }
                if (!window.warehouses || window.warehouses.length === 0) {
                    await loadWarehouses();
                }
                if (!window.workSites || window.workSites.length === 0) {
                    await loadWorkSites();
                }
                if (!window.suppliers || window.suppliers.length === 0) {
                    await loadSuppliers();
                }
                
                const material = window.materials.find(m => m.id === materialId);
                const warehouse = window.warehouses.find(w => w.id === warehouseId);
                
                if (!material || !warehouse) {
                    showAlert('Ø§Ù„Ù…Ø§Ø¯Ø© Ø£Ùˆ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
                    return;
                }
                
                // Check warehouse access permission
                if (window.hasWarehouseAccess && !window.hasWarehouseAccess(warehouseId)) {
                    showAlert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹', 'error');
                    return;
                }
                
                // Get all transactions for this material and warehouse
                const transactionsRef = collection(db, 'transactions');
                const allTransactions = [];
                
                // Get receive transactions
                let receiveQuery = query(transactionsRef, where('type', '==', 'receive'), where('warehouseId', '==', warehouseId));
                const receiveSnapshot = await getDocs(receiveQuery);
                receiveSnapshot.forEach((doc) => {
                    const data = doc.data();
                    // Filter by supplier access permission
                    if (window.hasSupplierAccess && data.supplierId && !window.hasSupplierAccess(data.supplierId)) return;
                    
                    const item = data.items?.find(i => i.materialId === materialId);
                    if (item) {
                        allTransactions.push({
                            id: doc.id,
                            type: 'receive',
                            date: data.date,
                            number: data.number,
                            supplierId: data.supplierId,
                            receiptNumber: data.supplierInvoice || null,
                            quantity: item.quantity,
                            enteredQuantity: item.enteredQuantity,
                            enteredUnit: item.enteredUnit,
                            unit: item.unit
                        });
                    }
                });
                
                // Get deliver transactions
                let deliverQuery = query(transactionsRef, where('type', '==', 'deliver'), where('warehouseId', '==', warehouseId));
                const deliverSnapshot = await getDocs(deliverQuery);
                deliverSnapshot.forEach((doc) => {
                    const data = doc.data();
                    // Filter by work site access permission
                    if (window.hasWorkSiteAccess && data.workSiteId && !window.hasWorkSiteAccess(data.workSiteId)) return;
                    
                    const item = data.items?.find(i => i.materialId === materialId);
                    if (item) {
                        allTransactions.push({
                            id: doc.id,
                            type: 'deliver',
                            date: data.date,
                            number: data.number,
                            workSiteId: data.workSiteId,
                            receiptNumber: data.invoice || null,
                            quantity: item.quantity,
                            enteredQuantity: item.enteredQuantity,
                            enteredUnit: item.enteredUnit,
                            unit: item.unit
                        });
                    }
                });
                
                // Get return transactions
                let returnQuery = query(transactionsRef, where('type', '==', 'return'), where('warehouseId', '==', warehouseId));
                const returnSnapshot = await getDocs(returnQuery);
                returnSnapshot.forEach((doc) => {
                    const data = doc.data();
                    // Filter by work site access permission
                    if (window.hasWorkSiteAccess && data.workSiteId && !window.hasWorkSiteAccess(data.workSiteId)) return;
                    
                    const item = data.items?.find(i => i.materialId === materialId);
                    if (item) {
                        allTransactions.push({
                            id: doc.id,
                            type: 'return',
                            date: data.date,
                            number: data.number,
                            workSiteId: data.workSiteId,
                            receiptNumber: data.invoice || null,
                            quantity: item.quantity,
                            enteredQuantity: item.enteredQuantity,
                            enteredUnit: item.enteredUnit,
                            unit: item.unit
                        });
                    }
                });
                
                // Filter by date if provided
                let filteredTransactions = allTransactions;
                if (fromDate || toDate) {
                    filteredTransactions = allTransactions.filter(trans => {
                        if (!trans.date) return false;
                        const transDate = trans.date.toDate ? trans.date.toDate() : new Date(trans.date);
                        
                        if (fromDate) {
                            const from = new Date(fromDate);
                            from.setHours(0, 0, 0, 0);
                            if (transDate < from) return false;
                        }
                        
                        if (toDate) {
                            const to = new Date(toDate);
                            to.setHours(23, 59, 59, 999);
                            if (transDate > to) return false;
                        }
                        
                        return true;
                    });
                }
                
                // Sort by date (oldest first)
                filteredTransactions.sort((a, b) => {
                    const dateA = a.date.toDate ? a.date.toDate() : new Date(a.date);
                    const dateB = b.date.toDate ? b.date.toDate() : new Date(b.date);
                    return dateA - dateB;
                });
                
                // Generate report HTML
                const reportDiv = document.getElementById('materialMovementReport');
                const contentDiv = document.getElementById('materialMovementReportContent');
                
                if (filteredTransactions.length === 0) {
                    contentDiv.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø© ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</p>';
                    reportDiv.style.display = 'block';
                    window.materialMovementReportData = null;
                    return;
                }
                
                let html = `
                    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <p><strong>Ø§Ù„Ù…Ø§Ø¯Ø©:</strong> ${material.name}${material.secondName ? ' (' + material.secondName + ')' : ''}</p>
                        <p><strong>Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹:</strong> ${warehouse.name}</p>
                        <p><strong>Ø§Ù„ÙˆØ­Ø¯Ø©:</strong> ${material.unit || '-'}</p>
                        ${fromDate || toDate ? `<p><strong>Ø§Ù„ÙØªØ±Ø©:</strong> ${fromDate || 'Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©'} - ${toDate || 'Ø§Ù„Ù†Ù‡Ø§ÙŠØ©'}</p>` : '<p><strong>Ø§Ù„ÙØªØ±Ø©:</strong> Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØªØ±Ø§Øª</p>'}
                    </div>
                    <div style="margin-bottom: 15px;">
                        <input type="text" id="materialMovementReportSearch" placeholder="ğŸ” Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ±..." 
                               style="width: 100%; padding: 10px; border: 2px solid #4facfe; border-radius: 5px; font-size: 14px;"
                               onkeyup="filterMaterialMovementTable()">
                    </div>
                    <table id="materialMovementTable" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 12px; text-align: center; border: 1px solid #ddd; cursor: pointer;" onclick="sortMaterialMovementTable(0)">
                                    # <span id="sortIcon0">â‡…</span>
                                </th>
                                <th style="padding: 12px; text-align: center; border: 1px solid #ddd; cursor: pointer;" onclick="sortMaterialMovementTable(1)">
                                    Ø§Ù„ØªØ§Ø±ÙŠØ® <span id="sortIcon1">â‡…</span>
                                </th>
                                <th style="padding: 12px; text-align: center; border: 1px solid #ddd; cursor: pointer;" onclick="sortMaterialMovementTable(2)">
                                    Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ© <span id="sortIcon2">â‡…</span>
                                </th>
                                <th style="padding: 12px; text-align: center; border: 1px solid #ddd; cursor: pointer;" onclick="sortMaterialMovementTable(3)">
                                    Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„ <span id="sortIcon3">â‡…</span>
                                </th>
                                <th style="padding: 12px; text-align: center; border: 1px solid #ddd; cursor: pointer;" onclick="sortMaterialMovementTable(4)">
                                    Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© <span id="sortIcon4">â‡…</span>
                                </th>
                                <th style="padding: 12px; text-align: center; border: 1px solid #ddd; cursor: pointer;" onclick="sortMaterialMovementTable(5)">
                                    Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø© <span id="sortIcon5">â‡…</span>
                                </th>
                                <th style="padding: 12px; text-align: center; border: 1px solid #ddd; cursor: pointer;" onclick="sortMaterialMovementTable(6)">
                                    Ø§Ù„Ù…Ø³Ù„Ù…Ø© <span id="sortIcon6">â‡…</span>
                                </th>
                                <th style="padding: 12px; text-align: center; border: 1px solid #ddd; cursor: pointer;" onclick="sortMaterialMovementTable(7)">
                                    Ø§Ù„Ù…Ø³ØªØ±Ø¯Ø© <span id="sortIcon7">â‡…</span>
                                </th>
                                <th style="padding: 12px; text-align: center; border: 1px solid #ddd; cursor: pointer;" onclick="sortMaterialMovementTable(8)">
                                    Ø§Ù„Ø¬Ù‡Ø© <span id="sortIcon8">â‡…</span>
                                </th>
                                <th style="padding: 12px; text-align: center; border: 1px solid #ddd; cursor: pointer;" onclick="sortMaterialMovementTable(9)">
                                    Ø§Ù„ÙˆØ­Ø¯Ø© <span id="sortIcon9">â‡…</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="materialMovementTableBody">
                `;
                
                // Store transactions data for search and sort
                window.materialMovementTransactionsData = filteredTransactions.map((trans, index) => {
                    const dateStr = window.formatDate(trans.date);
                    const typeLabels = {
                        'receive': 'Ø§Ø³ØªÙ„Ø§Ù…',
                        'deliver': 'ØªØ³Ù„ÙŠÙ…',
                        'return': 'Ø§Ø³ØªØ±Ø¯Ø§Ø¯'
                    };
                    const typeColors = {
                        'receive': '#27ae60',
                        'deliver': '#e74c3c',
                        'return': '#f39c12'
                    };
                    
                    let receivedQty = '';
                    let deliveredQty = '';
                    let returnedQty = '';
                    let target = '';
                    
                    if (trans.type === 'receive') {
                        receivedQty = (trans.quantity || 0).toFixed(3);
                        const supplier = window.suppliers.find(s => s.id === trans.supplierId);
                        target = supplier ? supplier.name : '-';
                    } else if (trans.type === 'deliver') {
                        deliveredQty = (trans.quantity || 0).toFixed(3);
                        const workSite = window.workSites.find(w => w.id === trans.workSiteId);
                        target = workSite ? workSite.name : '-';
                    } else if (trans.type === 'return') {
                        returnedQty = (trans.quantity || 0).toFixed(3);
                        const workSite = window.workSites.find(w => w.id === trans.workSiteId);
                        target = workSite ? workSite.name : '-';
                    }
                    
                    return {
                        index: index + 1,
                        dateStr: dateStr,
                        date: trans.date,
                        number: trans.number || '-',
                        receiptNumber: trans.receiptNumber || '-',
                        type: typeLabels[trans.type],
                        typeColor: typeColors[trans.type],
                        receivedQty: receivedQty,
                        deliveredQty: deliveredQty,
                        returnedQty: returnedQty,
                        target: target,
                        unit: trans.unit || material.unit || '-',
                        rawData: trans
                    };
                });
                
                // Render table rows
                window.renderMaterialMovementTable = function(transactions = window.materialMovementTransactionsData) {
                    const tbody = document.getElementById('materialMovementTableBody');
                    if (!tbody) return;
                    
                    tbody.innerHTML = '';
                    transactions.forEach((item) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${item.index}</td>
                            <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${item.dateStr}</td>
                            <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${item.number}</td>
                            <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${item.receiptNumber}</td>
                            <td style="padding: 10px; text-align: center; border: 1px solid #ddd; color: ${item.typeColor}; font-weight: bold;">${item.type}</td>
                            <td style="padding: 10px; text-align: center; border: 1px solid #ddd; color: #27ae60; font-weight: bold;">${item.receivedQty}</td>
                            <td style="padding: 10px; text-align: center; border: 1px solid #ddd; color: #e74c3c; font-weight: bold;">${item.deliveredQty}</td>
                            <td style="padding: 10px; text-align: center; border: 1px solid #ddd; color: #f39c12; font-weight: bold;">${item.returnedQty}</td>
                            <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${item.target}</td>
                            <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${item.unit}</td>
                        `;
                        tbody.appendChild(row);
                    });
                };
                
                // Calculate totals
                const totalReceived = filteredTransactions
                    .filter(t => t.type === 'receive')
                    .reduce((sum, t) => sum + (parseFloat(t.quantity) || 0), 0);
                const totalDelivered = filteredTransactions
                    .filter(t => t.type === 'deliver')
                    .reduce((sum, t) => sum + (parseFloat(t.quantity) || 0), 0);
                const totalReturned = filteredTransactions
                    .filter(t => t.type === 'return')
                    .reduce((sum, t) => sum + (parseFloat(t.quantity) || 0), 0);
                
                // Store totals for dynamic updates
                window.materialMovementTotals = {
                    totalReceived,
                    totalDelivered,
                    totalReturned
                };
                
                // Function to update totals based on filtered data
                window.updateMaterialMovementTotals = function(filteredData) {
                    if (!filteredData || filteredData.length === 0) {
                        const footer = document.querySelector('#materialMovementTable tfoot');
                        if (footer) footer.style.display = 'none';
                        return;
                    }
                    
                    const totals = {
                        totalReceived: filteredData
                            .filter(item => item.rawData.type === 'receive')
                            .reduce((sum, item) => sum + (parseFloat(item.rawData.quantity) || 0), 0),
                        totalDelivered: filteredData
                            .filter(item => item.rawData.type === 'deliver')
                            .reduce((sum, item) => sum + (parseFloat(item.rawData.quantity) || 0), 0),
                        totalReturned: filteredData
                            .filter(item => item.rawData.type === 'return')
                            .reduce((sum, item) => sum + (parseFloat(item.rawData.quantity) || 0), 0)
                    };
                    
                    const footer = document.querySelector('#materialMovementTable tfoot');
                    if (footer) {
                        footer.innerHTML = `
                            <tr style="background: #f8f9fa; font-weight: bold;">
                                <td colspan="5" style="padding: 10px; text-align: right; border: 1px solid #ddd;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</td>
                                <td style="padding: 10px; text-align: center; border: 1px solid #ddd; color: #27ae60;">${totals.totalReceived.toFixed(3)}</td>
                                <td style="padding: 10px; text-align: center; border: 1px solid #ddd; color: #e74c3c;">${totals.totalDelivered.toFixed(3)}</td>
                                <td style="padding: 10px; text-align: center; border: 1px solid #ddd; color: #f39c12;">${totals.totalReturned.toFixed(3)}</td>
                                <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">-</td>
                                <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${(totals.totalReceived - totals.totalDelivered + totals.totalReturned).toFixed(3)}</td>
                            </tr>
                        `;
                        footer.style.display = '';
                    }
                };
                
                html += `
                        </tbody>
                        <tfoot>
                            <tr style="background: #f8f9fa; font-weight: bold;">
                                <td colspan="5" style="padding: 10px; text-align: right; border: 1px solid #ddd;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</td>
                                <td style="padding: 10px; text-align: center; border: 1px solid #ddd; color: #27ae60;">${totalReceived.toFixed(3)}</td>
                                <td style="padding: 10px; text-align: center; border: 1px solid #ddd; color: #e74c3c;">${totalDelivered.toFixed(3)}</td>
                                <td style="padding: 10px; text-align: center; border: 1px solid #ddd; color: #f39c12;">${totalReturned.toFixed(3)}</td>
                                <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">-</td>
                                <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${(totalReceived - totalDelivered + totalReturned).toFixed(3)}</td>
                            </tr>
                        </tfoot>
                    </table>
                `;
                
                contentDiv.innerHTML = html;
                reportDiv.style.display = 'block';
                
                // Render table rows after HTML is inserted into DOM
                setTimeout(() => {
                    if (window.renderMaterialMovementTable && window.materialMovementTransactionsData) {
                        window.renderMaterialMovementTable();
                    }
                    // Update totals after table is rendered
                    if (window.updateMaterialMovementTotals && window.materialMovementTransactionsData) {
                        window.updateMaterialMovementTotals(window.materialMovementTransactionsData);
                    }
                }, 100);
                
                window.materialMovementReportData = {
                    material,
                    warehouse,
                    transactions: filteredTransactions,
                    fromDate,
                    toDate
                };
            } catch (error) {
                console.error('Error loading material movement report:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ø­Ø±ÙƒØ© Ø§Ù„Ù…Ø§Ø¯Ø©', 'error');
            }
        };

        // Print Material Movement Report
        window.printMaterialMovementReport = function() {
            if (!window.materialMovementReportData) {
                showAlert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }
            
            const reportDiv = document.getElementById('materialMovementReportContent');
            
            if (!reportDiv || !reportDiv.innerHTML) {
                showAlert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©', 'error');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <title>ØªÙ‚Ø±ÙŠØ± Ø­Ø±ÙƒØ© Ø§Ù„Ù…Ø§Ø¯Ø©</title>
                    <style>
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                        body {
                            font-family: Arial, sans-serif;
                            padding: 20px;
                            direction: rtl;
                        }
                        h2 {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 2px solid #4facfe;
                            padding-bottom: 15px;
                            color: #4facfe;
                        }
                        .info-box {
                            background: #f8f9fa;
                            padding: 15px;
                            margin-bottom: 20px;
                            border-radius: 8px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 30px;
                        }
                        th, td {
                            border: 1px solid #000;
                            padding: 10px;
                            text-align: center;
                        }
                        th {
                            background-color: #f0f0f0;
                            font-weight: bold;
                        }
                        .print-btn {
                            margin: 20px 0;
                            padding: 10px 20px;
                            background-color: #4facfe;
                            color: white;
                            border: none;
                            cursor: pointer;
                            font-size: 16px;
                        }
                    </style>
                </head>
                <body>
                    <div>
                        <h2>ØªÙ‚Ø±ÙŠØ± Ø­Ø±ÙƒØ© Ø§Ù„Ù…Ø§Ø¯Ø©</h2>
                        ${reportDiv.innerHTML}
                        <button class="print-btn no-print" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø©</button>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            setTimeout(() => printWindow.print(), 250);
        };

        // Filter Material Movement Table
        window.filterMaterialMovementTable = function() {
            const searchInput = document.getElementById('materialMovementReportSearch');
            if (!searchInput || !window.materialMovementTransactionsData) return;
            
            const searchTerm = searchInput.value.toLowerCase().trim();
            let filtered = window.materialMovementTransactionsData;
            
            if (searchTerm) {
                filtered = window.materialMovementTransactionsData.filter(item => {
                    return (
                        item.dateStr.toLowerCase().includes(searchTerm) ||
                        (item.number || '').toLowerCase().includes(searchTerm) ||
                        (item.receiptNumber || '').toLowerCase().includes(searchTerm) ||
                        item.type.toLowerCase().includes(searchTerm) ||
                        (item.receivedQty || '').includes(searchTerm) ||
                        (item.deliveredQty || '').includes(searchTerm) ||
                        (item.returnedQty || '').includes(searchTerm) ||
                        (item.target || '').toLowerCase().includes(searchTerm) ||
                        (item.unit || '').toLowerCase().includes(searchTerm)
                    );
                });
            }
            
            // Update row numbers
            filtered.forEach((item, index) => {
                item.index = index + 1;
            });
            
            window.renderMaterialMovementTable(filtered);
            window.updateMaterialMovementTotals(filtered);
        };
        
        // Sort Material Movement Table
        window.materialMovementSortColumn = -1;
        window.materialMovementSortDirection = {};
        
        window.sortMaterialMovementTable = function(columnIndex) {
            if (!window.materialMovementTransactionsData) return;
            
            // Get search filter
            const searchInput = document.getElementById('materialMovementReportSearch');
            const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
            let dataToSort = window.materialMovementTransactionsData;
            
            // Apply search filter if exists
            if (searchTerm) {
                dataToSort = window.materialMovementTransactionsData.filter(item => {
                    return (
                        item.dateStr.toLowerCase().includes(searchTerm) ||
                        (item.number || '').toLowerCase().includes(searchTerm) ||
                        (item.receiptNumber || '').toLowerCase().includes(searchTerm) ||
                        item.type.toLowerCase().includes(searchTerm) ||
                        (item.receivedQty || '').includes(searchTerm) ||
                        (item.deliveredQty || '').includes(searchTerm) ||
                        (item.returnedQty || '').includes(searchTerm) ||
                        (item.target || '').toLowerCase().includes(searchTerm) ||
                        (item.unit || '').toLowerCase().includes(searchTerm)
                    );
                });
            }
            
            // Toggle sort direction
            const currentDirection = window.materialMovementSortDirection[columnIndex] || 'asc';
            const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
            window.materialMovementSortDirection[columnIndex] = newDirection;
            window.materialMovementSortColumn = columnIndex;
            
            // Reset all sort icons
            for (let i = 0; i < 10; i++) {
                const icon = document.getElementById(`sortIcon${i}`);
                if (icon) icon.textContent = 'â‡…';
            }
            
            // Update current sort icon
            const currentIcon = document.getElementById(`sortIcon${columnIndex}`);
            if (currentIcon) {
                currentIcon.textContent = newDirection === 'asc' ? 'â†‘' : 'â†“';
            }
            
            // Sort data
            dataToSort.sort((a, b) => {
                let aVal, bVal;
                
                switch(columnIndex) {
                    case 0: // #
                        aVal = parseInt(a.index);
                        bVal = parseInt(b.index);
                        break;
                    case 1: // Ø§Ù„ØªØ§Ø±ÙŠØ®
                        const dateA = a.rawData.date.toDate ? a.rawData.date.toDate() : new Date(a.rawData.date);
                        const dateB = b.rawData.date.toDate ? b.rawData.date.toDate() : new Date(b.rawData.date);
                        aVal = dateA.getTime();
                        bVal = dateB.getTime();
                        break;
                    case 2: // Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
                        aVal = (a.number || '').toLowerCase();
                        bVal = (b.number || '').toLowerCase();
                        break;
                    case 3: // Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„
                        aVal = (a.receiptNumber || '').toLowerCase();
                        bVal = (b.receiptNumber || '').toLowerCase();
                        break;
                    case 4: // Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
                        aVal = (a.type || '').toLowerCase();
                        bVal = (b.type || '').toLowerCase();
                        break;
                    case 5: // Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©
                        aVal = parseFloat(a.receivedQty) || 0;
                        bVal = parseFloat(b.receivedQty) || 0;
                        break;
                    case 6: // Ø§Ù„Ù…Ø³Ù„Ù…Ø©
                        aVal = parseFloat(a.deliveredQty) || 0;
                        bVal = parseFloat(b.deliveredQty) || 0;
                        break;
                    case 7: // Ø§Ù„Ù…Ø³ØªØ±Ø¯Ø©
                        aVal = parseFloat(a.returnedQty) || 0;
                        bVal = parseFloat(b.returnedQty) || 0;
                        break;
                    case 8: // Ø§Ù„Ø¬Ù‡Ø©
                        aVal = (a.target || '').toLowerCase();
                        bVal = (b.target || '').toLowerCase();
                        break;
                    case 9: // Ø§Ù„ÙˆØ­Ø¯Ø©
                        aVal = (a.unit || '').toLowerCase();
                        bVal = (b.unit || '').toLowerCase();
                        break;
                    default:
                        return 0;
                }
                
                if (typeof aVal === 'number' && typeof bVal === 'number') {
                    return newDirection === 'asc' ? aVal - bVal : bVal - aVal;
                } else {
                    if (aVal < bVal) return newDirection === 'asc' ? -1 : 1;
                    if (aVal > bVal) return newDirection === 'asc' ? 1 : -1;
                    return 0;
                }
            });
            
            // Update row numbers
            dataToSort.forEach((item, index) => {
                item.index = index + 1;
            });
            
            window.renderMaterialMovementTable(dataToSort);
            window.updateMaterialMovementTotals(dataToSort);
        };
        
        // Print Work Site Delivered Report
        window.printWorkSiteDeliveredReport = function() {
            if (!window.workSiteDeliveredReportData) {
                showAlert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }
            
            const reportDiv = document.getElementById('workSiteDeliveredReportContent');
            
            if (!reportDiv || !reportDiv.innerHTML) {
                showAlert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©', 'error');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            const workSiteId = window.workSiteDeliveredReportData.workSiteId;
            const workSiteName = workSiteId 
                ? window.workSites.find(w => w.id === workSiteId)?.name || 'Ø¬Ù…ÙŠØ¹ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù…Ù„'
                : 'Ø¬Ù…ÙŠØ¹ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù…Ù„';
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø³Ù„Ù…Ø©</title>
                    <style>
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                        body {
                            font-family: Arial, sans-serif;
                            padding: 20px;
                            direction: rtl;
                        }
                        h2 {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 2px solid #f5576c;
                            padding-bottom: 15px;
                            color: #f5576c;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 30px;
                        }
                        th, td {
                            border: 1px solid #000;
                            padding: 10px;
                            text-align: center;
                        }
                        th {
                            background-color: #f0f0f0;
                            font-weight: bold;
                        }
                        .work-site-header {
                            background-color: #fce4ec;
                            padding: 15px;
                            margin-bottom: 15px;
                            border-right: 4px solid #f5576c;
                            font-weight: bold;
                            font-size: 1.1em;
                        }
                        .print-btn {
                            margin: 20px 0;
                            padding: 10px 20px;
                            background-color: #f5576c;
                            color: white;
                            border: none;
                            cursor: pointer;
                            font-size: 16px;
                        }
                    </style>
                </head>
                <body>
                    <div>
                        <h2>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø³Ù„Ù…Ø© Ø¥Ù„Ù‰ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù…Ù„</h2>
                        <p style="text-align: center; margin-bottom: 20px;"><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${window.formatDate(new Date())}</p>
                        ${reportDiv.innerHTML}
                        <button class="print-btn no-print" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø©</button>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            setTimeout(() => printWindow.print(), 250);
        };

        // ========== USERS MANAGEMENT ==========
        window.users = [];
        window.currentUserPermissions = null;
        const USERS_PASSWORD = '1475963';
        const ACTIVITY_LOG_PASSWORD = '1475963';
        const REPORTS_PASSWORD = '1475963';
        const INVENTORY_PASSWORD = '1475963';

        // Check password before accessing reports
        window.checkReportsPassword = function() {
            const enteredPassword = prompt('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±:');
            
            if (enteredPassword === null) {
                // User cancelled - stay on current section
                return;
            }
            
            if (enteredPassword === REPORTS_PASSWORD) {
                // Password correct, open reports section
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.remove('active');
                });
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                const reportsSection = document.getElementById('reports');
                if (reportsSection) {
                    reportsSection.classList.add('active');
                }
                
                // Add active to reports menu item
                document.querySelectorAll('.menu-item').forEach(item => {
                    const onclickAttr = item.getAttribute('onclick');
                    if (onclickAttr && onclickAttr.includes("'reports'")) {
                        item.classList.add('active');
                    }
                });
                
                document.getElementById('pageTitle').textContent = window.t('reports') || 'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±';
                window.currentSection = 'reports';
                loadReportsSection();
            } else {
                showAlert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
            }
        };

        // Check password before accessing inventory tracking
        window.checkInventoryPassword = function() {
            const enteredPassword = prompt('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†:');
            
            if (enteredPassword === null) {
                // User cancelled - stay on current section
                return;
            }
            
            if (enteredPassword === INVENTORY_PASSWORD) {
                // Password correct, open inventory section
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.remove('active');
                });
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                const inventorySection = document.getElementById('inventory');
                if (inventorySection) {
                    inventorySection.classList.add('active');
                }
                
                // Add active to inventory menu item
                document.querySelectorAll('.menu-item').forEach(item => {
                    const onclickAttr = item.getAttribute('onclick');
                    if (onclickAttr && onclickAttr.includes("'inventory'")) {
                        item.classList.add('active');
                    }
                });
                
                document.getElementById('pageTitle').textContent = window.t('inventory') || 'ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†';
                window.currentSection = 'inventory';
                loadInventory();
            } else {
                showAlert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
            }
        };

        // Check password before accessing activity log
        window.checkActivityLogPassword = function() {
            const enteredPassword = prompt('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª:');
            
            if (enteredPassword === null) {
                // User cancelled - stay on current section
                return;
            }
            
            if (enteredPassword === ACTIVITY_LOG_PASSWORD) {
                // Password correct, open activity log section
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.remove('active');
                });
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                const activityLogSection = document.getElementById('activityLog');
                if (activityLogSection) {
                    activityLogSection.classList.add('active');
                }
                
                // Add active to activity log menu item
                document.querySelectorAll('.menu-item').forEach(item => {
                    const onclickAttr = item.getAttribute('onclick');
                    if (onclickAttr && onclickAttr.includes("'activityLog'")) {
                        item.classList.add('active');
                    }
                });
                
                document.getElementById('pageTitle').textContent = 'Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª';
                window.currentSection = 'activityLog';
                loadActivityLog();
            } else {
                showAlert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
            }
        };

        // Check password before accessing users management
        window.checkUsersPassword = function() {
            const enteredPassword = prompt('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:');
            
            if (enteredPassword === null) {
                // User cancelled - stay on current section
                return;
            }
            
            if (enteredPassword === USERS_PASSWORD) {
                // Password correct, open users section
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.remove('active');
                });
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                const usersSection = document.getElementById('users');
                if (usersSection) {
                    usersSection.classList.add('active');
                }
                
                // Add active to users menu item
                document.querySelectorAll('.menu-item').forEach(item => {
                    const onclickAttr = item.getAttribute('onclick');
                    if (onclickAttr && onclickAttr.includes("'users'")) {
                        item.classList.add('active');
                    }
                });
                
                document.getElementById('pageTitle').textContent = window.t('users');
                window.currentSection = 'users';
                loadUsers();
            } else {
                showAlert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
            }
        };

        async function loadUsers() {
            try {
                const { collection, getDocs, query, where } = window.firebaseCollections;
                const db = window.firebaseDb;
                const auth = window.firebaseAuth;
                const usersRef = collection(db, 'users');
                const snapshot = await getDocs(usersRef);
                
                window.users = [];
                
                // Add users from Firestore
                snapshot.forEach((docSnapshot) => {
                    window.users.push({ id: docSnapshot.id, ...docSnapshot.data() });
                });
                
                // Check if admin user exists in Firestore
                const adminExists = window.users.some(u => u.email === ADMIN_EMAIL);
                
                // If admin doesn't exist in Firestore, add it to the list
                if (!adminExists) {
                    window.users.unshift({
                        id: 'admin',
                        email: ADMIN_EMAIL,
                        name: 'Ø§Ù„Ù…Ø¯ÙŠØ±',
                        warehouses: [],
                        workSites: [],
                        isAdmin: true
                    });
                }
                
                displayUsers();
            } catch (error) {
                console.error('Error loading users:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†', 'error');
            }
        }

        function displayUsers() {
            const tbody = document.getElementById('usersTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';
            
            window.users.forEach(user => {
                const row = document.createElement('tr');
                
                // Check if this is the auto-created admin user
                const isAutoAdmin = user.id === 'admin' || (user.email === ADMIN_EMAIL && !user.id);
                
                // Determine permission type
                const permissionType = user.permissionType || (user.warehouses && user.warehouses.length > 0 ? 'custom' : 'full');
                
                // Get management permissions status
                const canManageMaterials = user.canManageMaterials === true || user.canManageMaterials === 'true';
                const canManageWarehouses = user.canManageWarehouses === true || user.canManageWarehouses === 'true';
                const canManageWorkSites = user.canManageWorkSites === true || user.canManageWorkSites === 'true';
                const canManageSuppliers = user.canManageSuppliers === true || user.canManageSuppliers === 'true';
                const canManageUnits = user.canManageUnits === true || user.canManageUnits === 'true';
                
                // Build management permissions display
                const managementPermissions = [];
                if (canManageMaterials) managementPermissions.push('Ø§Ù„Ù…ÙˆØ§Ø¯');
                if (canManageWarehouses) managementPermissions.push('Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª');
                if (canManageWorkSites) managementPermissions.push('Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù…Ù„');
                if (canManageSuppliers) managementPermissions.push('Ø§Ù„Ù…Ø²ÙˆØ¯ÙŠÙ†');
                if (canManageUnits) managementPermissions.push('Ø§Ù„ÙˆØ­Ø¯Ø§Øª');
                const managementDisplay = managementPermissions.length > 0 
                    ? managementPermissions.join(', ') 
                    : '<span style="color: #e74c3c;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¥Ø¯Ø§Ø±Ø©</span>';
                
                // Get warehouses and work sites names
                let warehousesDisplay = '';
                let workSitesDisplay = '';
                let suppliersDisplay = '';
                
                if (isAutoAdmin || permissionType === 'full') {
                    warehousesDisplay = '<span style="color: #27ae60; font-weight: bold;">ØµÙ„Ø§Ø­ÙŠØ© ÙƒØ§Ù…Ù„Ø©</span>';
                    workSitesDisplay = '<span style="color: #27ae60; font-weight: bold;">ØµÙ„Ø§Ø­ÙŠØ© ÙƒØ§Ù…Ù„Ø©</span>';
                    suppliersDisplay = '<span style="color: #27ae60; font-weight: bold;">ØµÙ„Ø§Ø­ÙŠØ© ÙƒØ§Ù…Ù„Ø©</span>';
                } else {
                    const warehousesNames = (user.warehouses || []).map(whId => {
                        const wh = window.warehouses?.find(w => w.id === whId);
                        return wh ? wh.name : whId;
                    }).join(', ') || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
                    
                    const workSitesNames = (user.workSites || []).map(wsId => {
                        const ws = window.workSites?.find(w => w.id === wsId);
                        return ws ? ws.name : wsId;
                    }).join(', ') || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
                    
                    const suppliersNames = (user.suppliers || []).map(supId => {
                        const sup = window.suppliers?.find(s => s.id === supId);
                        return sup ? sup.name : supId;
                    }).join(', ') || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
                    
                    warehousesDisplay = warehousesNames;
                    workSitesDisplay = workSitesNames;
                    suppliersDisplay = suppliersNames;
                }
                
                row.innerHTML = `
                    <td>${user.email}${isAutoAdmin ? ' <span style="color: #f39c12; font-weight: bold;">(Ù…Ø¯ÙŠØ±)</span>' : ''}</td>
                    <td>${user.name || '-'}</td>
                    <td>${warehousesDisplay}</td>
                    <td>${workSitesDisplay}</td>
                    <td style="font-size: 13px; max-width: 300px;">${isAutoAdmin ? '<span style="color: #27ae60; font-weight: bold;">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</span>' : managementDisplay}</td>
                    <td>
                        ${isAutoAdmin ? '<span style="color: #999; font-size: 12px;">Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø­Ø°Ù Ø§Ù„Ù…Ø¯ÙŠØ±</span>' : `
                            <button class="btn btn-success btn-small" onclick="showUserModal('${user.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="btn btn-danger btn-small" onclick="deleteUser('${user.id}')">Ø­Ø°Ù</button>
                        `}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Toggle permission type visibility
        window.togglePermissionType = function() {
            const permissionType = document.querySelector('input[name="userPermissionType"]:checked')?.value;
            const customSection = document.getElementById('customPermissionsSection');
            const customWorkSitesSection = document.getElementById('customWorkSitesSection');
            const customSuppliersSection = document.getElementById('customSuppliersSection');
            
            if (permissionType === 'full') {
                customSection.style.display = 'none';
                customWorkSitesSection.style.display = 'none';
                if (customSuppliersSection) customSuppliersSection.style.display = 'none';
            } else {
                customSection.style.display = 'block';
                customWorkSitesSection.style.display = 'block';
                if (customSuppliersSection) customSuppliersSection.style.display = 'block';
            }
        };

        window.showUserModal = async function(userId = null) {
            // Prevent editing admin user
            if (userId === 'admin') {
                showAlert('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ±', 'error');
                return;
            }
            
            const modal = document.getElementById('userModal');
            const form = document.getElementById('userForm');
            window.editingUserId = userId;
            
            // Ensure data is loaded
            if (!window.warehouses || window.warehouses.length === 0) {
                await loadWarehouses();
            }
            if (!window.workSites || window.workSites.length === 0) {
                await loadWorkSites();
            }
            if (!window.workSiteGroups || window.workSiteGroups.length === 0) {
                await loadWorkSiteGroups();
            }
            if (!window.suppliers || window.suppliers.length === 0) {
                await loadSuppliers();
            }
            
            // Populate warehouses list
            const warehousesList = document.getElementById('userWarehousesList');
            warehousesList.innerHTML = '';
            window.warehouses.forEach(warehouse => {
                const checkbox = document.createElement('div');
                checkbox.style.marginBottom = '8px';
                checkbox.innerHTML = `
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" value="${warehouse.id}" class="user-warehouse-checkbox" style="margin-left: 8px; width: 18px; height: 18px;">
                        <span>${warehouse.name}</span>
                    </label>
                `;
                warehousesList.appendChild(checkbox);
            });
            
            // Populate work site groups list
            const workSiteGroupsList = document.getElementById('userWorkSiteGroupsList');
            if (workSiteGroupsList) {
                workSiteGroupsList.innerHTML = '';
                (window.workSiteGroups || []).forEach(grp => {
                    const checkbox = document.createElement('div');
                    checkbox.style.marginBottom = '8px';
                    checkbox.innerHTML = `
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" value="${grp.id}" class="user-worksite-group-checkbox" style="margin-left: 8px; width: 18px; height: 18px;">
                            <span>${grp.name}</span>
                        </label>
                    `;
                    workSiteGroupsList.appendChild(checkbox);
                });
            }
            // Populate work sites list (individual)
            const workSitesList = document.getElementById('userWorkSitesList');
            workSitesList.innerHTML = '';
            window.workSites.forEach(workSite => {
                const checkbox = document.createElement('div');
                checkbox.style.marginBottom = '8px';
                checkbox.innerHTML = `
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" value="${workSite.id}" class="user-worksite-checkbox" style="margin-left: 8px; width: 18px; height: 18px;">
                        <span>${workSite.name}</span>
                    </label>
                `;
                workSitesList.appendChild(checkbox);
            });
            
            // Populate suppliers list
            const suppliersList = document.getElementById('userSuppliersList');
            suppliersList.innerHTML = '';
            window.suppliers.forEach(supplier => {
                const checkbox = document.createElement('div');
                checkbox.style.marginBottom = '8px';
                checkbox.innerHTML = `
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" value="${supplier.id}" class="user-supplier-checkbox" style="margin-left: 8px; width: 18px; height: 18px;">
                        <span>${supplier.name}</span>
                    </label>
                `;
                suppliersList.appendChild(checkbox);
            });
            
            if (userId) {
                // Edit mode - load existing data
                const user = window.users.find(u => u.id === userId);
                if (user) {
                    document.getElementById('userModalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…';
                    document.getElementById('userEmail').value = user.email;
                    document.getElementById('userEmail').disabled = true;
                    document.getElementById('userPassword').required = false;
                    document.getElementById('userPassword').placeholder = 'Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ØªØ±Ø¯ ØªØºÙŠÙŠØ±Ù‡';
                    document.getElementById('userName').value = user.name || '';
                    
                    // Set permission type
                    const permissionType = user.permissionType || (user.warehouses && user.warehouses.length > 0 ? 'custom' : 'full');
                    if (permissionType === 'full') {
                        document.getElementById('permissionFull').checked = true;
                    } else {
                        document.getElementById('permissionCustom').checked = true;
                    }
                    
                    // Show/hide custom sections based on permission type
                    togglePermissionType();
                    
                    // Set management permissions FIRST (before togglePermissionType to ensure they're set)
                    // Explicitly check for true (handle boolean true, string "true", or undefined/false)
                    const canManageMaterials = user.canManageMaterials === true || user.canManageMaterials === 'true';
                    const canManageWarehouses = user.canManageWarehouses === true || user.canManageWarehouses === 'true';
                    const canManageWorkSites = user.canManageWorkSites === true || user.canManageWorkSites === 'true';
                    const canManageSuppliers = user.canManageSuppliers === true || user.canManageSuppliers === 'true';
                    const canManageUnits = user.canManageUnits === true || user.canManageUnits === 'true';
                    
                    const materialsCheckbox = document.getElementById('userCanManageMaterials');
                    const warehousesCheckbox = document.getElementById('userCanManageWarehouses');
                    const workSitesCheckbox = document.getElementById('userCanManageWorkSites');
                    const suppliersCheckbox = document.getElementById('userCanManageSuppliers');
                    const unitsCheckbox = document.getElementById('userCanManageUnits');
                    
                    if (materialsCheckbox) materialsCheckbox.checked = canManageMaterials;
                    if (warehousesCheckbox) warehousesCheckbox.checked = canManageWarehouses;
                    if (workSitesCheckbox) workSitesCheckbox.checked = canManageWorkSites;
                    if (suppliersCheckbox) suppliersCheckbox.checked = canManageSuppliers;
                    if (unitsCheckbox) unitsCheckbox.checked = canManageUnits;
                    
                    // Operations permissions (receive, deliver, return: add, edit, delete)
                    const receiveAdd = user.receiveAdd === true || user.receiveAdd === 'true';
                    const receiveEdit = user.receiveEdit === true || user.receiveEdit === 'true';
                    const receiveDelete = user.receiveDelete === true || user.receiveDelete === 'true';
                    const deliverAdd = user.deliverAdd === true || user.deliverAdd === 'true';
                    const deliverEdit = user.deliverEdit === true || user.deliverEdit === 'true';
                    const deliverDelete = user.deliverDelete === true || user.deliverDelete === 'true';
                    const returnAdd = user.returnAdd === true || user.returnAdd === 'true';
                    const returnEdit = user.returnEdit === true || user.returnEdit === 'true';
                    const returnDelete = user.returnDelete === true || user.returnDelete === 'true';
                    const ra = document.getElementById('userReceiveAdd'); if (ra) ra.checked = receiveAdd;
                    const re = document.getElementById('userReceiveEdit'); if (re) re.checked = receiveEdit;
                    const rd = document.getElementById('userReceiveDelete'); if (rd) rd.checked = receiveDelete;
                    const da = document.getElementById('userDeliverAdd'); if (da) da.checked = deliverAdd;
                    const de = document.getElementById('userDeliverEdit'); if (de) de.checked = deliverEdit;
                    const dd = document.getElementById('userDeliverDelete'); if (dd) dd.checked = deliverDelete;
                    const rta = document.getElementById('userReturnAdd'); if (rta) rta.checked = returnAdd;
                    const rte = document.getElementById('userReturnEdit'); if (rte) rte.checked = returnEdit;
                    const rtd = document.getElementById('userReturnDelete'); if (rtd) rtd.checked = returnDelete;
                    
                    console.log('Setting management permissions in modal:', {
                        canManageMaterials,
                        canManageWarehouses,
                        canManageWorkSites,
                        canManageSuppliers,
                        canManageUnits,
                        rawValues: {
                            materials: user.canManageMaterials,
                            warehouses: user.canManageWarehouses,
                            workSites: user.canManageWorkSites,
                            suppliers: user.canManageSuppliers,
                            units: user.canManageUnits
                        }
                    });
                    
                    // Use setTimeout to ensure DOM is ready and sections are visible before checking boxes
                    setTimeout(() => {
                        // Double-check sections are visible
                        togglePermissionType();
                        
                        // Small delay to ensure DOM updates
                        setTimeout(() => {
                            // Check selected warehouses
                            (user.warehouses || []).forEach(whId => {
                                const checkbox = warehousesList.querySelector(`input.user-warehouse-checkbox[value="${whId}"]`);
                                if (checkbox) {
                                    checkbox.checked = true;
                                    console.log('Checked warehouse:', whId);
                                } else {
                                    console.warn('Warehouse checkbox not found:', whId);
                                }
                            });
                            
                            // Check selected work site groups
                            const workSiteGroupsListEl = document.getElementById('userWorkSiteGroupsList');
                            (user.workSiteGroupIds || []).forEach(grpId => {
                                const cb = workSiteGroupsListEl ? workSiteGroupsListEl.querySelector(`input.user-worksite-group-checkbox[value="${grpId}"]`) : null;
                                if (cb) cb.checked = true;
                            });
                            // Check selected work sites
                            (user.workSites || []).forEach(wsId => {
                                const checkbox = workSitesList.querySelector(`input.user-worksite-checkbox[value="${wsId}"]`);
                                if (checkbox) {
                                    checkbox.checked = true;
                                    console.log('Checked work site:', wsId);
                                } else {
                                    console.warn('Work site checkbox not found:', wsId);
                                }
                            });
                            
                            // Check selected suppliers
                            (user.suppliers || []).forEach(supId => {
                                const checkbox = suppliersList.querySelector(`input.user-supplier-checkbox[value="${supId}"]`);
                                if (checkbox) {
                                    checkbox.checked = true;
                                    console.log('Checked supplier:', supId);
                                } else {
                                    console.warn('Supplier checkbox not found:', supId);
                                }
                            });
                            
                            // Verify management permissions are still set
                            console.log('Verified management permissions after checkbox setup:', {
                                materials: materialsCheckbox?.checked,
                                warehouses: warehousesCheckbox?.checked,
                                workSites: workSitesCheckbox?.checked,
                                suppliers: suppliersCheckbox?.checked,
                                units: unitsCheckbox?.checked
                            });
                        }, 50);
                    }, 150);
                }
            } else {
                // Add mode - reset form
                form.reset();
                document.getElementById('userModalTitle').textContent = 'Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯';
                document.getElementById('userEmail').disabled = false;
                document.getElementById('userPassword').required = true;
                document.getElementById('userPassword').placeholder = '';
                document.getElementById('permissionFull').checked = true;
                togglePermissionType();
                // Default all management permissions to true for new users
                document.getElementById('userCanManageMaterials').checked = true;
                document.getElementById('userCanManageWarehouses').checked = true;
                document.getElementById('userCanManageWorkSites').checked = true;
                document.getElementById('userCanManageSuppliers').checked = true;
                document.getElementById('userCanManageUnits').checked = true;
                // Default operations permissions to false for new users
                ['userReceiveAdd','userReceiveEdit','userReceiveDelete','userDeliverAdd','userDeliverEdit','userDeliverDelete','userReturnAdd','userReturnEdit','userReturnDelete'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.checked = false;
                });
            }
            
            modal.classList.add('active');
        };

        async function saveUser(e) {
            e.preventDefault();
            const { addDoc, updateDoc, doc, collection } = window.firebaseCollections;
            const db = window.firebaseDb;
            const auth = window.firebaseAuth;
            const createUserWithEmailAndPassword = window.createUserWithEmailAndPassword;
            
            const email = document.getElementById('userEmail').value;
            const password = document.getElementById('userPassword').value;
            const name = document.getElementById('userName').value;
            const permissionType = document.querySelector('input[name="userPermissionType"]:checked')?.value || 'full';
            
            // Get selected warehouses, work sites, work site groups, and suppliers based on permission type
            let selectedWarehouses = [];
            let selectedWorkSites = [];
            let selectedWorkSiteGroupIds = [];
            let selectedSuppliers = [];
            
            if (permissionType === 'custom') {
                // Get checked warehouses
                const warehouseCheckboxes = document.querySelectorAll('#userWarehousesList .user-warehouse-checkbox:checked');
                selectedWarehouses = Array.from(warehouseCheckboxes).map(cb => cb.value);
                
                // Get checked work site groups
                const workSiteGroupCheckboxes = document.querySelectorAll('#userWorkSiteGroupsList .user-worksite-group-checkbox:checked');
                selectedWorkSiteGroupIds = Array.from(workSiteGroupCheckboxes).map(cb => cb.value);
                // Get checked work sites
                const workSiteCheckboxes = document.querySelectorAll('#userWorkSitesList .user-worksite-checkbox:checked');
                selectedWorkSites = Array.from(workSiteCheckboxes).map(cb => cb.value);
                
                // Get checked suppliers
                const supplierCheckboxes = document.querySelectorAll('#userSuppliersList .user-supplier-checkbox:checked');
                selectedSuppliers = Array.from(supplierCheckboxes).map(cb => cb.value);
            } else {
                // Full access - empty arrays means all access
                selectedWarehouses = [];
                selectedWorkSites = [];
                selectedWorkSiteGroupIds = [];
                selectedSuppliers = [];
            }
            
            // Get management permissions (explicitly get boolean values)
            const materialsCheckbox = document.getElementById('userCanManageMaterials');
            const warehousesCheckbox = document.getElementById('userCanManageWarehouses');
            const workSitesCheckbox = document.getElementById('userCanManageWorkSites');
            const suppliersCheckbox = document.getElementById('userCanManageSuppliers');
            const unitsCheckbox = document.getElementById('userCanManageUnits');
            
            // Debug: Log checkbox states before processing
            console.log('Checkbox states before processing:', {
                materialsCheckbox: materialsCheckbox ? materialsCheckbox.checked : 'NOT FOUND',
                warehousesCheckbox: warehousesCheckbox ? warehousesCheckbox.checked : 'NOT FOUND',
                workSitesCheckbox: workSitesCheckbox ? workSitesCheckbox.checked : 'NOT FOUND',
                suppliersCheckbox: suppliersCheckbox ? suppliersCheckbox.checked : 'NOT FOUND',
                unitsCheckbox: unitsCheckbox ? unitsCheckbox.checked : 'NOT FOUND'
            });
            
            const canManageMaterials = materialsCheckbox ? materialsCheckbox.checked === true : false;
            const canManageWarehouses = warehousesCheckbox ? warehousesCheckbox.checked === true : false;
            const canManageWorkSites = workSitesCheckbox ? workSitesCheckbox.checked === true : false;
            const canManageSuppliers = suppliersCheckbox ? suppliersCheckbox.checked === true : false;
            const canManageUnits = unitsCheckbox ? unitsCheckbox.checked === true : false;
            
            const receiveAdd = document.getElementById('userReceiveAdd')?.checked === true;
            const receiveEdit = document.getElementById('userReceiveEdit')?.checked === true;
            const receiveDelete = document.getElementById('userReceiveDelete')?.checked === true;
            const deliverAdd = document.getElementById('userDeliverAdd')?.checked === true;
            const deliverEdit = document.getElementById('userDeliverEdit')?.checked === true;
            const deliverDelete = document.getElementById('userDeliverDelete')?.checked === true;
            const returnAdd = document.getElementById('userReturnAdd')?.checked === true;
            const returnEdit = document.getElementById('userReturnEdit')?.checked === true;
            const returnDelete = document.getElementById('userReturnDelete')?.checked === true;
            
            console.log('Saving user permissions to database:', {
                email,
                canManageMaterials,
                canManageWarehouses,
                canManageWorkSites,
                canManageSuppliers,
                canManageUnits,
                rawValues: {
                    materials: materialsCheckbox?.checked,
                    warehouses: warehousesCheckbox?.checked,
                    workSites: workSitesCheckbox?.checked,
                    suppliers: suppliersCheckbox?.checked,
                    units: unitsCheckbox?.checked
                }
            });
            
            try {
                if (window.editingUserId) {
                    // Update existing user
                    const userData = {
                        name: name,
                        permissionType: permissionType,
                        warehouses: selectedWarehouses,
                        workSites: selectedWorkSites,
                        workSiteGroupIds: selectedWorkSiteGroupIds,
                        suppliers: selectedSuppliers,
                        canManageMaterials: canManageMaterials,
                        canManageWarehouses: canManageWarehouses,
                        canManageWorkSites: canManageWorkSites,
                        canManageSuppliers: canManageSuppliers,
                        canManageUnits: canManageUnits,
                        receiveAdd, receiveEdit, receiveDelete,
                        deliverAdd, deliverEdit, deliverDelete,
                        returnAdd, returnEdit, returnDelete,
                        updatedAt: new Date()
                    };
                    
                    const oldUser = window.users.find(u => u.id === window.editingUserId);
                    
                    // Debug: Log what will be saved
                    console.log('About to save user data to Firestore:', {
                        userId: window.editingUserId,
                        userData: userData,
                        permissions: {
                            canManageMaterials: userData.canManageMaterials,
                            canManageWarehouses: userData.canManageWarehouses,
                            canManageWorkSites: userData.canManageWorkSites,
                            canManageSuppliers: userData.canManageSuppliers,
                            canManageUnits: userData.canManageUnits,
                            receiveAdd, receiveEdit, receiveDelete,
                            deliverAdd, deliverEdit, deliverDelete,
                            returnAdd, returnEdit, returnDelete
                        }
                    });
                    
                    // Save to Firestore with explicit boolean values
                    const userRef = doc(db, 'users', window.editingUserId);
                    await updateDoc(userRef, {
                        name: name,
                        permissionType: permissionType,
                        warehouses: selectedWarehouses,
                        workSites: selectedWorkSites,
                        workSiteGroupIds: selectedWorkSiteGroupIds,
                        suppliers: selectedSuppliers,
                        canManageMaterials: Boolean(canManageMaterials),
                        canManageWarehouses: Boolean(canManageWarehouses),
                        canManageWorkSites: Boolean(canManageWorkSites),
                        canManageSuppliers: Boolean(canManageSuppliers),
                        canManageUnits: Boolean(canManageUnits),
                        receiveAdd: Boolean(receiveAdd),
                        receiveEdit: Boolean(receiveEdit),
                        receiveDelete: Boolean(receiveDelete),
                        deliverAdd: Boolean(deliverAdd),
                        deliverEdit: Boolean(deliverEdit),
                        deliverDelete: Boolean(deliverDelete),
                        returnAdd: Boolean(returnAdd),
                        returnEdit: Boolean(returnEdit),
                        returnDelete: Boolean(returnDelete),
                        updatedAt: new Date()
                    });
                    
                    // Verify what was saved immediately after save
                    const verifySnapshot = await getDocs(query(collection(db, 'users'), where('email', '==', email)));
                    if (!verifySnapshot.empty) {
                        const savedData = verifySnapshot.docs[0].data();
                        console.log('Verified saved data from Firestore:', {
                            canManageMaterials: savedData?.canManageMaterials,
                            canManageWarehouses: savedData?.canManageWarehouses,
                            canManageWorkSites: savedData?.canManageWorkSites,
                            canManageSuppliers: savedData?.canManageSuppliers,
                            canManageUnits: savedData?.canManageUnits,
                            fullSavedData: savedData
                        });
                    } else {
                        console.error('User document not found after save!');
                    }
                    
                    await logActivity('update', 'user', window.editingUserId, name || email, userData, oldUser);
                    
                    // If the updated user is the current logged-in user, reload their permissions
                    const auth = window.firebaseAuth;
                    if (auth.currentUser && auth.currentUser.email === email) {
                        // Force reload permissions from database
                        await loadCurrentUserPermissions();
                        // Wait a bit to ensure permissions are fully loaded
                        await new Promise(resolve => setTimeout(resolve, 200));
                        
                        // Reload current section data to reflect permission changes
                        // All load functions (loadMaterials, loadWarehouses, etc.) will call updateManagementButtonsVisibility at the end
                        if (window.currentSection) {
                            if (window.currentSection === 'materials' && typeof loadMaterials === 'function') {
                                await loadMaterials();
                            } else if (window.currentSection === 'warehouses' && typeof loadWarehouses === 'function') {
                                await loadWarehouses();
                            } else if (window.currentSection === 'workSites' && typeof loadWorkSites === 'function') {
                                await loadWorkSites();
                            } else if (window.currentSection === 'workSiteGroups' && typeof loadWorkSiteGroups === 'function') {
                                await loadWorkSiteGroups();
                            } else if (window.currentSection === 'suppliers' && typeof loadSuppliers === 'function') {
                                await loadSuppliers();
                            } else if (window.currentSection === 'units' && typeof loadUnits === 'function') {
                                await loadUnits();
                            } else if (window.currentSection === 'receive' && typeof loadReceives === 'function') {
                                await loadReceives();
                            } else if (window.currentSection === 'deliver' && typeof loadDelivers === 'function') {
                                await loadDelivers();
                            } else if (window.currentSection === 'return' && typeof loadReturns === 'function') {
                                await loadReturns();
                            } else {
                                // For other sections, update buttons visibility directly
                                updateManagementButtonsVisibility();
                            }
                        } else {
                            // No current section, update buttons visibility directly
                            updateManagementButtonsVisibility();
                        }
                    }
                    
                    showAlert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } else {
                    // Create new user
                    if (!password || password.length < 6) {
                        showAlert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
                        return;
                    }
                    
                    // Create user in Firebase Authentication
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const newUserUid = userCredential.user.uid;
                    
                    // Save user data in Firestore using UID as document ID
                    // This ensures we can find the user by UID later
                    const userData = {
                        email: email,
                        name: name,
                        permissionType: permissionType,
                        warehouses: selectedWarehouses,
                        workSites: selectedWorkSites,
                        workSiteGroupIds: selectedWorkSiteGroupIds,
                        suppliers: selectedSuppliers,
                        canManageMaterials: Boolean(canManageMaterials),
                        canManageWarehouses: Boolean(canManageWarehouses),
                        canManageWorkSites: Boolean(canManageWorkSites),
                        canManageSuppliers: Boolean(canManageSuppliers),
                        canManageUnits: Boolean(canManageUnits),
                        receiveAdd: Boolean(receiveAdd),
                        receiveEdit: Boolean(receiveEdit),
                        receiveDelete: Boolean(receiveDelete),
                        deliverAdd: Boolean(deliverAdd),
                        deliverEdit: Boolean(deliverEdit),
                        deliverDelete: Boolean(deliverDelete),
                        returnAdd: Boolean(returnAdd),
                        returnEdit: Boolean(returnEdit),
                        returnDelete: Boolean(returnDelete),
                        createdAt: new Date(),
                        updatedAt: new Date()
                    };
                    
                    // Use setDoc with UID as document ID instead of addDoc
                    const { doc: docFn, setDoc: setDocFn } = window.firebaseCollections;
                    const userDocRef = docFn(db, 'users', newUserUid);
                    await setDocFn(userDocRef, userData);
                    
                    console.log('Created user document with UID as document ID:', newUserUid);
                    await logActivity('create', 'user', newUserUid, name || email, userData);
                    showAlert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
                }
                
                closeModal('userModal');
                await loadUsers();
            } catch (error) {
                console.error('Error saving user:', error);
                if (error.code === 'auth/email-already-in-use') {
                    showAlert('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„', 'error');
                } else if (error.code === 'auth/invalid-email') {
                    showAlert('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­', 'error');
                } else if (error.code === 'auth/weak-password') {
                    showAlert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹', 'error');
                } else {
                    showAlert('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ' + error.message, 'error');
                }
            }
        }

        window.deleteUser = async function(userId) {
            // Prevent deleting admin user
            if (userId === 'admin') {
                showAlert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ±', 'error');
                return;
            }
            
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) {
                return;
            }
            
            try {
                const { deleteDoc, doc } = window.firebaseCollections;
                const db = window.firebaseDb;
                
                const user = window.users.find(u => u.id === userId);
                const userName = user ? (user.name || user.email) : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                await deleteDoc(doc(db, 'users', userId));
                await logActivity('delete', 'user', userId, userName);
                showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
                await loadUsers();
            } catch (error) {
                console.error('Error deleting user:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'error');
            }
        }

        // Load current user permissions
        // This function is called to load user permissions from Firestore
        // It should be called before any data operations that depend on permissions
        async function loadCurrentUserPermissions() {
            try {
                // Wait for Firebase to be fully initialized
                if (!window.firebaseCollections || !window.firebaseDb || !window.firebaseAuth) {
                    console.warn('loadCurrentUserPermissions: Firebase not initialized, waiting...');
                    await new Promise(resolve => setTimeout(resolve, 100));
                    if (!window.firebaseCollections || !window.firebaseDb || !window.firebaseAuth) {
                        console.error('loadCurrentUserPermissions: Firebase still not initialized');
                        return;
                    }
                }
                
                const { collection, getDocs, query, where, doc: docRef, getDoc } = window.firebaseCollections;
                const db = window.firebaseDb;
                const auth = window.firebaseAuth;
                
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    console.log('loadCurrentUserPermissions: No current user');
                    // Set default no-access permissions
                    window.currentUserPermissions = {
                        warehouses: [],
                        workSites: [],
                        workSiteGroupIds: [],
                        suppliers: [],
                        permissionType: 'custom',
                        isAdmin: false,
                        canManageMaterials: false,
                        canManageWarehouses: false,
                        canManageWorkSites: false,
                        canManageSuppliers: false,
                        canManageUnits: false,
                        receiveAdd: false, receiveEdit: false, receiveDelete: false,
                        deliverAdd: false, deliverEdit: false, deliverDelete: false,
                        returnAdd: false, returnEdit: false, returnDelete: false
                    };
                    return;
                }
                
                // Ensure database reference is valid
                if (!db) {
                    console.error('loadCurrentUserPermissions: Database reference is null');
                    return;
                }
                
                // Search for user document: by UID first, then by email (exact and case-insensitive)
                let userDoc = null;
                let userData = null;
                
                try {
                    const userDocRef = docRef(db, 'users', currentUser.uid);
                    const docSnapshot = await getDoc(userDocRef);
                    
                    if (docSnapshot.exists()) {
                        userDoc = docSnapshot;
                        userData = docSnapshot.data();
                    } else {
                        const usersRef = collection(db, 'users');
                        let q = query(usersRef, where('email', '==', currentUser.email));
                        let snapshot = await getDocs(q);
                        
                        if (!snapshot.empty) {
                            userDoc = snapshot.docs[0];
                            userData = snapshot.docs[0].data();
                        } else {
                            const allUsersSnapshot = await getDocs(usersRef);
                            const matchingDocs = [];
                            allUsersSnapshot.forEach(doc => {
                                const data = doc.data();
                                const storedEmail = data.email || '';
                                if (storedEmail.toLowerCase() === currentUser.email.toLowerCase()) matchingDocs.push(doc);
                            });
                            if (matchingDocs.length > 0) {
                                userDoc = matchingDocs[0];
                                userData = matchingDocs[0].data();
                            }
                        }
                    }
                } catch (error) {
                    console.error('loadCurrentUserPermissions: Error fetching user document:', error.message || error);
                }
                
                if (!userDoc) {
                    console.warn('loadCurrentUserPermissions: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© users ÙÙŠ Firestore (UID Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯). Ø£Ø¶ÙÙ‡ Ù…Ù† Ù‚Ø³Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¥Ù† Ù„Ø²Ù….');
                }
                
                if (userDoc && userData) {
                    
                    const permissionType = userData.permissionType || (userData.warehouses && userData.warehouses.length > 0 ? 'custom' : 'full');
                    
                    // Explicitly check for true values (not undefined, null, or false)
                    // Handle cases where value might be stored as string "true" or boolean true
                    // IMPORTANT: If field doesn't exist (undefined), treat as false (no permission)
                    // Use !== undefined check instead of hasOwnProperty for Firestore compatibility
                    
                    const canManageMaterials = userData.canManageMaterials !== undefined && (userData.canManageMaterials === true || userData.canManageMaterials === 'true');
                    const canManageWarehouses = userData.canManageWarehouses !== undefined && (userData.canManageWarehouses === true || userData.canManageWarehouses === 'true');
                    const canManageWorkSites = userData.canManageWorkSites !== undefined && (userData.canManageWorkSites === true || userData.canManageWorkSites === 'true');
                    const canManageSuppliers = userData.canManageSuppliers !== undefined && (userData.canManageSuppliers === true || userData.canManageSuppliers === 'true');
                    const canManageUnits = userData.canManageUnits !== undefined && (userData.canManageUnits === true || userData.canManageUnits === 'true');
                    
                    const receiveAdd = userData.receiveAdd === true || userData.receiveAdd === 'true';
                    const receiveEdit = userData.receiveEdit === true || userData.receiveEdit === 'true';
                    const receiveDelete = userData.receiveDelete === true || userData.receiveDelete === 'true';
                    const deliverAdd = userData.deliverAdd === true || userData.deliverAdd === 'true';
                    const deliverEdit = userData.deliverEdit === true || userData.deliverEdit === 'true';
                    const deliverDelete = userData.deliverDelete === true || userData.deliverDelete === 'true';
                    const returnAdd = userData.returnAdd === true || userData.returnAdd === 'true';
                    const returnEdit = userData.returnEdit === true || userData.returnEdit === 'true';
                    const returnDelete = userData.returnDelete === true || userData.returnDelete === 'true';
                    
                    window.currentUserPermissions = {
                        warehouses: permissionType === 'full' ? [] : (userData.warehouses || []),
                        workSites: permissionType === 'full' ? [] : (userData.workSites || []),
                        workSiteGroupIds: permissionType === 'full' ? [] : (userData.workSiteGroupIds || []),
                        suppliers: permissionType === 'full' ? [] : (userData.suppliers || []),
                        permissionType: permissionType,
                        isAdmin: currentUser.email === ADMIN_EMAIL,
                        canManageMaterials: canManageMaterials,
                        canManageWarehouses: canManageWarehouses,
                        canManageWorkSites: canManageWorkSites,
                        canManageSuppliers: canManageSuppliers,
                        canManageUnits: canManageUnits,
                        receiveAdd, receiveEdit, receiveDelete,
                        deliverAdd, deliverEdit, deliverDelete,
                        returnAdd, returnEdit, returnDelete
                    };
                    
                } else if (currentUser.email === ADMIN_EMAIL) {
                    // Admin has full access
                    window.currentUserPermissions = {
                        warehouses: [],
                        workSites: [],
                        workSiteGroupIds: [],
                        suppliers: [],
                        permissionType: 'full',
                        isAdmin: true,
                        canManageMaterials: true,
                        canManageWarehouses: true,
                        canManageWorkSites: true,
                        canManageSuppliers: true,
                        canManageUnits: true,
                        receiveAdd: true, receiveEdit: true, receiveDelete: true,
                        deliverAdd: true, deliverEdit: true, deliverDelete: true,
                        returnAdd: true, returnEdit: true, returnDelete: true
                    };
                } else {
                    // No permissions set - default to no access for security (warning already shown when !userDoc)
                    window.currentUserPermissions = {
                        warehouses: [],
                        workSites: [],
                        workSiteGroupIds: [],
                        suppliers: [],
                        permissionType: 'custom',
                        isAdmin: false,
                        canManageMaterials: false,
                        canManageWarehouses: false,
                        canManageWorkSites: false,
                        canManageSuppliers: false,
                        canManageUnits: false,
                        receiveAdd: false, receiveEdit: false, receiveDelete: false,
                        deliverAdd: false, deliverEdit: false, deliverDelete: false,
                        returnAdd: false, returnEdit: false, returnDelete: false
                    };
                    
                    // Show alert to user that they need to be added to the system
                    // Only show once to avoid spam
                    if (!window.permissionWarningShown) {
                        window.permissionWarningShown = true;
                        setTimeout(() => {
                            if (typeof showAlert === 'function') {
                                showAlert('Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙ„Ø§Ø­ÙŠØ§ØªÙƒ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ± Ù„Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨Ùƒ.', 'error');
                            }
                        }, 1000);
                    }
                }
            } catch (error) {
                console.error('Error loading user permissions:', error);
                console.error('Error details:', {
                    message: error.message,
                    code: error.code,
                    stack: error.stack
                });
                
                // Default to no access on error
                window.currentUserPermissions = {
                    warehouses: [],
                    workSites: [],
                    workSiteGroupIds: [],
                    suppliers: [],
                    permissionType: 'custom',
                    isAdmin: false,
                    canManageMaterials: false,
                    canManageWarehouses: false,
                    canManageWorkSites: false,
                    canManageSuppliers: false,
                    canManageUnits: false,
                    receiveAdd: false, receiveEdit: false, receiveDelete: false,
                    deliverAdd: false, deliverEdit: false, deliverDelete: false,
                    returnAdd: false, returnEdit: false, returnDelete: false
                };
                
                // Default permissions set due to error (no console spam)
            }
        }
        
        // Helper functions to filter data based on permissions
        // These functions ensure permissions are loaded before use
        window.getFilteredWarehouses = async function() {
            // Ensure permissions are loaded
            if (!window.currentUserPermissions) {
                console.warn('getFilteredWarehouses: Permissions not loaded, loading now...');
                await loadCurrentUserPermissions();
            }
            
            if (!window.currentUserPermissions) {
                console.error('getFilteredWarehouses: Failed to load permissions');
                return window.warehouses || [];
            }
            
            if (window.currentUserPermissions.isAdmin || window.currentUserPermissions.permissionType === 'full') {
                return window.warehouses || [];
            }
            const allowedIds = window.currentUserPermissions.warehouses || [];
            return (window.warehouses || []).filter(wh => allowedIds.includes(wh.id));
        };
        
        // Synchronous version for immediate use (assumes permissions are already loaded)
        window.getFilteredWarehousesSync = function() {
            if (!window.currentUserPermissions) {
                console.warn('getFilteredWarehousesSync: Permissions not loaded, returning all warehouses');
                return window.warehouses || [];
            }
            if (window.currentUserPermissions.isAdmin || window.currentUserPermissions.permissionType === 'full') {
                return window.warehouses || [];
            }
            const allowedIds = window.currentUserPermissions.warehouses || [];
            return (window.warehouses || []).filter(wh => allowedIds.includes(wh.id));
        };
        
        window.getFilteredWorkSites = async function() {
            // Ensure permissions are loaded
            if (!window.currentUserPermissions) {
                console.warn('getFilteredWorkSites: Permissions not loaded, loading now...');
                await loadCurrentUserPermissions();
            }
            
            if (!window.currentUserPermissions) {
                console.error('getFilteredWorkSites: Failed to load permissions');
                return window.workSites || [];
            }
            
            if (window.currentUserPermissions.isAdmin || window.currentUserPermissions.permissionType === 'full') {
                return window.workSites || [];
            }
            return (window.workSites || []).filter(ws => window.hasWorkSiteAccess(ws.id));
        };
        
        // Synchronous version for immediate use
        window.getFilteredWorkSitesSync = function() {
            if (!window.currentUserPermissions) {
                console.warn('getFilteredWorkSitesSync: Permissions not loaded, returning all work sites');
                return window.workSites || [];
            }
            if (window.currentUserPermissions.isAdmin || window.currentUserPermissions.permissionType === 'full') {
                return window.workSites || [];
            }
            return (window.workSites || []).filter(ws => window.hasWorkSiteAccess(ws.id));
        };
        
        window.hasWarehouseAccess = function(warehouseId) {
            if (!window.currentUserPermissions) {
                console.warn('hasWarehouseAccess: Permissions not loaded');
                return false;
            }
            if (window.currentUserPermissions.isAdmin || window.currentUserPermissions.permissionType === 'full') {
                return true;
            }
            return (window.currentUserPermissions.warehouses || []).includes(warehouseId);
        };
        
        window.hasWorkSiteAccess = function(workSiteId) {
            if (!window.currentUserPermissions) {
                console.warn('hasWorkSiteAccess: Permissions not loaded');
                return false;
            }
            if (window.currentUserPermissions.isAdmin || window.currentUserPermissions.permissionType === 'full') {
                return true;
            }
            if ((window.currentUserPermissions.workSites || []).includes(workSiteId)) return true;
            const workSite = (window.workSites || []).find(ws => ws.id === workSiteId);
            const groupIds = window.currentUserPermissions.workSiteGroupIds || [];
            return workSite && workSite.groupId && groupIds.includes(workSite.groupId);
        };
        
        window.getFilteredSuppliers = async function() {
            // Ensure permissions are loaded
            if (!window.currentUserPermissions) {
                console.warn('getFilteredSuppliers: Permissions not loaded, loading now...');
                await loadCurrentUserPermissions();
            }
            
            if (!window.currentUserPermissions) {
                console.error('getFilteredSuppliers: Failed to load permissions');
                return window.suppliers || [];
            }
            
            if (window.currentUserPermissions.isAdmin || window.currentUserPermissions.permissionType === 'full') {
                return window.suppliers || [];
            }
            const allowedIds = window.currentUserPermissions.suppliers || [];
            return (window.suppliers || []).filter(sup => allowedIds.includes(sup.id));
        };
        
        // Synchronous version for immediate use
        window.getFilteredSuppliersSync = function() {
            if (!window.currentUserPermissions) {
                console.warn('getFilteredSuppliersSync: Permissions not loaded, returning all suppliers');
                return window.suppliers || [];
            }
            if (window.currentUserPermissions.isAdmin || window.currentUserPermissions.permissionType === 'full') {
                return window.suppliers || [];
            }
            const allowedIds = window.currentUserPermissions.suppliers || [];
            return (window.suppliers || []).filter(sup => allowedIds.includes(sup.id));
        };
        
        window.hasSupplierAccess = function(supplierId) {
            if (!window.currentUserPermissions) {
                console.warn('hasSupplierAccess: Permissions not loaded');
                return false;
            }
            if (window.currentUserPermissions.isAdmin || window.currentUserPermissions.permissionType === 'full') {
                return true;
            }
            return (window.currentUserPermissions.suppliers || []).includes(supplierId);
        };
        
        window.generateReport = async function() {
            try {
                const { collection, getDocs, query, where, orderBy, Timestamp } = window.firebaseCollections;
                const db = window.firebaseDb;

                const reportType = document.getElementById('reportType').value;
                const reportWarehouse = document.getElementById('reportWarehouse').value;
                const fromDate = document.getElementById('reportFromDate').value;
                const toDate = document.getElementById('reportToDate').value;

                let q = query(collection(db, 'transactions'), orderBy('createdAt', 'desc'));

                if (reportType !== 'all') {
                    q = query(collection(db, 'transactions'), where('type', '==', reportType), orderBy('createdAt', 'desc'));
                }

                const snapshot = await getDocs(q);
                const resultsDiv = document.getElementById('reportResults');
                resultsDiv.innerHTML = '<h3>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h3>';

                const transactions = [];
                snapshot.forEach((docSnapshot) => {
                    const data = docSnapshot.data();
                    transactions.push({ id: docSnapshot.id, ...data });
                });

                // Filter by date and warehouse
                let filtered = transactions.filter(t => {
                    if (fromDate && t.date) {
                        const transDate = t.date.toDate();
                        const from = new Date(fromDate);
                        if (transDate < from) return false;
                    }
                    if (toDate && t.date) {
                        const transDate = t.date.toDate();
                        const to = new Date(toDate);
                        to.setHours(23, 59, 59);
                        if (transDate > to) return false;
                    }
                    if (reportWarehouse && t.warehouseId !== reportWarehouse) return false;
                    return true;
                });

                if (filtered.length === 0) {
                    resultsDiv.innerHTML += '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>';
                    return;
                }

                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ù†ÙˆØ¹</th>
                            <th>Ø§Ù„Ø±Ù‚Ù…</th>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</th>
                            <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                            <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯</th>
                            <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;

                filtered.forEach(trans => {
                    const typeLabels = {
                        'receive': 'Ø§Ø³ØªÙ„Ø§Ù…',
                        'deliver': 'ØªØ³Ù„ÙŠÙ…',
                        'return': 'Ø§Ø³ØªØ±Ø¯Ø§Ø¯'
                    };

                    const warehouseName = trans.warehouseId 
                        ? window.warehouses.find(w => w.id === trans.warehouseId)?.name || '-'
                        : '-';
                    const workSiteName = trans.workSiteId 
                        ? window.workSites.find(w => w.id === trans.workSiteId)?.name || '-'
                        : '-';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${typeLabels[trans.type] || trans.type}</td>
                        <td>${trans.number || '-'}</td>
                        <td>${window.formatDate(trans.date)}</td>
                        <td>${warehouseName}</td>
                        <td>${workSiteName}</td>
                        <td>${trans.items?.length || 0}</td>
                        <td>${trans.notes || '-'}</td>
                    `;
                    table.querySelector('tbody').appendChild(row);
                });

                resultsDiv.appendChild(table);
            } catch (error) {
                console.error('Error generating report:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±', 'error');
            }
        };

        // ========== VALIDATION HELPERS ==========
        
        // Check if entity is used in transactions
        async function isEntityUsedInTransactions(entityType, entityId) {
            try {
                const { collection, getDocs, query, where } = window.firebaseCollections;
                const db = window.firebaseDb;
                const transactionsRef = collection(db, 'transactions');
                
                if (entityType === 'material') {
                    // Check if material is used in any transaction items
                    const snapshot = await getDocs(transactionsRef);
                    for (const doc of snapshot.docs) {
                        const data = doc.data();
                        if (data.items && Array.isArray(data.items)) {
                            const found = data.items.find(item => item.materialId === entityId);
                            if (found) return true;
                        }
                    }
                    return false;
                } else if (entityType === 'warehouse') {
                    // Check if warehouse is used in any transaction
                    const q = query(transactionsRef, where('warehouseId', '==', entityId));
                    const snapshot = await getDocs(q);
                    return !snapshot.empty;
                } else if (entityType === 'workSite') {
                    // Check if workSite is used in deliver or return transactions
                    const q = query(transactionsRef, where('workSiteId', '==', entityId));
                    const snapshot = await getDocs(q);
                    return !snapshot.empty;
                } else if (entityType === 'supplier') {
                    // Check if supplier is used in receive transactions
                    const q = query(transactionsRef, where('supplierId', '==', entityId));
                    const snapshot = await getDocs(q);
                    return !snapshot.empty;
                } else if (entityType === 'unit') {
                    // Check if unit is used in any material as unit or subUnit
                    if (!window.materials) return false;
                    const found = window.materials.find(m => m.unit === entityId || m.subUnit === entityId);
                    return !!found;
                }
                return false;
            } catch (error) {
                console.error('Error checking entity usage:', error);
                return false;
            }
        }
        
        // Check if material is used in transactions (for conversion editing)
        async function isMaterialUsedInTransactions(materialId) {
            try {
                const { collection, getDocs } = window.firebaseCollections;
                const db = window.firebaseDb;
                const transactionsRef = collection(db, 'transactions');
                const snapshot = await getDocs(transactionsRef);
                
                for (const doc of snapshot.docs) {
                    const data = doc.data();
                    if (data.items && Array.isArray(data.items)) {
                        const found = data.items.find(item => item.materialId === materialId);
                        if (found) return true;
                    }
                }
                return false;
            } catch (error) {
                console.error('Error checking material usage:', error);
                return false;
            }
        }
        
        // ========== ACTIVITY LOG SYSTEM ==========
        
        // Function to log user activities
        async function logActivity(action, entityType, entityId, entityName, changes = null, oldData = null) {
            try {
                const auth = window.firebaseAuth;
                const currentUser = auth.currentUser;
                if (!currentUser) return;
                
                const { addDoc, collection, Timestamp } = window.firebaseCollections;
                const db = window.firebaseDb;
                
                // Get user name from users list
                let userName = currentUser.email;
                if (window.users) {
                    const user = window.users.find(u => u.email === currentUser.email);
                    if (user && user.name) {
                        userName = user.name;
                    }
                }
                
                // Prepare changes description
                let changesDescription = '';
                if (action === 'update' && oldData && changes) {
                    const changeList = [];
                    for (const key in changes) {
                        if (oldData[key] !== changes[key]) {
                            changeList.push(`${key}: "${oldData[key]}" â†’ "${changes[key]}"`);
                        }
                    }
                    changesDescription = changeList.join(' | ');
                } else if (action === 'create') {
                    changesDescription = 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³Ø¬Ù„';
                } else if (action === 'delete') {
                    changesDescription = 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„';
                }
                
                const activityData = {
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    userName: userName,
                    action: action, // 'create', 'update', 'delete'
                    entityType: entityType, // 'material', 'warehouse', 'workSite', 'supplier', 'unit', 'user'
                    entityId: entityId,
                    entityName: entityName,
                    changes: changesDescription,
                    timestamp: Timestamp.now(),
                    createdAt: serverTimestamp()
                };
                
                await addDoc(collection(db, 'activityLog'), activityData);
            } catch (error) {
                console.error('Error logging activity:', error);
                // Don't show alert to user, just log to console
            }
        }
        
        // Load and display activity log
        async function loadActivityLog() {
            try {
                const { collection, getDocs, query, orderBy } = window.firebaseCollections;
                const db = window.firebaseDb;
                
                const tbody = document.getElementById('activityLogTableBody');
                if (!tbody) return;
                
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #999;">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª...</td></tr>';
                
                // Get filters
                const actionFilter = document.getElementById('activityLogFilter')?.value || 'all';
                const entityFilter = document.getElementById('activityLogEntityFilter')?.value || 'all';
                
                // Query activity log
                let q = query(collection(db, 'activityLog'), orderBy('timestamp', 'desc'));
                const snapshot = await getDocs(q);
                
                const activities = [];
                snapshot.forEach((docSnapshot) => {
                    const data = docSnapshot.data();
                    
                    // Apply filters
                    if (actionFilter !== 'all' && data.action !== actionFilter) return;
                    if (entityFilter !== 'all' && data.entityType !== entityFilter) return;
                    
                    activities.push({
                        id: docSnapshot.id,
                        ...data
                    });
                });
                
                tbody.innerHTML = '';
                
                if (activities.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø³Ø¬Ù„Ø©</td></tr>';
                    return;
                }
                
                activities.forEach(activity => {
                    const row = document.createElement('tr');
                    
                    // Format date
                    const date = activity.timestamp?.toDate ? activity.timestamp.toDate() : new Date(activity.timestamp);
                    const dateStr = window.formatDateTime(activity.timestamp);
                    
                    // Action label
                    const actionLabels = {
                        'create': '<span style="color: #27ae60; font-weight: bold;">Ø¥Ø¶Ø§ÙØ©</span>',
                        'update': '<span style="color: #3498db; font-weight: bold;">ØªØ¹Ø¯ÙŠÙ„</span>',
                        'delete': '<span style="color: #e74c3c; font-weight: bold;">Ø­Ø°Ù</span>'
                    };
                    
                    // Entity type label
                    const entityLabels = {
                        'material': 'Ù…Ø§Ø¯Ø©',
                        'warehouse': 'Ù…Ø³ØªÙˆØ¯Ø¹',
                        'workSite': 'Ù…ÙˆÙ‚Ø¹ Ø¹Ù…Ù„',
                        'supplier': 'Ù…Ø²ÙˆØ¯',
                        'unit': 'ÙˆØ­Ø¯Ø©',
                        'user': 'Ù…Ø³ØªØ®Ø¯Ù…'
                    };
                    
                    row.innerHTML = `
                        <td>${dateStr}</td>
                        <td>${activity.userName || activity.userEmail}</td>
                        <td>${actionLabels[activity.action] || activity.action}</td>
                        <td>${entityLabels[activity.entityType] || activity.entityType}</td>
                        <td>${activity.entityName || '-'}</td>
                        <td style="max-width: 300px; word-wrap: break-word; font-size: 12px;">${activity.changes || '-'}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading activity log:', error);
                const tbody = document.getElementById('activityLogTableBody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #e74c3c;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</td></tr>';
                }
            }
        }
        
        // Set today's date in date inputs and apply language on page load
        window.addEventListener('DOMContentLoaded', function() {
            // Apply saved language preference on page load
            applyLanguage();
            updateLangToggleButton();
            
            const today = new Date().toISOString().split('T')[0];
            ['receiveDate', 'deliverDate', 'returnDate'].forEach(id => {
                const input = document.getElementById(id);
                if (input) input.value = today;
            });
        });

    </script>

</body>
</html>

